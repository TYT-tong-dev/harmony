<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{{ table_number }}å·æ¡Œ - æ‰«ç ç‚¹é¤</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding-bottom: 140px;
        }
        /* é¡¶éƒ¨ */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header h1 { font-size: 20px; font-weight: 600; }
        .header .table-info { font-size: 14px; opacity: 0.9; margin-top: 4px; }
        
        /* åˆ†ç±»æ ‡ç­¾ */
        .categories {
            display: flex;
            overflow-x: auto;
            background: white;
            padding: 12px 16px;
            gap: 10px;
            border-bottom: 1px solid #eee;
            -webkit-overflow-scrolling: touch;
        }
        .categories::-webkit-scrollbar { display: none; }
        .category-tag {
            flex-shrink: 0;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            background: #f0f0f0;
            color: #666;
            border: none;
            cursor: pointer;
        }
        .category-tag.active { background: #667eea; color: white; }
        
        /* èœå“åˆ—è¡¨ */
        .dish-list { padding: 12px; }
        .dish-card {
            background: white;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            display: flex;
            gap: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .dish-img {
            width: 90px;
            height: 90px;
            border-radius: 8px;
            object-fit: cover;
            background: #f0f0f0;
        }
        .dish-info { flex: 1; display: flex; flex-direction: column; }
        .dish-name { font-size: 16px; font-weight: 600; color: #333; }
        .dish-desc { font-size: 12px; color: #999; margin-top: 4px; flex: 1; }
        .dish-bottom { display: flex; align-items: center; justify-content: space-between; }
        .dish-price { color: #e74c3c; font-size: 18px; font-weight: 600; }
        .dish-price::before { content: 'Â¥'; font-size: 12px; }
        
        /* æ•°é‡æ§åˆ¶ */
        .quantity-ctrl {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .qty-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .qty-btn.minus { background: #f0f0f0; color: #666; }
        .qty-btn.plus { background: #667eea; color: white; }
        .qty-num { font-size: 16px; font-weight: 600; min-width: 20px; text-align: center; }
        
        /* è´­ç‰©è½¦æ  */
        .cart-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 12px 16px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 16px;
            z-index: 100;
        }
        .cart-icon {
            position: relative;
            width: 50px;
            height: 50px;
            background: #667eea;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        .cart-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #e74c3c;
            color: white;
            font-size: 12px;
            min-width: 20px;
            height: 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .cart-info { flex: 1; }
        .cart-total { font-size: 20px; font-weight: 700; color: #e74c3c; }
        .cart-total::before { content: 'Â¥'; font-size: 14px; }
        .cart-hint { font-size: 12px; color: #999; }
        .checkout-btn {
            padding: 14px 28px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        .checkout-btn:disabled { background: #ccc; }
        
        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        .empty-state .icon { font-size: 60px; margin-bottom: 16px; }
        
        /* åŠ è½½çŠ¶æ€ */
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ½ï¸ æ‰«ç ç‚¹é¤</h1>
        <div class="table-info">{{ table_number }}å·æ¡Œ Â· æ¬¢è¿å…‰ä¸´</div>
    </div>

    <!-- åˆ†ç±»æ ‡ç­¾ -->
    <div class="categories" id="categories">
        <button class="category-tag active" data-category="all">å…¨éƒ¨</button>
    </div>

    <!-- èœå“åˆ—è¡¨ -->
    <div class="dish-list" id="dishList">
        <div class="loading">åŠ è½½ä¸­...</div>
    </div>

    <!-- è´­ç‰©è½¦æ  -->
    <div class="cart-bar">
        <div class="cart-icon">
            ğŸ›’
            <span class="cart-badge" id="cartBadge">0</span>
        </div>
        <div class="cart-info">
            <div class="cart-total" id="cartTotal">0</div>
            <div class="cart-hint">å·²é€‰ <span id="cartCount">0</span> ä»¶</div>
        </div>
        <button class="checkout-btn" id="checkoutBtn" disabled onclick="checkout()">å»ç»“ç®—</button>
    </div>

    <script>
        const API_BASE = '{{ api_base }}';
        const TABLE_NUMBER = '{{ table_number }}';
        let dishes = [];
        let cart = {}; // { dishId: quantity }
        let categories = ['å…¨éƒ¨'];
        let currentCategory = 'all';

        // åŠ è½½èœå“
        async function loadDishes() {
            try {
                const res = await fetch(API_BASE + '/dishes');
                const data = await res.json();
                if (data.code === 200 && data.data) {
                    dishes = data.data.dishes || data.data || [];
                    // æå–åˆ†ç±»
                    const cats = new Set();
                    dishes.forEach(d => d.category && cats.add(d.category));
                    categories = ['å…¨éƒ¨', ...Array.from(cats)];
                    renderCategories();
                    renderDishes();
                }
            } catch (e) {
                document.getElementById('dishList').innerHTML =
                    '<div class="empty-state"><div class="icon">ğŸ˜•</div><p>åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</p></div>';
            }
        }

        // æ¸²æŸ“åˆ†ç±»
        function renderCategories() {
            const container = document.getElementById('categories');
            container.innerHTML = categories.map((cat, i) =>
                `<button class="category-tag ${i === 0 ? 'active' : ''}"
                    data-category="${i === 0 ? 'all' : cat}"
                    onclick="selectCategory(this, '${i === 0 ? 'all' : cat}')">${cat}</button>`
            ).join('');
        }

        // é€‰æ‹©åˆ†ç±»
        function selectCategory(el, cat) {
            document.querySelectorAll('.category-tag').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            currentCategory = cat;
            renderDishes();
        }

        // æ¸²æŸ“èœå“
        function renderDishes() {
            const filtered = currentCategory === 'all'
                ? dishes
                : dishes.filter(d => d.category === currentCategory);

            if (filtered.length === 0) {
                document.getElementById('dishList').innerHTML =
                    '<div class="empty-state"><div class="icon">ğŸ½ï¸</div><p>æš‚æ— èœå“</p></div>';
                return;
            }

            document.getElementById('dishList').innerHTML = filtered.map(dish => `
                <div class="dish-card">
                    <img class="dish-img" src="${dish.image_url || dish.imageUrl || 'https://via.placeholder.com/90?text=èœå“'}"
                        onerror="this.src='https://via.placeholder.com/90?text=èœå“'" alt="${dish.name}">
                    <div class="dish-info">
                        <div class="dish-name">${dish.name}</div>
                        <div class="dish-desc">${dish.description || ''}</div>
                        <div class="dish-bottom">
                            <span class="dish-price">${dish.price}</span>
                            <div class="quantity-ctrl">
                                ${cart[dish.id] ? `
                                    <button class="qty-btn minus" onclick="updateCart(${dish.id}, -1)">âˆ’</button>
                                    <span class="qty-num">${cart[dish.id]}</span>
                                ` : ''}
                                <button class="qty-btn plus" onclick="updateCart(${dish.id}, 1)">+</button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // æ›´æ–°è´­ç‰©è½¦
        function updateCart(dishId, delta) {
            cart[dishId] = (cart[dishId] || 0) + delta;
            if (cart[dishId] <= 0) delete cart[dishId];
            renderDishes();
            updateCartBar();
        }

        // æ›´æ–°è´­ç‰©è½¦æ 
        function updateCartBar() {
            let total = 0, count = 0;
            Object.keys(cart).forEach(id => {
                const dish = dishes.find(d => d.id == id);
                if (dish) {
                    total += dish.price * cart[id];
                    count += cart[id];
                }
            });
            document.getElementById('cartTotal').textContent = total.toFixed(2);
            document.getElementById('cartCount').textContent = count;
            document.getElementById('cartBadge').textContent = count;
            document.getElementById('checkoutBtn').disabled = count === 0;
        }

        // ç»“ç®—
        async function checkout() {
            if (Object.keys(cart).length === 0) return alert('è¯·å…ˆé€‰æ‹©èœå“');

            const items = Object.keys(cart).map(id => ({
                dish_id: parseInt(id),
                quantity: cart[id]
            }));

            try {
                const res = await fetch(API_BASE + '/orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        table_number: TABLE_NUMBER,
                        items: items,
                        source: 'h5'
                    })
                });
                const data = await res.json();
                if (data.code === 200) {
                    alert('ä¸‹å•æˆåŠŸï¼è¯·ç­‰å¾…ä¸Šèœ');
                    cart = {};
                    renderDishes();
                    updateCartBar();
                } else {
                    alert('ä¸‹å•å¤±è´¥: ' + (data.message || 'è¯·é‡è¯•'));
                }
            } catch (e) {
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }

        // åˆå§‹åŒ–
        loadDishes();
    </script>
</body>
</html>

