// NotificationUtils.ets - é¸¿è’™é€šçŸ¥å·¥å…·ç±»
import notificationManager from '@ohos.notificationManager';
import { BusinessError } from '@ohos.base';
import wantAgent, { WantAgent } from '@ohos.app.ability.wantAgent';
import vibrator from '@ohos.vibrator';
import { Want } from '@kit.AbilityKit';
import { NotificationType } from './Types';

// é€šçŸ¥é¢å¤–æ•°æ®
export class NotificationExtraData {
  conversationId: string = '';
  orderId: string = '';
  tableId: string = '';
  senderId: string = '';

  constructor(data?: Partial<NotificationExtraData>) {
    if (data) {
      if (data.conversationId !== undefined) this.conversationId = data.conversationId;
      if (data.orderId !== undefined) this.orderId = data.orderId;
      if (data.tableId !== undefined) this.tableId = data.tableId;
      if (data.senderId !== undefined) this.senderId = data.senderId;
    }
  }
}

// é€šçŸ¥é…ç½®
export class NotificationConfig {
  enableVibrate: boolean = true;   // æ˜¯å¦éœ‡åŠ¨
  enableSound: boolean = true;     // æ˜¯å¦å“é“ƒï¼ˆç³»ç»Ÿé»˜è®¤ï¼‰
}

// é€šçŸ¥æ•°æ®
export class NotificationData {
  id: number = 0;
  type: NotificationType = NotificationType.ORDER;
  title: string = '';
  content: string = '';
  extra: NotificationExtraData | null = null;
  config: NotificationConfig | null = null;

  constructor(id: number, type: NotificationType, title: string, content: string) {
    this.id = id;
    this.type = type;
    this.title = title;
    this.content = content;
  }
}

// éœ‡åŠ¨æ—¶é•¿
const VIBRATE_DURATION_ORDER: number = 500;    // è®¢å•é€šçŸ¥éœ‡åŠ¨500ms
const VIBRATE_DURATION_MESSAGE: number = 200;  // æ¶ˆæ¯é€šçŸ¥éœ‡åŠ¨200ms

// è·å–éœ‡åŠ¨æ—¶é•¿
function getVibrateDuration(type: NotificationType): number {
  if (type === NotificationType.ORDER) {
    return VIBRATE_DURATION_ORDER;
  }
  return VIBRATE_DURATION_MESSAGE;
}

// Want å‚æ•°ç±»
class WantParameters {
  notificationType: string = '';
  notificationId: string = '';
  conversationId: string = '';
  orderId: string = '';
  tableId: string = '';
  senderId: string = '';

  // è½¬æ¢ä¸º Record<string, Object>
  toRecord(): Record<string, Object> {
    const jsonStr = JSON.stringify(this);
    const obj: Record<string, Object> = JSON.parse(jsonStr) as Record<string, Object>;
    return obj;
  }
}

// é€šçŸ¥å·¥å…·ç±»
export class NotificationUtils {
  private static notificationId: number = 1;
  private static defaultConfig: NotificationConfig = new NotificationConfig();

  // è¯·æ±‚é€šçŸ¥æƒé™
  static async requestPermission(): Promise<boolean> {
    try {
      const isEnabled = await notificationManager.isNotificationEnabled();
      if (isEnabled) {
        console.info('[NotificationUtils] é€šçŸ¥æƒé™å·²å¼€å¯');
        return true;
      }
      // å¼•å¯¼ç”¨æˆ·å»è®¾ç½®å¼€å¯é€šçŸ¥
      console.info('[NotificationUtils] éœ€è¦ç”¨æˆ·æ‰‹åŠ¨å¼€å¯é€šçŸ¥æƒé™');
      return false;
    } catch (error) {
      const err = error as BusinessError;
      console.error('[NotificationUtils] æ£€æŸ¥é€šçŸ¥æƒé™å¤±è´¥: ' + err.message);
      return false;
    }
  }

  // è§¦å‘éœ‡åŠ¨
  private static async triggerVibrate(type: NotificationType): Promise<void> {
    try {
      const duration = getVibrateDuration(type);
      const effect: vibrator.VibrateTime = {
        type: 'time',
        duration: duration
      };
      const attr: vibrator.VibrateAttribute = {
        id: 0,
        usage: 'notification'
      };
      await vibrator.startVibration(effect, attr);
      console.info('[NotificationUtils] éœ‡åŠ¨è§¦å‘æˆåŠŸ');
    } catch (error) {
      const err = error as BusinessError;
      console.error('[NotificationUtils] éœ‡åŠ¨è§¦å‘å¤±è´¥: ' + err.message);
    }
  }

  // å‘é€æœ¬åœ°é€šçŸ¥
  static async sendNotification(data: NotificationData): Promise<boolean> {
    try {
      const config = data.config || NotificationUtils.defaultConfig;

      // æ„å»ºè·³è½¬å‚æ•° - ä½¿ç”¨ç±»åŒ…è£…
      const params = new WantParameters();
      params.notificationType = data.type;
      params.notificationId = data.id.toString();
      // åˆå¹¶é¢å¤–å‚æ•°
      if (data.extra) {
        if (data.extra.conversationId) {
          params.conversationId = data.extra.conversationId;
        }
        if (data.extra.orderId) {
          params.orderId = data.extra.orderId;
        }
        if (data.extra.tableId) {
          params.tableId = data.extra.tableId;
        }
        if (data.extra.senderId) {
          params.senderId = data.extra.senderId;
        }
      }

      // åˆ›å»º Want
      const want: Want = {
        bundleName: 'com.example.h',
        abilityName: 'EntryAbility',
        parameters: params.toRecord()
      };

      // åˆ›å»ºç‚¹å‡»é€šçŸ¥åçš„è·³è½¬æ„å›¾
      const wantAgentInfo: wantAgent.WantAgentInfo = {
        wants: [want],
        actionType: wantAgent.OperationType.START_ABILITY,
        requestCode: 0,
        wantAgentFlags: [wantAgent.WantAgentFlags.UPDATE_PRESENT_FLAG]
      };

      const agent: WantAgent = await wantAgent.getWantAgent(wantAgentInfo);

      // æ„å»ºé€šçŸ¥è¯·æ±‚
      const notificationRequest: notificationManager.NotificationRequest = {
        id: NotificationUtils.notificationId++,
        content: {
          notificationContentType: notificationManager.ContentType.NOTIFICATION_CONTENT_BASIC_TEXT,
          normal: {
            title: data.title,
            text: data.content
          }
        },
        wantAgent: agent,
        notificationSlotType: config.enableSound
          ? notificationManager.SlotType.SOCIAL_COMMUNICATION  // å¸¦å£°éŸ³
          : notificationManager.SlotType.CONTENT_INFORMATION   // æ— å£°éŸ³
      };

      await notificationManager.publish(notificationRequest);
      console.info('[NotificationUtils] å‘é€é€šçŸ¥æˆåŠŸ: ' + data.title);

      // è§¦å‘éœ‡åŠ¨
      if (config.enableVibrate) {
        await NotificationUtils.triggerVibrate(data.type);
      }

      return true;
    } catch (error) {
      const err = error as BusinessError;
      console.error('[NotificationUtils] å‘é€é€šçŸ¥å¤±è´¥: ' + err.message);
      return false;
    }
  }

  // å‘é€è®¢å•é€šçŸ¥ï¼ˆå•†å®¶ç«¯ä½¿ç”¨ï¼‰
  static async sendOrderNotification(
    orderId: number,
    tableId: string,
    totalAmount: number,
    itemCount: number
  ): Promise<boolean> {
    const notificationData = new NotificationData(
      orderId,
      NotificationType.ORDER,
      'ğŸ“‹ æ–°è®¢å•æé†’',
      `${tableId}å·æ¡Œä¸‹å•ï¼Œ${itemCount}ä»¶å•†å“ï¼ŒÂ¥${totalAmount.toFixed(2)}`
    );
    const extra = new NotificationExtraData();
    extra.orderId = orderId.toString();
    extra.tableId = tableId;
    notificationData.extra = extra;
    return NotificationUtils.sendNotification(notificationData);
  }

  // å‘é€æ¶ˆæ¯é€šçŸ¥
  static async sendMessageNotification(
    messageId: number,
    senderName: string,
    content: string,
    conversationId: number
  ): Promise<boolean> {
    // æˆªæ–­è¿‡é•¿çš„æ¶ˆæ¯å†…å®¹
    const displayContent = content.length > 50 ? content.substring(0, 50) + '...' : content;
    const notificationData = new NotificationData(
      messageId,
      NotificationType.MESSAGE,
      `ğŸ’¬ ${senderName}`,
      displayContent
    );
    const extra = new NotificationExtraData();
    extra.conversationId = conversationId.toString();
    extra.senderId = messageId.toString();
    notificationData.extra = extra;
    return NotificationUtils.sendNotification(notificationData);
  }

  // å–æ¶ˆé€šçŸ¥
  static async cancelNotification(id: number): Promise<void> {
    try {
      await notificationManager.cancel(id);
      console.info('[NotificationUtils] å–æ¶ˆé€šçŸ¥æˆåŠŸ: ' + id);
    } catch (error) {
      const err = error as BusinessError;
      console.error('[NotificationUtils] å–æ¶ˆé€šçŸ¥å¤±è´¥: ' + err.message);
    }
  }

  // å–æ¶ˆæ‰€æœ‰é€šçŸ¥
  static async cancelAllNotifications(): Promise<void> {
    try {
      await notificationManager.cancelAll();
      console.info('[NotificationUtils] å–æ¶ˆæ‰€æœ‰é€šçŸ¥æˆåŠŸ');
    } catch (error) {
      const err = error as BusinessError;
      console.error('[NotificationUtils] å–æ¶ˆæ‰€æœ‰é€šçŸ¥å¤±è´¥: ' + err.message);
    }
  }
}

