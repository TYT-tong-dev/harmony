// DiscoverPage.ets
import {
  Post,
  NewPostForm,
  PostListResponse,
  LikeResponse,
  ApiResponse,
  CreatePostRequest,
  LikeRequest,
  Comment,
  CommentListResponse,
  CreateCommentRequest,
  CreateCommentResponse,
  FollowRequest,
  FollowResponse,
  Message,
  ConversationListResponseData,
  ConversationItemData,
  SendMessageRequest
} from '../common/Types';
import { ApiUtils, ToastUtils } from '../common/Utils';
import router from '@ohos.router';
import picker from '@ohos.file.picker';
import abilityAccessCtrl from '@ohos.abilityAccessCtrl';
import common from '@ohos.app.ability.common';
import fs from '@ohos.file.fs';

// åˆ†äº«å¥½å‹é¡¹
interface ShareFriend {
  id: number;
  conversationId: number;
  username: string;
  avatar: string;
}

type MediaPermissionName =
  | 'ohos.permission.READ_MEDIA'
  | 'ohos.permission.WRITE_MEDIA'
  | 'ohos.permission.READ_IMAGEVIDEO'
  | 'ohos.permission.WRITE_IMAGEVIDEO'
  | 'ohos.permission.CAMERA';

interface PermissionRequestResult {
  permissions: MediaPermissionName[];
  authResults: number[];
}

interface SelectedMediaPreview {
  path: string;
  type: 'image' | 'video';
  key: string;
  index: number;
}

interface SamplePostData {
  id: number;
  username: string;
  avatar: string;
  content: string;
  images: string[];
  videos: string[];
  likeCount: number;
  commentCount: number;
  createTimeOffsetMinutes: number;
}

interface SamplePreviewCard {
  id: string;
  avatar: Resource;
  nickname: string;
  tag: string;
  content: string;
}

function createEmptyPostForm(): NewPostForm {
  return {
    content: '',
    images: [],
    videos: []
  }as NewPostForm;
}

@Entry
@Component
export struct DiscoverPage {
  @State posts: Post[] = [];
  @State refreshing: boolean = false;
  @State loadingMore: boolean = false;
  @State currentPage: number = 1;
  @State hasMore: boolean = true;
  @State showPostDialog: boolean = false;
  @State newPost: NewPostForm = createEmptyPostForm();
  @State postContent: string = ''; // ç”¨äºè§¦å‘å‘å¸ƒæŒ‰é’®çŠ¶æ€æ›´æ–°
  @State showCommentDialog: boolean = false;
  @State currentPost: Post | null = null;
  @State comments: Comment[] = [];
  @State commentContent: string = '';
  @State mediaProcessing: boolean = false;
  @State activeCategory: string = 'æ¨è';
  @State posting: boolean = false;
  // åˆ†äº«ç›¸å…³çŠ¶æ€
  @State showShareDialog: boolean = false;
  @State sharePost: Post | null = null;
  @State shareFriends: ShareFriend[] = [];
  @State shareLoading: boolean = false;
  private readonly samplePreviewCards: SamplePreviewCard[] = [
    {
      id: 'sample_card_1',
      avatar: $r('app.media.avatar1'),
      nickname: 'é£Ÿå…‰è®°Â·é˜¿ä¹',
      tag: 'äººæ°”æ¨è',
      content: 'å®«ä¿é¸¡ä¸èŠ±ç”Ÿè„†ã€é¸¡è‚‰å«©ï¼Œæ’’ä¸Šä¸€ç‚¹è‘±èŠ±ç¬é—´å‡çº§ä¸‹é¥­ç‹è€…ï½'
    },
    {
      id: 'sample_card_2',
      avatar: $r('app.media.avatar2'),
      nickname: 'ä»Šæ—¥å°å¨',
      tag: 'ä»Šæ—¥æ¢åº—',
      content: 'é…¸èœé±¼ç°åˆ‡è‰é±¼æ­é…è‡ªç‚’é…¸èœï¼Œæ±¤åº•è¶Šå–è¶Šä¸Šç˜¾ï¼Œé…ç±³é¥­ç»äº†ã€‚'
    },
    {
      id: 'sample_card_3',
      avatar: $r('app.media.avatar3'),
      nickname: 'ç”œå’¸å…šä»£è¡¨',
      tag: 'è½»æ¾åˆé¤',
      content: 'æ–°å“èƒ¡èåœç‚–ç‰›è…©ï¼Œæ±¤æ±æµ“éƒä¸å¡å˜´ï¼Œå†æ¥ä¸€æ¯å†°ç¾å¼åˆšåˆšå¥½ã€‚'
    }
  ];

  private readonly discoverCategories: string[] = ['æ¨è', 'é™„è¿‘', 'å…³æ³¨'];
  private readonly maxMediaCount: number = 6;
  private mediaPermissionsGranted: boolean = false;
  private context?: common.UIAbilityContext;
  private atManager?: abilityAccessCtrl.AtManager;
  private readonly mediaPermissions: MediaPermissionName[] = [
    'ohos.permission.READ_MEDIA',
    'ohos.permission.WRITE_MEDIA',
    'ohos.permission.READ_IMAGEVIDEO',
    'ohos.permission.WRITE_IMAGEVIDEO',
    'ohos.permission.CAMERA'
  ];

  aboutToAppear(): void {
    const token: string = AppStorage.get<string>('userToken') || '';
    try {
      this.context = getContext(this) as common.UIAbilityContext;
      this.atManager = abilityAccessCtrl.createAtManager();
    } catch (error) {
      console.error('åˆå§‹åŒ–ä¸Šä¸‹æ–‡å¤±è´¥:' + JSON.stringify(error));
    }
    if (!token) {
      ToastUtils.showToast('è¯·å…ˆç™»å½•');
      router.replaceUrl({ url: 'pages/LoginPage' });
      return;
    }
    this.loadPosts(true);
    this.ensurePostFormInitialized();
  }

  onPageShow(): void {
    // é¡µé¢æ˜¾ç¤ºæ—¶åˆ·æ–°å¸–å­åˆ—è¡¨ï¼Œç¡®ä¿ä¸æˆ‘çš„é¡µé¢æ•°æ®åŒæ­¥
    const token: string = AppStorage.get<string>('userToken') || '';
    if (token) {
      this.loadPosts(true);
    }
  }

  @Builder
  DiscoverHeader() {
    Column() {
      // é¡¶éƒ¨æ¸å˜èƒŒæ™¯åŒºåŸŸ
      Stack({ alignContent: Alignment.BottomStart }) {
        Column()
          .width('100%')
          .height(200)
          .linearGradient({
            angle: 135,
            colors: [
              ['#667eea', 0],
              ['#764ba2', 1]
            ]
          })

        Column() {
          // æ ‡é¢˜å’Œå‘å¸ƒæŒ‰é’®
          Row() {
            Column({ space: 4 }) {
              Text('å‘ç°ç¾é£Ÿ')
                .fontSize(26)
                .fontWeight(FontWeight.Bold)
                .fontColor('#FFFFFF')
              Text('åˆ†äº«ä½ çš„å‘³è•¾æ•…äº‹')
                .fontSize(13)
                .fontColor('rgba(255,255,255,0.85)')
            }
            .alignItems(HorizontalAlign.Start)
            .layoutWeight(1)

            Button({ type: ButtonType.Normal, stateEffect: true }) {
              Row({ space: 6 }) {
                Text('+')
                  .fontSize(18)
                  .fontColor('#FFFFFF')
                  .fontWeight(FontWeight.Bold)
                Text('å‘å¸ƒ')
                  .fontSize(15)
                  .fontColor('#FFFFFF')
                  .fontWeight(FontWeight.Medium)
              }
            }
            .height(40)
            .padding({ left: 16, right: 18 })
            .backgroundColor('#FF6B6B')
            .borderRadius(20)
            .shadow({
              radius: 12,
              color: 'rgba(255,107,107,0.4)',
              offsetX: 0,
              offsetY: 4
            })
            .onClick(() => {
              try {
              console.info('é¡¶éƒ¨å‘å¸ƒæŒ‰é’®è¢«ç‚¹å‡»');
              this.ensurePostFormInitialized();
              this.showPostDialog = true;
              } catch (error) {
                console.error('æ‰“å¼€å‘å¸ƒå¯¹è¯æ¡†å¤±è´¥: ' + JSON.stringify(error));
                ToastUtils.showToast('æ‰“å¼€å‘å¸ƒå¯¹è¯æ¡†å¤±è´¥ï¼Œè¯·é‡è¯•');
              }
            })
          }
          .width('100%')
          .alignItems(VerticalAlign.Center)

          // ç»Ÿè®¡ä¿¡æ¯å¡ç‰‡ - ä½¿ç”¨æ·±è‰²å¡ç‰‡ç¡®ä¿æ–‡å­—å¯è§
          Row({ space: 10 }) {
            // åŠ¨æ€æ•°
            Column({ space: 4 }) {
              Text(`${this.posts.length}`)
                .fontSize(20)
                .fontWeight(FontWeight.Bold)
                .fontColor('#FFFFFF')
              Text('åŠ¨æ€')
                .fontSize(11)
                .fontColor('rgba(255,255,255,0.8)')
            }
            .layoutWeight(1)
            .alignItems(HorizontalAlign.Center)
            .padding({ top: 12, bottom: 12 })
            .backgroundColor('rgba(255,255,255,0.2)')
            .borderRadius(12)

            // å½“å‰é¢‘é“
            Column({ space: 4 }) {
              Text(this.activeCategory)
                .fontSize(14)
                .fontWeight(FontWeight.Bold)
                .fontColor('#FFFFFF')
              Text('é¢‘é“')
                .fontSize(11)
                .fontColor('rgba(255,255,255,0.8)')
            }
            .layoutWeight(1)
            .alignItems(HorizontalAlign.Center)
            .padding({ top: 12, bottom: 12 })
            .backgroundColor('rgba(255,255,255,0.2)')
            .borderRadius(12)

            // çŠ¶æ€
            Column({ space: 4 }) {
              Row({ space: 4 }) {
                if (this.refreshing) {
                  LoadingProgress()
                    .width(12)
                    .height(12)
                    .color('#FFFFFF')
                } else {
                  Column()
                    .width(8)
                    .height(8)
                    .borderRadius(4)
                    .backgroundColor('#4ADE80')
                }
                Text(this.refreshing ? 'åˆ·æ–°' : 'åœ¨çº¿')
                  .fontSize(13)
                  .fontColor('#FFFFFF')
              }
              Text('çŠ¶æ€')
                .fontSize(11)
                .fontColor('rgba(255,255,255,0.8)')
            }
            .layoutWeight(1)
            .alignItems(HorizontalAlign.Center)
            .padding({ top: 12, bottom: 12 })
            .backgroundColor('rgba(255,255,255,0.2)')
            .borderRadius(12)
          }
          .margin({ top: 16 })
        }
        .width('100%')
        .padding({ left: 20, right: 20, top: 20, bottom: 24 })
      }
    }
  }

  @Builder
  CategoryChips() {
    List({ space: 10 }) {
      ForEach(this.discoverCategories, (category: string) => {
        ListItem() {
          Column() {
            Text(category)
              .fontSize(14)
              .fontWeight(this.activeCategory === category ? FontWeight.Bold : FontWeight.Normal)
              .fontColor(this.activeCategory === category ? '#FFFFFF' : '#666666')
          }
          .padding({ left: 18, right: 18, top: 10, bottom: 10 })
          .backgroundColor(this.activeCategory === category ? '#007DFF' : '#FFFFFF')
          .borderRadius(20)
          .shadow(this.activeCategory === category ? {
            radius: 8,
            color: '#30007DFF',
            offsetX: 0,
            offsetY: 4
          } : {
            radius: 4,
            color: '#10000000',
            offsetX: 0,
            offsetY: 2
          })
          .onClick(() => {
            if (this.activeCategory !== category) {
              this.activeCategory = category;
              this.loadPosts(true);
            }
          })
        }
      }, (category: string) => category)
    }
    .listDirection(Axis.Horizontal)
    .scrollBar(BarState.Off)
    .edgeEffect(EdgeEffect.Spring)
    .padding({ left: 16, right: 16, top: 12, bottom: 12 })
    .backgroundColor('#F8F8F8')
  }

  @Builder
  SampleGuideCard() {
    Column() {
      this.SectionHeader('çµæ„ŸæŒ‡å—', 'ä»å¤´åƒã€æ˜µç§°ã€å†…å®¹æ’ç‰ˆå…¥æ‰‹æ‰“é€ ç»Ÿä¸€è§†è§‰')

      Row() {
        Column() {
          Text('æ¯æ¡ç¤ºä¾‹éƒ½åŒ…å«å¤´åƒã€æ˜µç§°ä¸è¯¦ç»†å†…å®¹ï¼Œä¾¿äºå¿«é€Ÿå‚è€ƒã€‚')
            .fontSize(13)
            .fontColor('#666')
            .margin({ top: 4 })
        }
        .layoutWeight(1)

        Button('åˆ·æ–°ç¤ºä¾‹', { type: ButtonType.Normal })
          .fontColor('#007DFF')
          .backgroundColor(Color.Transparent)
          .borderColor(Color.Transparent)
          .onClick(() => {
            this.posts = this.createLocalSamplePosts();
            this.hasMore = false;
            this.currentPage = 1;
          })
      }

      Text('ä¸Šæ»‘æµè§ˆæ›´å¤šåŠ¨æ€ï¼Œæˆ–ç‚¹å‡»å³ä¸Šè§’â€œå‘å¸ƒâ€ä¸Šä¼ æ–°çš„å›¾æ–‡/è§†é¢‘ã€‚')
        .fontSize(12)
        .fontColor('#999')
        .margin({ top: 8 })
    }
    .width('100%')
    .padding({ left: 20, right: 20, top: 12, bottom: 12 })
  }

  @Builder
  SectionHeader(title: string, subtitle: string) {
    Column({ space: 4 }) {
      Text(title)
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor('#1F1F1F')
      Text(subtitle)
        .fontSize(13)
        .fontColor('#7A7A7A')
    }
    .width('100%')
  }

  @Builder
  SamplePreviewSection() {
    Column() {
      this.SectionHeader('ç¤ºä¾‹å¸–å­æ’ç‰ˆ', 'å¤´åƒ + æ˜µç§° + æ–‡æ¡ˆçš„å®Œæ•´ç»„åˆç¤ºä¾‹')

      Scroll() {
        Row() {
          ForEach(this.samplePreviewCards, (card: SamplePreviewCard) => {
            this.SamplePreviewCard(card)
          }, (card: SamplePreviewCard) => card.id)
        }
        .padding({ left: 20, right: 20 })
      }
      .scrollable(ScrollDirection.Horizontal)
      .scrollBar(BarState.Off)
      .padding({ top: 12 })
    }
    .width('100%')
    .padding({ bottom: 8 })
  }

  @Builder
  SamplePostShowcase(samples: Post[]) {
    Column({ space: 12 }) {
      this.SectionHeader('ç¤ºä¾‹å¸–å­å±•ç¤º', 'å¤´åƒã€æ˜µç§°ä¸å†…å®¹æŒ‰çºµå‘å¡ç‰‡æ’å¸ƒ')
      Column({ space: 12 }) {
        ForEach(samples, (post: Post) => {
          this.SamplePostPreviewItem(post);
        }, (post: Post) => post.id.toString());
      }
    }
    .width('100%')
    .padding({ left: 20, right: 20, top: 12, bottom: 12 })
  }

  @Builder
  SamplePostPreviewItem(post: Post) {
    Column({ space: 12 }) {
      Row({ space: 12 }) {
        Image(this.normalizePostImagePath(post.avatar) || $r('app.media.ic_user_avatar'))
          .width(44)
          .height(44)
          .borderRadius(22)
          .objectFit(ImageFit.Cover)
          .border({ width: 2, color: '#F0F0F0' })

        Text(post.username || 'ç¾é£Ÿè¾¾äºº')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#1F1F1F')
      }

      Text(post.content || '')
        .fontSize(14)
        .fontColor('#333')
        .lineHeight(20)

      if (post.images && post.images.length > 0) {
        Row({ space: 8 }) {
          ForEach(post.images.slice(0, 3), (image: string, index: number) => {
            if (image.startsWith('app.media.')) {
              Image($r(image))
                .width(90)
                .height(90)
                .borderRadius(10)
                .objectFit(ImageFit.Cover)
            } else {
              Image(this.normalizePostImagePath(image))
                .width(90)
                .height(90)
                .borderRadius(10)
                .objectFit(ImageFit.Cover)
            }
          }, (image: string, index: number) => `${image}-preview-${index}`)
        }
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(18)
    .shadow({
      radius: 12,
      color: '#14000000',
      offsetX: 0,
      offsetY: 4
    })
  }

  @Builder
  PullToRefreshIndicator() {
    if (this.refreshing) {
      Column({ space: 8 }) {
      LoadingProgress()
          .width(32)
          .height(32)
        .color('#007DFF')
        Text('æ­£åœ¨åˆ·æ–°...')
          .fontSize(14)
        .fontColor('#666')
    }
      .padding(16)
      .width('100%')
      .alignItems(HorizontalAlign.Center)
    }
  }

  @Builder
  PostingOverlay() {
    Stack({ alignContent: Alignment.Center }) {
      Row() {}
        .width('100%')
        .height('100%')
        .backgroundColor('#66000000')

      Column({ space: 12 }) {
        LoadingProgress()
          .width(36)
          .height(36)
          .color('#007DFF')
        Text('æ­£åœ¨å‘å¸ƒï¼Œè¯·ç¨å€™...')
          .fontSize(14)
          .fontColor('#333')
      }
      .padding({ left: 32, right: 32, top: 24, bottom: 24 })
      .backgroundColor(Color.White)
      .borderRadius(20)
      .shadow({
        radius: 18,
        color: '#22000000',
        offsetX: 0,
        offsetY: 6
      })
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  SamplePreviewCard(card: SamplePreviewCard) {
    Column({ space: 12 }) {
      Row({ space: 12 }) {
        Image(card.avatar)
          .width(40)
          .height(40)
          .borderRadius(20)
          .objectFit(ImageFit.Cover)

        Column({ space: 4 }) {
          Text(card.nickname)
            .fontSize(15)
            .fontWeight(FontWeight.Medium)
            .fontColor('#222')
          Text(card.tag)
            .fontSize(12)
            .fontColor('#5C6BFF')
            .backgroundColor('#EEF0FF')
            .padding({ left: 8, right: 8, top: 2, bottom: 2 })
            .borderRadius(12)
        }
      }

      Text(card.content)
        .fontSize(14)
        .fontColor('#444')
        .lineHeight(20)

      Text('å¤´åƒ + æ˜µç§° + æ–‡æ¡ˆ + åª’ä½“ï¼Œä¿æŒ 16px å†…è¾¹è·ä¸åœ†è§’ã€‚')
        .fontSize(12)
        .fontColor('#999')
    }
    .width(240)
    .padding(16)
    .margin({ right: 16 })
    .backgroundColor(Color.White)
    .borderRadius(16)
    .shadow({
      radius: 12,
      color: '#1A000000',
      offsetX: 0,
      offsetY: 2
    })
  }

  @Builder
  PostFeedSection() {
    Column({ space: 12 }) {
      if (this.posts.length === 0 && !this.refreshing) {
        this.EmptyPlaceholder()
      } else {
        Column({ space: 12 }) {
          ForEach(this.posts, (post: Post) => {
            this.PostItem(post)
          }, (post: Post) => post.id.toString())

          if (this.loadingMore) {
            Row({ space: 10 }) {
              LoadingProgress()
                .width(20)
                .height(20)
                .color('#007DFF')
              Text('æ­£åœ¨åŠ è½½æ›´å¤š...')
                .fontSize(14)
                .fontColor('#888888')
            }
            .justifyContent(FlexAlign.Center)
            .width('100%')
            .padding({ top: 20, bottom: 20 })
          } else if (this.hasMore && this.posts.length > 0) {
            Row() {
              Button('ç‚¹å‡»åŠ è½½æ›´å¤š', { type: ButtonType.Normal, stateEffect: true })
                .fontSize(14)
                .fontWeight(FontWeight.Medium)
                .fontColor('#007DFF')
                .backgroundColor('#F0F6FF')
                .borderRadius(20)
                .height(40)
                .padding({ left: 24, right: 24 })
                .onClick(() => {
                  this.onLoadMore();
                })
            }
            .width('100%')
            .justifyContent(FlexAlign.Center)
            .padding({ top: 16, bottom: 20 })
          } else if (!this.hasMore && this.posts.length > 0) {
            Row({ space: 8 }) {
              Divider()
                .strokeWidth(1)
                .color('#E8E8E8')
                .layoutWeight(1)
              Text('å·²ç»åˆ°åº•å•¦')
                .fontSize(13)
                .fontColor('#BBBBBB')
              Divider()
                .strokeWidth(1)
                .color('#E8E8E8')
                .layoutWeight(1)
            }
            .width('80%')
            .alignSelf(ItemAlign.Center)
            .padding({ top: 20, bottom: 24 })
          }
        }
        .width('100%')
      }
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 12 })
  }

  @Builder
  EmptyPlaceholder() {
    Column({ space: 16 }) {
      // ç©ºçŠ¶æ€å›¾æ ‡
      Column() {
        Text('ğŸ“')
          .fontSize(64)
      }
      .width(120)
      .height(120)
      .borderRadius(60)
      .backgroundColor('#F5F7FA')
      .justifyContent(FlexAlign.Center)

      Column({ space: 8 }) {
        Text('è¿˜æ²¡æœ‰åŠ¨æ€')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1A1A1A')

        Text('åˆ†äº«ä½ çš„ç¾é£Ÿæ•…äº‹å§ï½')
          .fontSize(14)
          .fontColor('#888888')
      }

      Button('ç«‹å³å‘å¸ƒ', { type: ButtonType.Normal, stateEffect: true })
        .width(160)
        .height(46)
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor('#FFFFFF')
        .borderRadius(23)
        .linearGradient({
          angle: 90,
          colors: [['#FF6B6B', 0], ['#FF8E53', 1]]
        })
        .shadow({
          radius: 12,
          color: 'rgba(255,107,107,0.3)',
          offsetX: 0,
          offsetY: 4
        })
        .margin({ top: 8 })
        .onClick(() => {
          try {
            this.ensurePostFormInitialized();
            this.showPostDialog = true;
          } catch (error) {
            console.error('æ‰“å¼€å‘å¸ƒå¯¹è¯æ¡†å¤±è´¥: ' + JSON.stringify(error));
            ToastUtils.showToast('æ‰“å¼€å‘å¸ƒå¯¹è¯æ¡†å¤±è´¥ï¼Œè¯·é‡è¯•');
          }
        })
    }
    .width('100%')
    .alignItems(HorizontalAlign.Center)
    .padding({ top: 60, bottom: 40 })
  }

  private ensurePostFormInitialized(): void {
    try {
    if (!this.newPost) {
      this.newPost = createEmptyPostForm();
      return;
    }
      // ç¡®ä¿contentæ˜¯å­—ç¬¦ä¸²
      if (typeof this.newPost.content !== 'string') {
      this.newPost.content = '';
    }
      // ç¡®ä¿imagesæ˜¯æ•°ç»„
      if (!Array.isArray(this.newPost.images)) {
      this.newPost.images = [];
    }
      // ç¡®ä¿videosæ˜¯æ•°ç»„
      if (!Array.isArray(this.newPost.videos)) {
      this.newPost.videos = [];
      }
    } catch (error) {
      console.error('åˆå§‹åŒ–å‘å¸ƒè¡¨å•å¤±è´¥: ' + JSON.stringify(error));
      try {
        this.newPost = createEmptyPostForm();
      } catch (e) {
        console.error('åˆ›å»ºç©ºè¡¨å•å¤±è´¥: ' + JSON.stringify(e));
        // å¦‚æœåˆ›å»ºå¤±è´¥ï¼Œè‡³å°‘ç¡®ä¿åŸºæœ¬ç»“æ„
        this.newPost = {
          content: '',
          images: [],
          videos: []
        } as NewPostForm;
      }
    }
  }

  private resetNewPostForm(): void {
    try {
    this.newPost = createEmptyPostForm();
      this.postContent = '';
      this.mediaProcessing = false;
    } catch (error) {
      console.error('é‡ç½®è¡¨å•å¤±è´¥: ' + JSON.stringify(error));
      // å¦‚æœåˆ›å»ºå¤±è´¥ï¼Œè‡³å°‘é‡ç½®åŸºæœ¬å­—æ®µ
      try {
        this.newPost = {
          content: '',
          images: [],
          videos: []
        } as NewPostForm;
        this.postContent = '';
        this.mediaProcessing = false;
      } catch (e) {
        console.error('é‡ç½®è¡¨å•å­—æ®µå¤±è´¥: ' + JSON.stringify(e));
      }
    }
  }

  private normalizePosts(posts: Post[]): Post[] {
    if (!posts || posts.length === 0) {
      return [];
    }
    const normalized: Post[] = [];
    for (const post of posts) {
      normalized.push(this.normalizePostMedia(post));
    }
    return normalized;
  }

  private normalizePostMedia(post: Post): Post {
    if (!post.images) {
      post.images = [];
    }
    if (!post.videos) {
      post.videos = [];
    }
    if (post.imageUrls && post.imageUrls.length > 0 && post.images.length === 0 && post.videos.length === 0) {
      const cleaned = post.imageUrls.split(',')
        .map((item: string) => item.trim())
        .filter((item: string) => !!item);
      for (const mediaPath of cleaned) {
        if (this.isVideoPath(mediaPath)) {
          post.videos.push(mediaPath);
        } else {
          post.images.push(mediaPath);
        }
      }
    }
    post.images = post.images.map((path: string) => this.toAbsoluteMediaPath(path));
    post.videos = post.videos.map((path: string) => this.toAbsoluteMediaPath(path));
    return post;
  }

  private isVideoPath(path: string): boolean {
    if (!path) {
      return false;
    }
    const lower = path.toLowerCase();
    return lower.endsWith('.mp4') || lower.endsWith('.mov') || lower.endsWith('.avi') || lower.endsWith('.mkv');
  }

  private getCurrentMediaTotal(): number {
    try {
      if (!this.newPost) {
        return 0;
      }
      const imageList: string[] = (Array.isArray(this.newPost.images)) ? this.newPost.images : [];
      const videoList: string[] = (Array.isArray(this.newPost.videos)) ? this.newPost.videos : [];
    return imageList.length + videoList.length;
    } catch (error) {
      console.error('getCurrentMediaTotalå¼‚å¸¸: ' + JSON.stringify(error));
      return 0;
    }
  }

  private buildSelectedMediaPreview(): SelectedMediaPreview[] {
    try {
      const preview: SelectedMediaPreview[] = [];
      // æ·»åŠ æ›´å¼ºçš„ç©ºå€¼æ£€æŸ¥ï¼Œé˜²æ­¢å´©æºƒ
      if (!this.newPost) {
        return preview;
      }
      const images: string[] = Array.isArray(this.newPost.images) ? this.newPost.images : [];
      const videos: string[] = Array.isArray(this.newPost.videos) ? this.newPost.videos : [];
      images.forEach((path: string, index: number) => {
        preview.push({ path, type: 'image', key: `image-${index}`, index });
      });
      videos.forEach((path: string, index: number) => {
        preview.push({ path, type: 'video', key: `video-${index}`, index });
      });
      return preview;
    } catch (error) {
      console.error('buildSelectedMediaPreviewå¼‚å¸¸: ' + JSON.stringify(error));
      return [];
    }
  }

  private get mediaPreviewList(): SelectedMediaPreview[] {
    return this.buildSelectedMediaPreview();
  }

  private removeMedia(type: 'image' | 'video', index: number): void {
    this.ensurePostFormInitialized();
    if (!this.newPost) {
      return;
    }
    if (type === 'image') {
      const sourceImages: string[] = Array.isArray(this.newPost.images) ? this.newPost.images : [];
      const newImages: string[] = sourceImages.slice();
      newImages.splice(index, 1);
      this.newPost.images = newImages;
    } else {
      const sourceVideos: string[] = Array.isArray(this.newPost.videos) ? this.newPost.videos : [];
      const newVideos: string[] = sourceVideos.slice();
      newVideos.splice(index, 1);
      this.newPost.videos = newVideos;
    }
  }

  private toRelativeMediaPath(path: string): string {
    try {
      if (!path || typeof path !== 'string') {
      return '';
    }
      if (!this.context) {
        // å°è¯•è·å–context
        try {
          this.context = getContext(this) as common.UIAbilityContext;
        } catch (e) {
          console.error('è·å–contextå¤±è´¥: ' + JSON.stringify(e));
          return path;
        }
      }
    if (!this.context) {
      return path;
    }
    const filesDir = this.context.filesDir;
      if (!filesDir) {
        return path;
      }
    if (path.startsWith(filesDir)) {
      const trimmed = path.substring(filesDir.length);
      return trimmed.startsWith('/') ? trimmed.substring(1) : trimmed;
    }
    return path;
    } catch (error) {
      console.error('toRelativeMediaPathå¼‚å¸¸: ' + JSON.stringify(error));
      return path || '';
    }
  }

  private toAbsoluteMediaPath(path: string): string {
    if (!path) {
      return '';
    }
    if (path.startsWith('file://')) {
      return path.replace('file://', '');
    }
    const lower = path.toLowerCase();
    if (lower.startsWith('http://') || lower.startsWith('https://')) {
      return path;
    }
    if (path.startsWith('app.media.')) {
      return path;
    }
    // å¦‚æœæ˜¯æœåŠ¡å™¨å›¾ç‰‡è·¯å¾„(å¦‚images/dishes/xxx.jpg)ï¼Œæ‹¼æ¥æœåŠ¡å™¨URL
    if (path.startsWith('images/')) {
      return `http://10.52.131.181:5000/${path}`;
    }
    if (path.startsWith('/images/')) {
      return `http://10.52.131.181:5000${path}`;
    }
    if (path.startsWith('/')) {
      return path;
    }
    if (!this.context) {
      try {
        this.context = getContext(this) as common.UIAbilityContext;
      } catch (error) {
        console.error('è·å–ä¸Šä¸‹æ–‡å¤±è´¥:' + JSON.stringify(error));
        return path;
      }
    }
    if (!this.context) {
      return path;
    }
    // å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„(å¦‚posts/xxxæˆ–dishes/xxx),æ‹¼æ¥filesDir
    return `${this.context.filesDir}/${path}`;
  }

  // æ ‡å‡†åŒ–å¸–å­å›¾ç‰‡è·¯å¾„(ç”¨äºæ˜¾ç¤º)
  private normalizePostImagePath(path: string): string {
    if (!path) {
      return '';
    }
    const lower = path.toLowerCase();
    // èµ„æºå¼•ç”¨(app.media.xxx)
    if (path.startsWith('app.media.')) {
      return path;
    }
    // HTTP/HTTPS URL
    if (lower.startsWith('http://') || lower.startsWith('https://')) {
      return path;
    }
    // file://åè®®
    if (lower.startsWith('file://')) {
      return path.replace('file://', '');
    }
    // ç»å¯¹è·¯å¾„
    if (path.startsWith('/')) {
      return path;
    }
    // ç›¸å¯¹è·¯å¾„(posts/xxxæˆ–dishes/xxx),éœ€è¦è½¬æ¢ä¸ºç»å¯¹è·¯å¾„
    if (!this.context) {
      try {
        this.context = getContext(this) as common.UIAbilityContext;
      } catch (error) {
        console.error('è·å–ä¸Šä¸‹æ–‡å¤±è´¥:' + JSON.stringify(error));
        return path;
      }
    }
    if (!this.context) {
      return path;
    }
    // å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„,æ‹¼æ¥filesDir
    return `${this.context.filesDir}/${path}`;
  }

  private buildPayloadPaths(paths: string[] = []): string[] {
    try {
      if (!paths || !Array.isArray(paths)) {
        return [];
      }
    const dedup: string[] = [];
    paths.forEach((path: string) => {
        try {
          if (path) {
      const relative = this.toRelativeMediaPath(path);
            if (relative && relative.length > 0 && dedup.indexOf(relative) === -1) {
        dedup.push(relative);
            }
          }
        } catch (e) {
          console.error('å¤„ç†è·¯å¾„å¤±è´¥: ' + JSON.stringify(e));
          // è·³è¿‡æ— æ•ˆè·¯å¾„
      }
    });
    return dedup;
    } catch (error) {
      console.error('buildPayloadPathså¼‚å¸¸: ' + JSON.stringify(error));
      return [];
    }
  }

  private async ensureMediaPermissions(): Promise<boolean> {
    if (this.mediaPermissionsGranted) {
      return true;
    }
    if (!this.atManager || !this.context) {
      return false;
    }
    try {
      const permissionResult = await this.atManager.requestPermissionsFromUser(
        this.context,
        this.mediaPermissions
      ) as PermissionRequestResult;
      const granted = permissionResult.authResults.every((status: number) => status === 0);
      this.mediaPermissionsGranted = granted;
      if (!granted) {
        ToastUtils.showToast('è¯·æˆäºˆç›¸å†Œä¸ç›¸æœºæƒé™åå†è¯•');
      }
      return granted;
    } catch (error) {
      console.error('ç”³è¯·åª’ä½“æƒé™å¤±è´¥:' + JSON.stringify(error));
      ToastUtils.showToast('æƒé™ç”³è¯·å¤±è´¥');
      return false;
    }
  }

  private async openGallery(type: 'image' | 'video'): Promise<void> {
    this.ensurePostFormInitialized();
    const granted = await this.ensureMediaPermissions();
    if (!granted) {
      return;
    }
    const remain = this.maxMediaCount - this.getCurrentMediaTotal();
    if (remain <= 0) {
      ToastUtils.showToast(`æœ€å¤šåªèƒ½é€‰æ‹©${this.maxMediaCount}ä¸ªæ–‡ä»¶`);
      return;
    }
    try {
      const viewPicker = new picker.PhotoViewPicker();
      const options = new picker.PhotoSelectOptions();
      options.MIMEType = type === 'video' ? picker.PhotoViewMIMETypes.VIDEO_TYPE : picker.PhotoViewMIMETypes.IMAGE_TYPE;
      options.maxSelectNumber = remain;
      const result = await viewPicker.select(options);
      if (result && result.photoUris && result.photoUris.length > 0) {
        await this.handleMediaResult(result.photoUris, type);
      }
    } catch (error) {
      console.error('é€‰æ‹©åª’ä½“å¤±è´¥:' + JSON.stringify(error));
      ToastUtils.showToast('é€‰æ‹©åª’ä½“å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }

  private async captureFromCamera(): Promise<void> {
    this.ensurePostFormInitialized();
    const granted = await this.ensureMediaPermissions();
    if (!granted) {
      return;
    }
    try {
      const viewPicker = new picker.PhotoViewPicker();
      const options = new picker.PhotoSelectOptions();
      options.MIMEType = picker.PhotoViewMIMETypes.IMAGE_TYPE;
      options.maxSelectNumber = 1;
      const result = await viewPicker.select(options);
      if (result && result.photoUris && result.photoUris.length > 0) {
        await this.handleMediaResult([result.photoUris[0]], 'image');
      }
    } catch (error) {
      console.error('æ‹æ‘„åª’ä½“å¤±è´¥:' + JSON.stringify(error));
      ToastUtils.showToast('æ‹æ‘„å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }

  // å®‰å…¨åŒ…è£…å™¨ - é˜²æ­¢å¼‚æ­¥è°ƒç”¨å¯¼è‡´å´©æºƒ
  private safeOpenGallery(type: 'image' | 'video'): void {
    this.openGallery(type).catch((error: Error) => {
      console.error('safeOpenGalleryå¼‚å¸¸:' + JSON.stringify(error));
    });
  }

  private safeCaptureFromCamera(): void {
    this.captureFromCamera().catch((error: Error) => {
      console.error('safeCaptureFromCameraå¼‚å¸¸:' + JSON.stringify(error));
    });
  }

  private async handleMediaResult(uris: string[], type: 'image' | 'video'): Promise<void> {
    try {
    this.ensurePostFormInitialized();
      if (!uris || !Array.isArray(uris) || uris.length === 0) {
      return;
    }
    this.mediaProcessing = true;
    try {
      for (const uri of uris) {
          if (!uri || typeof uri !== 'string') {
            continue;
          }
        if (this.getCurrentMediaTotal() >= this.maxMediaCount) {
          ToastUtils.showToast(`æœ€å¤šåªèƒ½é€‰æ‹©${this.maxMediaCount}ä¸ªæ–‡ä»¶`);
          break;
        }
          try {
        const storedPath = await this.persistMedia(uri, type);
            if (storedPath && typeof storedPath === 'string') {
              this.ensurePostFormInitialized();
        if (type === 'image') {
                if (Array.isArray(this.newPost.images)) {
                  const newImages: string[] = [];
                  for (const img of this.newPost.images) {
                    newImages.push(img);
                  }
                  newImages.push(storedPath);
                  this.newPost.images = newImages;
        } else {
                  this.newPost.images = [storedPath];
                }
              } else {
                if (Array.isArray(this.newPost.videos)) {
                  const newVideos: string[] = [];
                  for (const vid of this.newPost.videos) {
                    newVideos.push(vid);
                  }
                  newVideos.push(storedPath);
                  this.newPost.videos = newVideos;
                } else {
                  this.newPost.videos = [storedPath];
                }
              }
            }
          } catch (e) {
            console.error('å¤„ç†å•ä¸ªåª’ä½“æ–‡ä»¶å¤±è´¥: ' + JSON.stringify(e));
            // ç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªæ–‡ä»¶
        }
      }
    } finally {
      this.mediaProcessing = false;
      }
    } catch (error) {
      console.error('handleMediaResultå¼‚å¸¸: ' + JSON.stringify(error));
      this.mediaProcessing = false;
      ToastUtils.showToast('å¤„ç†åª’ä½“æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }

  private async persistMedia(uri: string, type: 'image' | 'video'): Promise<string> {
    if (!this.context) {
      try {
        this.context = getContext(this) as common.UIAbilityContext;
      } catch (error) {
        console.error('è·å–ä¸Šä¸‹æ–‡å¤±è´¥:' + JSON.stringify(error));
        return uri;
      }
    }
    if (!this.context) {
      return uri;
    }
    try {
      const sourcePath: string = this.resolveFilePath(uri);
      if (!sourcePath) {
        console.error('æ— æ³•è§£æåª’ä½“è·¯å¾„:' + uri);
        return uri;
      }
      
      // æ£€æŸ¥æºæ–‡ä»¶æ˜¯å¦å­˜åœ¨
      try {
        fs.accessSync(sourcePath);
      } catch (error) {
        console.error('æºåª’ä½“æ–‡ä»¶ä¸å­˜åœ¨:' + sourcePath);
        return uri;
      }
      
      // ç¡®ä¿åº”ç”¨ç§æœ‰ç›®å½•å­˜åœ¨
      const filesDir: string = this.context.filesDir;
      try {
        fs.accessSync(filesDir);
      } catch (error) {
        // ç›®å½•ä¸å­˜åœ¨,åˆ›å»ºå®ƒ
        try {
          fs.mkdirSync(filesDir, true);
        } catch (mkdirError) {
          console.error('åˆ›å»ºfilesDirå¤±è´¥:' + JSON.stringify(mkdirError));
        }
      }
      
      // åˆ›å»ºpostså­ç›®å½•ç”¨äºå­˜å‚¨å¸–å­åª’ä½“
      const postsDir: string = `${filesDir}/posts`;
      try {
        fs.accessSync(postsDir);
      } catch (error) {
        // ç›®å½•ä¸å­˜åœ¨,åˆ›å»ºå®ƒ
        try {
          fs.mkdirSync(postsDir, true);
        } catch (mkdirError) {
          console.error('åˆ›å»ºpostsDirå¤±è´¥:' + JSON.stringify(mkdirError));
        }
      }
      
      // ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
      const extension: string = this.extractExtension(sourcePath, type === 'video' ? '.mp4' : '.jpg');
      const fileName: string = `post_${type}_${Date.now()}_${Math.floor(Math.random() * 10000)}${extension}`;
      const targetPath: string = `${postsDir}/${fileName}`;
      
      // å¤åˆ¶æ–‡ä»¶åˆ°åº”ç”¨ç§æœ‰ç›®å½•
      fs.copyFileSync(sourcePath, targetPath);
      
      // è¿”å›ç›¸å¯¹è·¯å¾„(ç›¸å¯¹äºfilesDir),è¿™æ ·æ•°æ®åº“åªå­˜å‚¨ç›¸å¯¹è·¯å¾„
      const relativePath: string = `posts/${fileName}`;
      console.log('åª’ä½“å·²ä¿å­˜åˆ°:' + targetPath + ', ç›¸å¯¹è·¯å¾„:' + relativePath);
      return relativePath;
    } catch (error) {
      console.error('ä¿å­˜åª’ä½“æ–‡ä»¶å¤±è´¥:' + JSON.stringify(error));
      ToastUtils.showToast('åª’ä½“ä¿å­˜å¤±è´¥ï¼Œå°†ä½¿ç”¨åŸå§‹è·¯å¾„');
      return uri;
    }
  }

  private extractExtension(path: string, fallback: string = ''): string {
    if (!path) {
      return fallback;
    }
    const dotIndex = path.lastIndexOf('.');
    if (dotIndex === -1) {
      return fallback;
    }
    return path.substring(dotIndex);
  }

  private resolveFilePath(uri: string): string {
    if (!uri) {
      return '';
    }
    if (uri.startsWith('file://')) {
      return uri.replace('file://', '');
    }
    return uri;
  }

  // åŠ è½½å¸–å­æ•°æ®
  async loadPosts(isRefresh: boolean = false): Promise<void> {
    try {
      if (isRefresh) {
        this.refreshing = true;
        this.currentPage = 1;
        this.hasMore = true;
      } else {
        if (!this.hasMore || this.loadingMore) {
          return;
        }
        this.loadingMore = true;
      }

      // æ ¹æ®å½“å‰åˆ†ç±»æ„å»ºAPIè¯·æ±‚
      // ä½¿ç”¨è‹±æ–‡å‚æ•°é¿å…ç¼–ç é—®é¢˜
      const categoryParam = this.activeCategory === 'å…³æ³¨' ? '&category=following' :
                          this.activeCategory === 'é™„è¿‘' ? '&category=nearby' :
                          '&category=recommend';
      const response: ApiResponse = await ApiUtils.get(`/posts/list?page=${this.currentPage}&limit=10${categoryParam}`);

      if (response.statusCode === 200 && response.data) {
        const data = response.data as PostListResponse;
        const newPosts: Post[] = data.posts || [];
        const normalizedPosts: Post[] = this.normalizePosts(newPosts);

        if (isRefresh) {
          // å¯¹äº"å…³æ³¨"æ ‡ç­¾,å¦‚æœæ²¡æœ‰æ•°æ®å°±ä¸æ˜¾ç¤ºç¤ºä¾‹å¸–å­
          if (this.activeCategory === 'å…³æ³¨') {
            this.posts = normalizedPosts;
          } else {
          this.posts = normalizedPosts.length > 0 ? normalizedPosts : this.createLocalSamplePosts();
          }
        } else {
          this.posts = this.posts.concat(normalizedPosts);
          // å¯¹äº"å…³æ³¨"æ ‡ç­¾,å¦‚æœæ²¡æœ‰æ•°æ®å°±ä¸æ˜¾ç¤ºç¤ºä¾‹å¸–å­
          if (normalizedPosts.length === 0 && this.posts.length === 0 && this.activeCategory !== 'å…³æ³¨') {
            this.posts = this.createLocalSamplePosts();
          }
        }

        if (normalizedPosts.length === 0) {
          this.hasMore = false;
        } else {
        this.hasMore = this.currentPage < data.pagination.pages;
        this.currentPage++;
        }
      } else {
        ToastUtils.showToast(response.message || 'åŠ è½½å¤±è´¥');
        if (this.posts.length === 0 && this.activeCategory !== 'å…³æ³¨') {
          this.posts = this.createLocalSamplePosts();
          this.hasMore = false;
        }
      }
    } catch (error) {
      console.error('åŠ è½½å¸–å­å¤±è´¥:' + JSON.stringify(error));
      ToastUtils.showToast('ç½‘ç»œå¼‚å¸¸ï¼Œè¯·é‡è¯•');
      if (this.posts.length === 0 && this.activeCategory !== 'å…³æ³¨') {
        this.posts = this.createLocalSamplePosts();
        this.hasMore = false;
      }
    } finally {
      this.refreshing = false;
      this.loadingMore = false;
    }
  }

  // å¤„ç†å‘å¸ƒåŠ¨æ€ - åŒæ­¥æ–¹å¼é¿å…å´©æºƒ
  private handlePublishPost(): void {
    // é˜²æ­¢é‡å¤è°ƒç”¨
    if (this.posting) {
      console.info('æ­£åœ¨å‘å¸ƒä¸­ï¼Œå¿½ç•¥é‡å¤ç‚¹å‡»');
      return;
    }

    try {
      console.info('handlePublishPost å¼€å§‹æ‰§è¡Œ');

      // ç¡®ä¿è¡¨å•å·²åˆå§‹åŒ–
      this.ensurePostFormInitialized();
      
      // éªŒè¯å†…å®¹
      if (!this.newPost) {
        console.error('å‘å¸ƒè¡¨å•æœªåˆå§‹åŒ–');
        this.newPost = createEmptyPostForm();
        return;
      }
      
      const content: string = (this.newPost.content || '').trim();
      if (!content) {
        ToastUtils.showToast('è¯·è¾“å…¥åŠ¨æ€å†…å®¹');
        return;
      }

      // è®¾ç½®å‘å¸ƒçŠ¶æ€
      this.posting = true;
      console.info('å¼€å§‹å‘å¸ƒåŠ¨æ€ï¼Œå†…å®¹: ' + content.substring(0, 20));

      // ç›´æ¥è°ƒç”¨å‘å¸ƒé€»è¾‘
      this.executePublishPost(content);
    } catch (error) {
      console.error('handlePublishPost å¼‚å¸¸: ' + JSON.stringify(error));
      this.posting = false;
      ToastUtils.showToast('å‘å¸ƒå¼‚å¸¸ï¼Œè¯·é‡è¯•');
    }
  }

  // æ‰§è¡Œå‘å¸ƒé€»è¾‘ - ä½¿ç”¨å›è°ƒæ–¹å¼é¿å…async/awaitå´©æºƒ
  private executePublishPost(content: string): void {
    try {
      // å®‰å…¨è·å–å›¾ç‰‡å’Œè§†é¢‘æ•°ç»„
      const images: string[] = (this.newPost?.images && Array.isArray(this.newPost.images)) ? this.newPost.images : [];
      const videos: string[] = (this.newPost?.videos && Array.isArray(this.newPost.videos)) ? this.newPost.videos : [];
      
      // å°†åª’ä½“è·¯å¾„è½¬æ¢ä¸ºç›¸å¯¹è·¯å¾„
      let payloadImages: string[] = [];
      let payloadVideos: string[] = [];
      try {
        if (images.length > 0) {
          const result = this.buildPayloadPaths(images);
          payloadImages = Array.isArray(result) ? result : [];
        }
        if (videos.length > 0) {
          const result = this.buildPayloadPaths(videos);
          payloadVideos = Array.isArray(result) ? result : [];
        }
      } catch (e) {
        console.error('æ„å»ºè·¯å¾„å¤±è´¥: ' + JSON.stringify(e));
        payloadImages = [];
        payloadVideos = [];
      }
      
      // å®‰å…¨æ‹¼æ¥è·¯å¾„
      const combinedPayload: string[] = (payloadImages || []).concat(payloadVideos || []);
      const imageUrlsStr: string = combinedPayload.length > 0 ? combinedPayload.join(',') : '';
      
      // å®‰å…¨æˆªå–æ ‡é¢˜
      let title: string = content;
      try {
        title = content.length > 20 ? (content.substring(0, 20) + '...') : content;
      } catch (e) {
        console.error('æˆªå–æ ‡é¢˜å¤±è´¥: ' + JSON.stringify(e));
      }
      
      const postData: CreatePostRequest = {
        title: title,
        content: content,
        image_urls: imageUrlsStr,
        images: payloadImages || [],
        videos: payloadVideos || []
      };

      console.info('å‘é€å‘å¸ƒè¯·æ±‚...');
      
      // ä½¿ç”¨å›è°ƒæ–¹å¼å¤„ç†APIè¯·æ±‚
      ApiUtils.post('/posts/create', postData)
        .then((response: ApiResponse) => {
          console.info('å‘å¸ƒå“åº”: ' + JSON.stringify(response));
          this.handlePublishResponse(response);
        })
        .catch((error: Error) => {
          console.error('å‘å¸ƒè¯·æ±‚å¤±è´¥: ' + JSON.stringify(error));
          this.posting = false;
          ToastUtils.showToast('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•');
        });
    } catch (error) {
      console.error('executePublishPost å¼‚å¸¸: ' + JSON.stringify(error));
      this.posting = false;
      ToastUtils.showToast('å‘å¸ƒå¼‚å¸¸ï¼Œè¯·é‡è¯•');
    }
  }

  // å¤„ç†å‘å¸ƒå“åº”
  private handlePublishResponse(response: ApiResponse): void {
    try {
      // æ£€æŸ¥å“åº”æ˜¯å¦æœ‰æ•ˆ
      if (!response) {
        ToastUtils.showToast('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
        this.posting = false;
        return;
      }

      if (response.statusCode === 200) {
        ToastUtils.showToast('å‘å¸ƒæˆåŠŸ');
        // é‡ç½®çŠ¶æ€
        this.posting = false;
        this.resetNewPostForm();
        this.showPostDialog = false;
        // å»¶è¿Ÿåˆ·æ–°åˆ—è¡¨ï¼Œé¿å…çŠ¶æ€å†²çª
        setTimeout(() => {
          try {
            this.loadPosts(true);
          } catch (e) {
            console.error('åˆ·æ–°åˆ—è¡¨å¤±è´¥: ' + JSON.stringify(e));
          }
        }, 100);
      } else {
        // å‘å¸ƒå¤±è´¥ï¼Œé‡ç½®çŠ¶æ€
        this.posting = false;
        const errorMsg: string = response.message || 'å‘å¸ƒå¤±è´¥';
        ToastUtils.showToast(errorMsg);
        console.error('å‘å¸ƒå¤±è´¥:', errorMsg);
      }
    } catch (error) {
      console.error('handlePublishResponse å¼‚å¸¸: ' + JSON.stringify(error));
      this.posting = false;
      ToastUtils.showToast('å¤„ç†å“åº”å¤±è´¥');
    }
  }

  // å®é™…å‘å¸ƒé€»è¾‘ - ä¿ç•™asyncç‰ˆæœ¬ä»¥å…¼å®¹
  private async doPublishPost(content: string): Promise<void> {
    this.executePublishPost(content);
  }

  // å‘å¸ƒåŠ¨æ€ (ä¿ç•™åŸæ–¹æ³•ä»¥å…¼å®¹)
  async publishPost(): Promise<void> {
    this.handlePublishPost();
  }

  // å¤åˆ¶å¸–å­æ•°ç»„çš„è¾…åŠ©æ–¹æ³•
  private copyPosts(): Post[] {
    const copy: Post[] = [];
    for (const p of this.posts) {
      const newPost = new Post();
      newPost.id = p.id;
      newPost.user_id = p.user_id;
      newPost.username = p.username;
      newPost.avatar = p.avatar;
      newPost.content = p.content;
      newPost.images = p.images;
      newPost.videos = p.videos;
      newPost.likeCount = p.likeCount;
      newPost.commentCount = p.commentCount;
      newPost.isLiked = p.isLiked;
      newPost.isFollowed = p.isFollowed;
      newPost.createTime = p.createTime;
      newPost.title = p.title;
      newPost.imageUrls = p.imageUrls;
      copy.push(newPost);
    }
    return copy;
  }

  // ç‚¹èµ/å–æ¶ˆç‚¹èµ - ä¹è§‚æ›´æ–°ç­–ç•¥
  async toggleLike(post: Post): Promise<void> {
    // æœ¬åœ°ç¤ºä¾‹å¸–ï¼ˆid < 0ï¼‰åªåšå‰ç«¯æœ¬åœ°åˆ‡æ¢ï¼Œä¸è°ƒç”¨åç«¯
    if (post.id < 0) {
      const index: number = this.posts.findIndex((p: Post) => p.id === post.id);
      if (index !== -1) {
        const isLikedNow: boolean = !this.posts[index].isLiked;
        const newLikeCount: number = Math.max(0, this.posts[index].likeCount + (isLikedNow ? 1 : -1));
        const updatedPosts: Post[] = this.copyPosts();
        updatedPosts[index].isLiked = isLikedNow;
        updatedPosts[index].likeCount = newLikeCount;
        this.posts = updatedPosts;
      }
      return;
    }

    // ä¿å­˜æ—§çŠ¶æ€ç”¨äºå›æ»š
    const index: number = this.posts.findIndex((p: Post) => p.id === post.id);
    if (index === -1) return;
    
    const oldIsLiked = this.posts[index].isLiked;
    const oldLikeCount = this.posts[index].likeCount;

    // ç«‹å³æ›´æ–°UIï¼ˆä¹è§‚æ›´æ–°ï¼‰
    const updatedPosts: Post[] = this.copyPosts();
    updatedPosts[index].isLiked = !oldIsLiked;
    updatedPosts[index].likeCount = oldIsLiked ? Math.max(0, oldLikeCount - 1) : oldLikeCount + 1;
    this.posts = updatedPosts;

    // å¼‚æ­¥å‘é€è¯·æ±‚
    try {
      const likeData: LikeRequest = {
        post_id: post.id
      };
      const response: ApiResponse = await ApiUtils.post('/posts/like', likeData);

      if (response.statusCode === 200 && response.data) {
        // ç”¨æœåŠ¡å™¨è¿”å›çš„æ•°æ®æ›´æ–°ï¼ˆç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼‰
        const data = response.data as LikeResponse;
        const syncPosts: Post[] = this.copyPosts();
        const syncIndex = syncPosts.findIndex((p: Post) => p.id === post.id);
        if (syncIndex !== -1) {
          syncPosts[syncIndex].isLiked = data.is_liked;
          syncPosts[syncIndex].likeCount = data.likes;
          this.posts = syncPosts;
        }
      }
    } catch (error) {
      // è¯·æ±‚å¤±è´¥ï¼Œå›æ»šUI
      console.error('ç‚¹èµæ“ä½œå¤±è´¥:' + JSON.stringify(error));
      const rollbackPosts: Post[] = this.copyPosts();
      const rollbackIndex = rollbackPosts.findIndex((p: Post) => p.id === post.id);
      if (rollbackIndex !== -1) {
        rollbackPosts[rollbackIndex].isLiked = oldIsLiked;
        rollbackPosts[rollbackIndex].likeCount = oldLikeCount;
        this.posts = rollbackPosts;
      }
      ToastUtils.showToast('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }

  // å…³æ³¨/å–æ¶ˆå…³æ³¨ - ä¹è§‚æ›´æ–°ç­–ç•¥
  async toggleFollow(post: Post): Promise<void> {
    // æœ¬åœ°ç¤ºä¾‹å¸–ï¼ˆid < 0 æˆ– user_id <= 0ï¼‰åªåšå‰ç«¯æœ¬åœ°åˆ‡æ¢
    if (post.id < 0 || post.user_id <= 0) {
      const index: number = this.posts.findIndex((p: Post) => p.id === post.id);
      if (index !== -1) {
        const newFollowStatus: boolean = !this.posts[index].isFollowed;
        const updatedPosts: Post[] = this.copyPosts();
        updatedPosts[index].isFollowed = newFollowStatus;
        this.posts = updatedPosts;
        ToastUtils.showToast(newFollowStatus ? 'å·²å…³æ³¨' : 'å·²å–æ¶ˆå…³æ³¨');
      }
      return;
    }

    // éªŒè¯ç”¨æˆ·IDæœ‰æ•ˆæ€§
    if (!post.user_id || post.user_id <= 0) {
      ToastUtils.showToast('æ— æ•ˆçš„ç”¨æˆ·ä¿¡æ¯');
      return;
    }

    // ä¿å­˜æ—§çŠ¶æ€ç”¨äºå›æ»š
    const oldFollowStatus = post.isFollowed;

    // ç«‹å³æ›´æ–°UIï¼ˆä¹è§‚æ›´æ–°ï¼‰
    const updatedPosts: Post[] = this.copyPosts();
    updatedPosts.forEach((p: Post) => {
      if (p.user_id === post.user_id) {
        p.isFollowed = !oldFollowStatus;
      }
    });
    this.posts = updatedPosts;
    ToastUtils.showToast(!oldFollowStatus ? 'å·²å…³æ³¨' : 'å·²å–æ¶ˆå…³æ³¨');

    // å¼‚æ­¥å‘é€è¯·æ±‚
    try {
      const endpoint = oldFollowStatus ? '/unfollow' : '/follow';
      const followData: FollowRequest = {
        user_id: post.user_id
      };
      const response: ApiResponse = await ApiUtils.post(endpoint, followData);

      if (response.statusCode === 200 && response.data) {
        const data = response.data as FollowResponse;
        // ç”¨æœåŠ¡å™¨è¿”å›çš„æ•°æ®åŒæ­¥
        const syncPosts: Post[] = this.copyPosts();
        syncPosts.forEach((p: Post) => {
          if (p.user_id === post.user_id) {
            p.isFollowed = data.is_following;
          }
        });
        this.posts = syncPosts;
        
        // å¦‚æœå½“å‰åœ¨"å…³æ³¨"æ ‡ç­¾é¡µä¸”å–æ¶ˆå…³æ³¨,åˆ·æ–°åˆ—è¡¨
        if (this.activeCategory === 'å…³æ³¨' && !data.is_following) {
          this.loadPosts(true);
        }
      }
    } catch (error) {
      // è¯·æ±‚å¤±è´¥ï¼Œå›æ»šUI
      console.error('å…³æ³¨æ“ä½œå¤±è´¥:' + JSON.stringify(error));
      const rollbackPosts: Post[] = this.copyPosts();
      rollbackPosts.forEach((p: Post) => {
        if (p.user_id === post.user_id) {
          p.isFollowed = oldFollowStatus;
        }
      });
      this.posts = rollbackPosts;
      ToastUtils.showToast('ç½‘ç»œå¼‚å¸¸ï¼Œè¯·é‡è¯•');
    }
  }

  // å¤„ç†ä¸‹æ‹‰åˆ·æ–°
  onRefresh(): void {
    this.loadPosts(true);
  }

  // å¤„ç†ä¸Šæ‹‰åŠ è½½æ›´å¤š
  onLoadMore(): void {
    this.loadPosts(false);
  }

  build() {
    Stack() {
      Refresh({ refreshing: this.refreshing, offset: 80, friction: 80 }) {
        Scroll() {
          Column({ space: 0 }) {
            // ä¸‹æ‹‰åˆ·æ–°æŒ‡ç¤ºå™¨ - æ›´ç¾è§‚çš„è®¾è®¡
            if (this.refreshing) {
              Column({ space: 12 }) {
                LoadingProgress()
                  .width(36)
                  .height(36)
                  .color('#007DFF')
                Text('æ­£åœ¨åˆ·æ–°å†…å®¹...')
                  .fontSize(14)
                  .fontColor('#666')
                  .fontWeight(FontWeight.Medium)
              }
              .width('100%')
              .padding({ top: 24, bottom: 16 })
              .justifyContent(FlexAlign.Center)
              .backgroundColor('#F8F8F8')
            }

            this.DiscoverHeader()
            this.CategoryChips()
            this.PostFeedSection()
          }
          .width('100%')
          .padding({ bottom: 32 })
        }
        .width('100%')
        .height('100%')
        .scrollBar(BarState.Off)
        .edgeEffect(EdgeEffect.Spring)
        .onScrollFrameBegin((offset: number, state: ScrollState) => {
          if (offset > 0 && !this.loadingMore && this.hasMore) {
            const estimatedVisibleHeight: number = 800;
            const estimatedContentHeight: number = 600 + this.posts.length * 300;
            if (offset + estimatedVisibleHeight >= estimatedContentHeight - 120) {
              this.onLoadMore();
            }
          }
          return { offsetRemain: offset };
        })
      }
      .width('100%')
      .height('100%')
      .onRefreshing(() => {
        console.info('è§¦å‘ä¸‹æ‹‰åˆ·æ–°');
        if (!this.refreshing) {
          this.onRefresh();
        }
      })

      if (this.showPostDialog) {
        Column() {
          // é®ç½©å±‚ - ç‚¹å‡»å…³é—­
          Column()
            .width('100%')
            .height('10%')
            .backgroundColor('#66000000')
            .onClick(() => {
              try {
              if (!this.posting) {
                this.showPostDialog = false;
                this.resetNewPostForm();
                } else {
                  ToastUtils.showToast('æ­£åœ¨å‘å¸ƒä¸­ï¼Œè¯·ç¨å€™...');
                }
              } catch (error) {
                console.error('å…³é—­å¯¹è¯æ¡†å¼‚å¸¸: ' + JSON.stringify(error));
                this.showPostDialog = false;
              }
            })

          // å¯¹è¯æ¡†å†…å®¹åŒºåŸŸ
          Column() {
            this.PostDialog()
          }
          .width('100%')
          .height('90%')
          .backgroundColor('#FFFFFF')
          .borderRadius({ topLeft: 24, topRight: 24 })
        }
        .width('100%')
        .height('100%')
      }

      if (this.showCommentDialog) {
        Stack({ alignContent: Alignment.Bottom }) {
          // é®ç½©å±‚
          Row()
            .width('100%')
            .height('100%')
            .backgroundColor('#66000000')
            .onClick(() => {
              this.showCommentDialog = false;
              this.currentPost = null;
              this.comments = [];
              this.commentContent = '';
            })

          // å¯¹è¯æ¡†å†…å®¹
        this.CommentDialog()
        }
        .width('100%')
        .height('100%')
      }

      // åˆ†äº«å¯¹è¯æ¡†
      if (this.showShareDialog) {
        Stack({ alignContent: Alignment.Bottom }) {
          // é®ç½©å±‚
          Row()
            .width('100%')
            .height('100%')
            .backgroundColor('#66000000')
            .onClick(() => {
              this.showShareDialog = false;
              this.sharePost = null;
            })

          // åˆ†äº«å¯¹è¯æ¡†å†…å®¹
          this.ShareDialog()
        }
        .width('100%')
        .height('100%')
      }

      if (this.posting) {
        this.PostingOverlay()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  // å¸–å­é¡¹ç»„ä»¶ - ä¼˜åŒ–å¸ƒå±€è®¾è®¡
  @Builder
  PostItem(post: Post) {
    Column({ space: 12 }) {
      // ç”¨æˆ·ä¿¡æ¯è¡Œ - å¤´åƒã€æ˜µç§°ã€æ—¶é—´
      Row({ space: 12 }) {
        // å¤´åƒ - æ·»åŠ æ¸å˜è¾¹æ¡†æ•ˆæœ
        Stack() {
          Column()
            .width(52)
            .height(52)
            .borderRadius(26)
            .linearGradient({
              angle: 45,
              colors: [['#667eea', 0], ['#764ba2', 0.5], ['#f093fb', 1]]
            })
          Image(this.normalizePostImagePath(post.avatar) || $r('app.media.ic_user_avatar'))
            .width(48)
            .height(48)
            .borderRadius(24)
            .objectFit(ImageFit.Cover)
            .backgroundColor('#FFFFFF')
        }

        // æ˜µç§°
        Column({ space: 4 }) {
          Text(post.username || 'ç¾é£Ÿè¾¾äºº')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1F1F1F')
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)

        // å…³æ³¨æŒ‰é’®
        Button(post.isFollowed ? 'å·²å…³æ³¨' : 'å…³æ³¨', { type: ButtonType.Normal, stateEffect: true })
          .fontSize(12)
          .fontColor(post.isFollowed ? '#999999' : '#007DFF')
          .backgroundColor(post.isFollowed ? '#F5F5F5' : '#E8F4FF')
          .borderRadius(14)
          .height(28)
          .padding({ left: 12, right: 12 })
          .onClick(() => {
            this.toggleFollow(post);
          })
      }
      .width('100%')
      .alignItems(VerticalAlign.Center)

      // å¸–å­å†…å®¹
      if (post.content) {
        Text(post.content)
          .fontSize(15)
          .fontColor('#333333')
          .textAlign(TextAlign.Start)
          .width('100%')
          .lineHeight(24)
          .maxLines(5)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
      }

      // å›¾ç‰‡ä¸è§†é¢‘å±•ç¤º
      if (post.images && post.images.length > 0) {
        this.PostImages(post.images)
      }

      if (post.videos && post.videos.length > 0) {
        this.PostVideos(post.videos)
      }

      // äº’åŠ¨æŒ‰é’®è¡Œ - ä¼˜åŒ–æ ·å¼
      Row() {
        // ç‚¹èµæŒ‰é’®
        Row({ space: 4 }) {
          Image(post.isLiked ? $r('app.media.like_filled') : $r('app.media.like'))
            .width(20)
            .height(20)
            .fillColor(post.isLiked ? '#FF3B30' : '#999')
          Text(post.likeCount > 0 ? post.likeCount.toString() : 'ç‚¹èµ')
            .fontSize(13)
            .fontColor(post.isLiked ? '#FF3B30' : '#999')
        }
        .height(36)
        .padding({ left: 12, right: 12 })
        .backgroundColor(post.isLiked ? '#FFF0F0' : '#F8F8F8')
        .borderRadius(18)
        .onClick(() => {
          this.toggleLike(post);
        })

        // è¯„è®ºæŒ‰é’®
        Row({ space: 4 }) {
          Image($r('app.media.comment'))
            .width(20)
            .height(20)
            .fillColor('#999')
          Text(post.commentCount > 0 ? post.commentCount.toString() : 'è¯„è®º')
            .fontSize(13)
            .fontColor('#999')
        }
        .height(36)
        .padding({ left: 12, right: 12 })
        .backgroundColor('#F8F8F8')
        .borderRadius(18)
        .margin({ left: 12 })
        .onClick(() => {
          this.showComments(post);
        })

        Blank()

        // åˆ†äº«æŒ‰é’®
        Row({ space: 4 }) {
          Image($r('app.media.share'))
            .width(18)
            .height(18)
            .fillColor('#999')
          Text('åˆ†äº«')
            .fontSize(13)
            .fontColor('#999')
        }
        .height(36)
        .padding({ left: 12, right: 12 })
        .backgroundColor('#F8F8F8')
        .borderRadius(18)
        .onClick(() => {
          this.showSharePostDialog(post);
        })
      }
      .width('100%')
      .height(44)
      .margin({ top: 8 })
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(20)
    .margin({ left: 12, right: 12, bottom: 12 })
    .shadow({
      radius: 12,
      color: '#08000000',
      offsetX: 0,
      offsetY: 4
    })
  }

  @Builder
  PostImages(images: string[]) {
    if (!images || images.length === 0) {
      Column() {};
    } else if (images.length === 1) {
      // å•å¼ å›¾ç‰‡ - è‡ªé€‚åº”é«˜åº¦ï¼Œè®¾ç½®æœ€å¤§é«˜åº¦é™åˆ¶
      Image(this.normalizePostImagePath(images[0]))
        .width('100%')
        .constraintSize({ maxHeight: 300 })
        .objectFit(ImageFit.Contain)
        .borderRadius(12)
        .backgroundColor('#F5F5F5')
    } else if (images.length === 2) {
      Row({ space: 8 }) {
        Image(this.normalizePostImagePath(images[0]))
          .layoutWeight(1)
          .aspectRatio(1)
          .objectFit(ImageFit.Cover)
          .borderRadius(12)
        Image(this.normalizePostImagePath(images[1]))
          .layoutWeight(1)
          .aspectRatio(1)
          .objectFit(ImageFit.Cover)
          .borderRadius(12)
      }
      .width('100%')
    } else if (images.length === 3) {
      Column({ space: 8 }) {
        Image(this.normalizePostImagePath(images[0]))
          .width('100%')
          .aspectRatio(1.5)
          .objectFit(ImageFit.Cover)
          .borderRadius(12)
        Row({ space: 8 }) {
          Image(this.normalizePostImagePath(images[1]))
            .layoutWeight(1)
            .aspectRatio(1)
            .objectFit(ImageFit.Cover)
            .borderRadius(12)
          Image(this.normalizePostImagePath(images[2]))
            .layoutWeight(1)
            .aspectRatio(1)
            .objectFit(ImageFit.Cover)
            .borderRadius(12)
        }
      }
      .width('100%')
    } else {
      // å¤šå›¾ä½¿ç”¨Flexå¸ƒå±€ï¼Œè‡ªé€‚åº”é«˜åº¦
      Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start }) {
        ForEach(images.slice(0, 9), (image: string, index: number) => {
          Stack({ alignContent: Alignment.Center }) {
            Image(this.normalizePostImagePath(image))
              .width('100%')
              .height('100%')
              .objectFit(ImageFit.Cover)
              .borderRadius(8)
            if (images.length > 9 && index === 8) {
              Text(`+${images.length - 9}`)
                .fontSize(16)
                .fontColor(Color.White)
                .fontWeight(FontWeight.Bold)
                .backgroundColor('#66000000')
                .width('100%')
                .height('100%')
                .textAlign(TextAlign.Center)
                .borderRadius(8)
            }
          }
          .width('31%')
          .aspectRatio(1)
          .margin({ right: index % 3 !== 2 ? '3.5%' : 0, bottom: 8 })
        }, (image: string, index: number) => `${image}-${index}`)
      }
      .width('100%')
    }
  }

  @Builder
  PostVideos(videos: string[]) {
    if (!videos || videos.length === 0) {
      Column() {};
    } else {
      Column({ space: 8 }) {
        ForEach(videos, (video: string, index: number) => {
          Stack({ alignContent: Alignment.Center }) {
            Video({ src: this.normalizePostImagePath(video), previewUri: '' })
              .width('100%')
              .aspectRatio(16/9)
              .controls(true)
              .autoPlay(false)
              .loop(false)
              .borderRadius(12)
              .objectFit(ImageFit.Cover)

            Text('è§†é¢‘')
              .fontSize(12)
              .fontColor(Color.White)
              .padding({ left: 10, right: 10, top: 4, bottom: 4 })
              .backgroundColor('#66000000')
              .borderRadius(12)
              .position({ x: 16, y: 16 })
          }
        }, (video: string, index: number) => `${video}-video-${index}`)
      }
      .width('100%')
    }
  }

  // å‘å¸ƒå¯¹è¯æ¡†ç»„ä»¶ - ä¿®å¤å‘å¸ƒæŒ‰é’®é—®é¢˜
  @Builder
  PostDialog() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Button('å–æ¶ˆ', { type: ButtonType.Normal, stateEffect: true })
          .fontSize(16)
          .fontColor('#666')
          .backgroundColor(Color.Transparent)
          .height(40)
          .onClick(() => {
            try {
            console.info('å–æ¶ˆæŒ‰é’®è¢«ç‚¹å‡»');
              if (!this.posting) {
            this.showPostDialog = false;
            this.resetNewPostForm();
              } else {
                ToastUtils.showToast('æ­£åœ¨å‘å¸ƒä¸­ï¼Œè¯·ç¨å€™...');
              }
            } catch (error) {
              console.error('å–æ¶ˆæŒ‰é’®å¼‚å¸¸: ' + JSON.stringify(error));
              this.showPostDialog = false;
            }
          })

        Text('å‘å¸ƒåŠ¨æ€')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        Button('å‘å¸ƒ', { type: ButtonType.Normal, stateEffect: true })
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor(this.canPublishPost() ? '#FFFFFF' : '#CCCCCC')
          .backgroundColor(this.canPublishPost() ? '#FF6B6B' : '#F0F0F0')
          .borderRadius(20)
          .height(36)
          .padding({ left: 20, right: 20 })
          .enabled(this.canPublishPost() && !this.posting)
          .onClick(() => {
            try {
              console.info('å‘å¸ƒè¯·æ±‚å¼€å§‹');
              // åŒé‡æ£€æŸ¥ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
              if (this.posting) {
                console.info('æ­£åœ¨å‘å¸ƒä¸­ï¼Œå¿½ç•¥é‡å¤ç‚¹å‡»');
                return;
              }
              // ç¡®ä¿è¡¨å•å·²åˆå§‹åŒ–
              this.ensurePostFormInitialized();
              // æ£€æŸ¥å†…å®¹æ˜¯å¦ä¸ºç©º
              const content = (this.newPost?.content || '').trim();
              if (!content) {
                ToastUtils.showToast('è¯·è¾“å…¥åŠ¨æ€å†…å®¹');
                return;
              }
              // è°ƒç”¨å‘å¸ƒæ–¹æ³•
              this.handlePublishPost();
            } catch (error) {
              console.error('å‘å¸ƒå¼‚å¸¸:', error);
              this.posting = false;
              ToastUtils.showToast('å‘å¸ƒå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
          })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 16, bottom: 12 })
      .alignItems(VerticalAlign.Center)

      // å†…å®¹è¾“å…¥åŒº
      TextArea({ placeholder: 'åˆ†äº«ä½ çš„ç¾é£Ÿä½“éªŒ...', text: this.postContent })
        .fontSize(16)
        .fontColor('#333')
        .backgroundColor(Color.Transparent)
        .width('100%')
        .height(120)
        .padding(16)
        .enabled(!this.posting)
        .onChange((value: string) => {
          this.postContent = value;
          this.ensurePostFormInitialized();
          if (this.newPost) {
            this.newPost.content = value;
          }
        })

      Row() {
        Text(`å·²é€‰ ${this.getCurrentMediaTotal()}/${this.maxMediaCount}`)
          .fontSize(13)
          .fontColor('#666')
          .layoutWeight(1)
        if (this.mediaProcessing) {
          Row() {
            LoadingProgress()
              .width(14)
              .height(14)
              .color('#007DFF')
            Text('å¤„ç†ä¸­...')
              .fontSize(12)
              .fontColor('#999')
              .margin({ left: 6 })
          }
        }
      }
      .width('100%')
      .padding({ left: 16, right: 16, bottom: 8 })

      if (this.buildSelectedMediaPreview().length > 0) {
        Scroll() {
          Row() {
            ForEach(this.buildSelectedMediaPreview(), (media: SelectedMediaPreview, index: number) => {
              Stack() {
                if (media.type === 'image') {
                  Image(this.normalizePostImagePath(media.path))
                    .width(88)
                    .height(88)
                    .objectFit(ImageFit.Cover)
                    .borderRadius(10)
                } else {
                  Stack({ alignContent: Alignment.Center }) {
                    Image($r('app.media.video'))
                      .width(88)
                      .height(88)
                      .objectFit(ImageFit.Contain)
                    Text('è§†é¢‘')
                      .fontSize(12)
                      .fontColor('#333')
                      .backgroundColor('#80FFFFFF')
                      .borderRadius(12)
                      .padding({ left: 8, right: 8, top: 2, bottom: 2 })
                  }
                  .backgroundColor('#F1F1F1')
                  .width(88)
                  .height(88)
                  .borderRadius(10)
                }

                Button({ type: ButtonType.Normal }) {
                  Image($r('app.media.delete'))
                    .width(16)
                    .height(16)
                    .fillColor(Color.White)
                }
                .width(24)
                .height(24)
                .backgroundColor('#CC000000')
                .borderRadius(12)
                .position({ x: 68, y: 4 })
                .onClick(() => {
                  this.removeMedia(media.type, media.index);
                })
              }
              .margin({ right: 12 })
            }, (media: SelectedMediaPreview, index: number) => media.key)
          }
          .padding({ left: 16, right: 16, bottom: 8 })
        }
        .scrollable(ScrollDirection.Horizontal)
      } else {
        Row() {
          Text('å¯æ·»åŠ å›¾ç‰‡æˆ–è§†é¢‘ï¼Œæ”¯æŒä»ç›¸å†Œ/ç›¸æœºè·å–ã€‚')
            .fontSize(13)
            .fontColor('#999')
        }
        .padding({ left: 16, right: 16, bottom: 8 })
      }

      // åˆ†éš”çº¿
      Divider()
        .color('#F0F0F0')
        .margin({ left: 16, right: 16, top: 8 })

      // æ“ä½œæŒ‰é’®æ  - ä¼˜åŒ–å¸ƒå±€
      Row({ space: 16 }) {
        // ç›¸å†Œå›¾ç‰‡æŒ‰é’®
        Column({ space: 4 }) {
          Button({ type: ButtonType.Circle, stateEffect: true }) {
            Image($r('app.media.image_gallery'))
              .width(24)
              .height(24)
              .fillColor('#007DFF')
          }
          .width(48)
          .height(48)
          .backgroundColor('#E8F4FF')
          .enabled(!this.posting)
          .onClick(() => {
            try {
              console.info('é€‰æ‹©ç›¸å†Œå›¾ç‰‡');
              this.safeOpenGallery('image');
            } catch (e) {
              console.error('é€‰æ‹©å›¾ç‰‡å¼‚å¸¸:' + JSON.stringify(e));
            }
          })
          Text('å›¾ç‰‡')
            .fontSize(12)
            .fontColor('#666')
        }
        .alignItems(HorizontalAlign.Center)

        // ç›¸å†Œè§†é¢‘æŒ‰é’®
        Column({ space: 4 }) {
          Button({ type: ButtonType.Circle, stateEffect: true }) {
            Image($r('app.media.video'))
              .width(24)
              .height(24)
              .fillColor('#FF6B00')
          }
          .width(48)
          .height(48)
          .backgroundColor('#FFF3E8')
          .enabled(!this.posting)
          .onClick(() => {
            try {
              console.info('é€‰æ‹©ç›¸å†Œè§†é¢‘');
              this.safeOpenGallery('video');
            } catch (e) {
              console.error('é€‰æ‹©è§†é¢‘å¼‚å¸¸:' + JSON.stringify(e));
            }
          })
          Text('è§†é¢‘')
            .fontSize(12)
            .fontColor('#666')
        }
        .alignItems(HorizontalAlign.Center)

        // æ‹æ‘„æŒ‰é’®
        Column({ space: 4 }) {
          Button({ type: ButtonType.Circle, stateEffect: true }) {
            Image($r('app.media.camera'))
              .width(24)
              .height(24)
              .fillColor('#34C759')
          }
          .width(48)
          .height(48)
          .backgroundColor('#E8F8EC')
          .enabled(!this.posting)
          .onClick(() => {
            try {
              console.info('æ‰“å¼€ç›¸æœº');
              this.safeCaptureFromCamera();
            } catch (e) {
              console.error('æ‹æ‘„å¼‚å¸¸:' + JSON.stringify(e));
            }
          })
          Text('æ‹æ‘„')
            .fontSize(12)
            .fontColor('#666')
        }
        .alignItems(HorizontalAlign.Center)
      }
      .width('100%')
      .justifyContent(FlexAlign.Center)
      .padding({ top: 20, bottom: 20 })
    }
    .width('100%')
    .layoutWeight(1)
  }



  // æ˜¾ç¤ºè¯„è®º
  async showComments(post: Post): Promise<void> {
    this.currentPost = post;
    this.showCommentDialog = true;
    this.commentContent = '';
    // æœ¬åœ°ç¤ºä¾‹å¸–ï¼ˆid < 0ï¼‰ä¸è¯·æ±‚åç«¯
    if (post.id < 0) {
      this.comments = [];
      return;
    }
    await this.loadComments(post.id);
  }

  // åŠ è½½è¯„è®ºåˆ—è¡¨
  async loadComments(postId: number): Promise<void> {
    if (postId < 0) {
      this.comments = [];
      return;
    }
    try {
      const response: ApiResponse = await ApiUtils.get(`/posts/comments?post_id=${postId}`);

      if (response.statusCode === 200 && response.data) {
        const data = response.data as CommentListResponse;
        this.comments = data.comments || [];
      } else {
        ToastUtils.showToast(response.message || 'åŠ è½½è¯„è®ºå¤±è´¥');
      }
    } catch (error) {
      console.error('åŠ è½½è¯„è®ºå¤±è´¥:' + JSON.stringify(error));
      ToastUtils.showToast('ç½‘ç»œå¼‚å¸¸ï¼Œè¯·é‡è¯•');
    }
  }

  // æ·»åŠ è¯„è®º
  async addComment(): Promise<void> {
    if (!this.currentPost) {
      return;
    }

    if (!this.commentContent.trim()) {
      ToastUtils.showToast('è¯·è¾“å…¥è¯„è®ºå†…å®¹');
      return;
    }
    // æœ¬åœ°ç¤ºä¾‹å¸–ï¼ˆid < 0ï¼‰ä¸æ”¯æŒè¯„è®º
    if (this.currentPost.id < 0) {
      ToastUtils.showToast('ç¤ºä¾‹å¸–å­ä»…ä¾›é¢„è§ˆï¼Œæ— æ³•è¯„è®º');
      return;
    }

    try {
      const commentData: CreateCommentRequest = {
        post_id: this.currentPost.id,
        content: this.commentContent.trim()
      };

      const response: ApiResponse = await ApiUtils.post('/posts/comments/create', commentData);

      if (response.statusCode === 200 && response.data) {
        const data = response.data as CreateCommentResponse;
        // æ›´æ–°å¸–å­è¯„è®ºæ•°
        const index: number = this.posts.findIndex((p: Post) => p.id === this.currentPost!.id);
        if (index !== -1) {
          this.posts[index].commentCount = data.comment_count;
        }
        // é‡æ–°åŠ è½½è¯„è®ºåˆ—è¡¨
        await this.loadComments(this.currentPost.id);
        // æ¸…ç©ºè¾“å…¥æ¡†
        this.commentContent = '';
        ToastUtils.showToast('è¯„è®ºæˆåŠŸ');
      } else {
        ToastUtils.showToast(response.message || 'è¯„è®ºå¤±è´¥');
      }
    } catch (error) {
      console.error('æ·»åŠ è¯„è®ºå¤±è´¥:' + JSON.stringify(error));
      ToastUtils.showToast('è¯„è®ºå¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }

  // æ˜¾ç¤ºåˆ†äº«å¯¹è¯æ¡†
  async showSharePostDialog(post: Post): Promise<void> {
    this.sharePost = post;
    this.showShareDialog = true;
    await this.loadShareFriends();
  }

  // åŠ è½½å¥½å‹åˆ—è¡¨
  async loadShareFriends(): Promise<void> {
    this.shareLoading = true;
    try {
      const response: ApiResponse = await ApiUtils.get('/messages/conversations');
      if (response.statusCode === 200 && response.data) {
        const data = response.data as ConversationListResponseData;
        const conversations: ConversationItemData[] = data.conversations || [];
        this.shareFriends = conversations.map((conv: ConversationItemData) => {
          return {
            id: conv.userId || 0,
            conversationId: conv.conversationId || conv.id || 0,
            username: conv.username || '',
            avatar: conv.avatar || ''
          } as ShareFriend;
        });
        // å¦‚æœæ²¡æœ‰çœŸå®å¥½å‹ï¼Œä½¿ç”¨æœ¬åœ°ç¤ºä¾‹
        if (this.shareFriends.length === 0) {
          this.shareFriends = this.createLocalShareFriends();
        }
      } else {
        this.shareFriends = this.createLocalShareFriends();
      }
    } catch (error) {
      console.error('åŠ è½½å¥½å‹åˆ—è¡¨å¤±è´¥:' + JSON.stringify(error));
      this.shareFriends = this.createLocalShareFriends();
    } finally {
      this.shareLoading = false;
    }
  }

  // æœ¬åœ°ç¤ºä¾‹å¥½å‹
  private createLocalShareFriends(): ShareFriend[] {
    return [
      { id: 501, conversationId: 1001, username: 'å¨å¸ˆ', avatar: 'app.media.avatar1' },
      { id: 502, conversationId: 1002, username: 'å®¢æœ', avatar: 'app.media.avatar2' },
      { id: 503, conversationId: 1003, username: 'ç”¨æˆ·', avatar: 'app.media.avatar3' }
    ];
  }

  // åˆ†äº«ç»™å¥½å‹
  async shareToFriend(friend: ShareFriend): Promise<void> {
    if (!this.sharePost) return;

    try {
      const shareContent = `ã€åˆ†äº«å¸–å­ã€‘\n${this.sharePost.username}ï¼š${this.sharePost.content.substring(0, 100)}${this.sharePost.content.length > 100 ? '...' : ''}`;

      const request: SendMessageRequest = {
        conversation_id: friend.conversationId,
        content: shareContent,
        type: 'text'
      };

      const response: ApiResponse = await ApiUtils.post('/messages/send', request);

      if (response.statusCode === 200) {
        ToastUtils.showToast(`å·²åˆ†äº«ç»™ ${friend.username}`);
        this.showShareDialog = false;
        this.sharePost = null;
      } else {
        // å¯¹äºæœ¬åœ°ç¤ºä¾‹å¯¹è¯ï¼Œä¹Ÿæç¤ºæˆåŠŸ
        if (friend.conversationId >= 1001 && friend.conversationId <= 1003) {
          ToastUtils.showToast(`å·²åˆ†äº«ç»™ ${friend.username}`);
          this.showShareDialog = false;
          this.sharePost = null;
        } else {
          ToastUtils.showToast(response.message || 'åˆ†äº«å¤±è´¥');
        }
      }
    } catch (error) {
      console.error('åˆ†äº«å¤±è´¥:' + JSON.stringify(error));
      // å¯¹äºæœ¬åœ°ç¤ºä¾‹å¯¹è¯ï¼Œå³ä½¿ç½‘ç»œå¤±è´¥ä¹Ÿæç¤ºæˆåŠŸ
      if (friend.conversationId >= 1001 && friend.conversationId <= 1003) {
        ToastUtils.showToast(`å·²åˆ†äº«ç»™ ${friend.username}`);
        this.showShareDialog = false;
        this.sharePost = null;
      } else {
        ToastUtils.showToast('åˆ†äº«å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }
  }

  // è¯„è®ºå¯¹è¯æ¡†ç»„ä»¶
  @Builder
  CommentDialog() {
    Column() {
      // æ ‡é¢˜æ  - ç¾åŒ–æ ·å¼
      Row() {
        Button('å…³é—­', { type: ButtonType.Normal, stateEffect: true })
          .fontSize(15)
          .fontColor('#666666')
          .backgroundColor(Color.Transparent)
          .height(36)
          .onClick(() => {
            this.showCommentDialog = false;
            this.currentPost = null;
            this.comments = [];
            this.commentContent = '';
          })

        Row({ space: 6 }) {
          Text('ğŸ’¬')
            .fontSize(18)
          Text('è¯„è®º')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1A1A1A')
        }
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)

        // å ä½ï¼Œä¿æŒæ ‡é¢˜å±…ä¸­
        Column()
          .width(50)
      }
      .width('100%')
      .padding({ left: 12, right: 12, top: 16, bottom: 12 })

      // è¯„è®ºæ•°é‡
      Row() {
        Text(`å…± ${this.comments.length} æ¡è¯„è®º`)
          .fontSize(13)
          .fontColor('#888888')
      }
      .width('100%')
      .padding({ left: 20, right: 20, bottom: 8 })

      Divider()
        .strokeWidth(0.5)
        .color('#F0F0F0')

      // è¯„è®ºåˆ—è¡¨
      Scroll() {
        Column() {
          if (this.comments.length === 0) {
            Column({ space: 12 }) {
              Text('ğŸ’­')
                .fontSize(48)
              Text('æš‚æ— è¯„è®º')
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .fontColor('#666666')
              Text('å¿«æ¥æŠ¢æ²™å‘å§~')
                .fontSize(14)
                .fontColor('#999999')
            }
            .width('100%')
            .padding({ top: 60, bottom: 60 })
            .alignItems(HorizontalAlign.Center)
          } else {
            ForEach(this.comments, (comment: Comment, index: number) => {
              this.CommentItem(comment, index)
            }, (comment: Comment) => comment.id.toString())
          }
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 8 })
      }
      .layoutWeight(1)
      .scrollable(ScrollDirection.Vertical)
      .scrollBar(BarState.Off)

      // è¯„è®ºè¾“å…¥åŒº - ç¾åŒ–æ ·å¼
      Row({ space: 12 }) {
        Row() {
          TextArea({ placeholder: 'å†™ä¸‹ä½ çš„è¯„è®º...', text: this.commentContent })
            .fontSize(15)
            .fontColor('#333333')
            .backgroundColor(Color.Transparent)
            .layoutWeight(1)
            .height(40)
            .padding({ left: 4, right: 4 })
            .onChange((value: string) => {
              this.commentContent = value;
            })
        }
        .layoutWeight(1)
        .height(44)
        .padding({ left: 16, right: 16 })
        .backgroundColor('#F5F7FA')
        .borderRadius(22)

        Button('å‘é€', { type: ButtonType.Normal, stateEffect: true })
          .fontSize(15)
          .fontWeight(FontWeight.Medium)
          .fontColor('#FFFFFF')
          .backgroundColor(this.commentContent.trim() ? '#007DFF' : '#CCCCCC')
          .borderRadius(20)
          .height(40)
          .padding({ left: 20, right: 20 })
          .enabled(!!this.commentContent.trim())
          .onClick(() => {
            this.addComment();
          })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 16 })
      .backgroundColor('#FFFFFF')
      .shadow({
        radius: 8,
        color: 'rgba(0,0,0,0.05)',
        offsetX: 0,
        offsetY: -2
      })
    }
    .width('100%')
    .height('75%')
    .backgroundColor('#FFFFFF')
    .borderRadius({ topLeft: 24, topRight: 24 })
    .position({ x: 0, y: '25%' })
    .shadow({
      radius: 30,
      color: 'rgba(0,0,0,0.2)',
      offsetX: 0,
      offsetY: -10
    })
  }

  // è¯„è®ºé¡¹ç»„ä»¶ - ç¾åŒ–æ ·å¼
  @Builder
  CommentItem(comment: Comment, index: number) {
    Row({ space: 12 }) {
      // å¤´åƒ
      Stack() {
        Image(comment.avatar || $r('app.media.ic_user_avatar'))
          .width(40)
          .height(40)
          .borderRadius(20)
          .objectFit(ImageFit.Cover)
      }

      Column({ space: 6 }) {
        // ç”¨æˆ·åå’Œæ—¶é—´
        Row() {
          Text(comment.username)
            .fontSize(14)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1A1A1A')

          if (index === 0) {
            Text('æ²™å‘')
              .fontSize(10)
              .fontColor('#FFFFFF')
              .backgroundColor('#FF9500')
              .borderRadius(8)
              .padding({ left: 6, right: 6, top: 2, bottom: 2 })
              .margin({ left: 8 })
          }
        }

        // è¯„è®ºå†…å®¹
        Text(comment.content)
          .fontSize(15)
          .fontColor('#333333')
          .width('100%')
          .lineHeight(22)
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
    }
    .width('100%')
    .alignItems(VerticalAlign.Top)
    .padding(14)
    .margin({ bottom: 8 })
    .backgroundColor('#FAFAFA')
    .borderRadius(14)
  }

  // åˆ†äº«å¯¹è¯æ¡†ç»„ä»¶ - ç¾åŒ–æ ·å¼
  @Builder
  ShareDialog() {
    Column() {
      // é¡¶éƒ¨æ‹–åŠ¨æ¡
      Column()
        .width(40)
        .height(4)
        .borderRadius(2)
        .backgroundColor('#E0E0E0')
        .margin({ top: 12, bottom: 8 })

      // æ ‡é¢˜æ 
      Row() {
        Column()
          .width(40)

        Row({ space: 6 }) {
          Text('ğŸ“¤')
            .fontSize(18)
          Text('åˆ†äº«ç»™å¥½å‹')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1A1A1A')
        }
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)

        Button({ type: ButtonType.Circle, stateEffect: true }) {
          Text('Ã—')
            .fontSize(20)
            .fontColor('#666666')
        }
        .width(36)
        .height(36)
        .backgroundColor('#F5F5F5')
        .onClick(() => {
          this.showShareDialog = false;
          this.sharePost = null;
        })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 8, bottom: 16 })

      // åˆ†äº«å†…å®¹é¢„è§ˆ
      if (this.sharePost) {
        Row({ space: 12 }) {
          Column({ space: 6 }) {
            Row({ space: 6 }) {
              Text('æ¥è‡ª')
                .fontSize(12)
                .fontColor('#888888')
              Text(this.sharePost.username)
                .fontSize(13)
                .fontWeight(FontWeight.Medium)
                .fontColor('#1A1A1A')
            }
            Text(this.sharePost.content)
              .fontSize(14)
              .fontColor('#333333')
              .maxLines(2)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .lineHeight(20)
          }
          .alignItems(HorizontalAlign.Start)
          .layoutWeight(1)

          if (this.sharePost.images && this.sharePost.images.length > 0) {
            Image(this.normalizePostImagePath(this.sharePost.images[0]))
              .width(60)
              .height(60)
              .borderRadius(10)
              .objectFit(ImageFit.Cover)
          }
        }
        .width('100%')
        .padding(14)
        .backgroundColor('#F8F9FA')
        .borderRadius(14)
        .margin({ left: 16, right: 16, bottom: 16 })
      }

      Divider()
        .strokeWidth(0.5)
        .color('#F0F0F0')

      // å¥½å‹åˆ—è¡¨æ ‡é¢˜
      Row() {
        Text('é€‰æ‹©å¥½å‹')
          .fontSize(14)
          .fontColor('#888888')
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 12, bottom: 8 })

      // å¥½å‹åˆ—è¡¨
      if (this.shareLoading) {
        Column({ space: 12 }) {
          LoadingProgress()
            .width(36)
            .height(36)
            .color('#007DFF')
          Text('åŠ è½½ä¸­...')
            .fontSize(14)
            .fontColor('#888888')
        }
        .width('100%')
        .padding({ top: 40, bottom: 40 })
        .alignItems(HorizontalAlign.Center)
      } else if (this.shareFriends.length === 0) {
        Column({ space: 12 }) {
          Text('ğŸ‘¥')
            .fontSize(48)
          Text('æš‚æ— å¥½å‹')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#666666')
          Text('å…³æ³¨æ›´å¤šç”¨æˆ·æ¥æ·»åŠ å¥½å‹å§')
            .fontSize(14)
            .fontColor('#999999')
        }
        .width('100%')
        .padding({ top: 40, bottom: 40 })
        .alignItems(HorizontalAlign.Center)
      } else {
        List() {
          ForEach(this.shareFriends, (friend: ShareFriend) => {
            ListItem() {
              Row({ space: 12 }) {
                // å¤´åƒ
                Image(friend.avatar.startsWith('app.media.')
                  ? $r(friend.avatar)
                  : (friend.avatar || $r('app.media.ic_user_avatar')))
                  .width(48)
                  .height(48)
                  .borderRadius(24)
                  .objectFit(ImageFit.Cover)
                  .border({ width: 2, color: '#F0F0F0' })

                // ç”¨æˆ·å
                Text(friend.username)
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#1A1A1A')
                  .layoutWeight(1)

                // å‘é€æŒ‰é’®
                Button('å‘é€', { type: ButtonType.Normal, stateEffect: true })
                  .fontSize(14)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#FFFFFF')
                  .backgroundColor('#007DFF')
                  .borderRadius(18)
                  .height(36)
                  .padding({ left: 20, right: 20 })
                  .onClick(() => {
                    this.shareToFriend(friend);
                  })
              }
              .width('100%')
              .padding({ left: 16, right: 16, top: 10, bottom: 10 })
            }
          }, (friend: ShareFriend) => friend.id.toString())
        }
        .layoutWeight(1)
        .width('100%')
        .divider({
          strokeWidth: 0.5,
          color: '#F5F5F5',
          startMargin: 76,
          endMargin: 16
        })
      }
    }
    .width('100%')
    .height('65%')
    .backgroundColor('#FFFFFF')
    .borderRadius({ topLeft: 24, topRight: 24 })
    .position({ x: 0, y: '35%' })
    .shadow({
      radius: 30,
      color: 'rgba(0,0,0,0.2)',
      offsetX: 0,
      offsetY: -10
    })
  }

  private getSampleShowcasePosts(): Post[] {
    return this.createLocalSamplePosts().slice(0, 3);
  }

  private canPublishPost(): boolean {
    try {
      if (this.posting) {
        return false;
      }
      return this.postContent.trim().length > 0;
    } catch (error) {
      console.error('canPublishPostå¼‚å¸¸: ' + JSON.stringify(error));
      return false;
    }
  }

  private createLocalSamplePosts(): Post[] {
    const now: number = Date.now();
    const samples: SamplePostData[] = [
      {
        id: -101,
        username: 'ç¾é£Ÿè¾¾äººé˜¿ä¹',
        avatar: 'app.media.avatar1',
        content: 'åˆšæ¨å‡ºçš„å®«ä¿é¸¡ä¸è¶…å—æ¬¢è¿ï¼èŠ±ç”Ÿé…¥è„†ã€é¸¡è‚‰é²œå«©ï¼Œä¸€å£ä¸‹å»æ»¡æ»¡çš„å¹¸ç¦æ„Ÿï½é…ä¸Šç±³é¥­ç®€ç›´æ˜¯ç»é…ï¼',
        images: ['app.media.dish1'],
        videos: [],
        likeCount: 128,
        commentCount: 23,
        createTimeOffsetMinutes: 12
      },
      {
        id: -102,
        username: 'ä»Šæ—¥å°å¨',
        avatar: 'app.media.avatar2',
        content: 'éº»å©†è±†è…ä¸Šçº¿å•¦ï¼ç§˜åˆ¶è±†ç“£é…±è°ƒå‘³ï¼Œåƒä¸€å£å°±åœä¸ä¸‹æ¥ã€‚è°æ„¿æ„å’Œæˆ‘ä¸€èµ·åŠ ä¸ªè›‹é»„ï¼Ÿ',
        images: ['app.media.dish2', 'app.media.dish4'],
        videos: [],
        likeCount: 86,
        commentCount: 17,
        createTimeOffsetMinutes: 35
      },
      {
        id: -103,
        username: 'ç”œå’¸å…šä»£è¡¨',
        avatar: 'app.media.avatar3',
        content: 'ç³–é†‹é‡Œè„Šæ˜¯ç”œå£å…šçš„å¿«ä¹æºæ³‰ï¼é…¸é…¸ç”œç”œè¶…çº§å¼€èƒƒï¼Œä»Šå¤©çš„åˆé¥­åˆè¢«æ²»æ„ˆäº†ï½æ¨èå¤§å®¶è¯•è¯•ï¼',
        images: ['app.media.dish3'],
        videos: [],
        likeCount: 204,
        commentCount: 31,
        createTimeOffsetMinutes: 58
      },
      {
        id: -104,
        username: 'å¥åº·åƒè´§',
        avatar: 'app.media.avatar',
        content: 'æ¸…è’¸é²ˆé±¼æ¥äº†ï¼å°‘æ²¹å°‘ç›ä¿ç•™åŸæ±åŸå‘³ï¼Œè‚‰è´¨ç»†å«©ï¼Œå¼ºçƒˆæ¨èç»™æ­£åœ¨å¥èº«çš„æœ‹å‹ä»¬ã€‚',
        images: ['app.media.dish5'],
        videos: [],
        likeCount: 64,
        commentCount: 9,
        createTimeOffsetMinutes: 90
      },
      {
        id: -105,
        username: 'ç¾é£Ÿæ¢ç´¢å®¶',
        avatar: 'app.media.avatar1',
        content: 'ä»Šå¤©å°è¯•äº†æ–°çš„å·èœï¼Œæ°´ç…®é±¼ç‰‡éº»è¾£é²œé¦™ï¼Œé…ä¸Šä¸€ç¢—ç™½ç±³é¥­ï¼Œç®€ç›´æ˜¯äººé—´ç¾å‘³ï¼',
        images: ['app.media.dish1', 'app.media.dish2'],
        videos: [],
        likeCount: 156,
        commentCount: 28,
        createTimeOffsetMinutes: 120
      },
      {
        id: -106,
        username: 'æ–™ç†å°èƒ½æ‰‹',
        avatar: 'app.media.avatar2',
        content: 'è‡ªå·±åšçš„çº¢çƒ§è‚‰ï¼Œè‚¥è€Œä¸è…»ï¼Œå…¥å£å³åŒ–ã€‚åˆ†äº«ç»™å¤§å®¶ï¼Œå¸Œæœ›ä½ ä»¬ä¹Ÿèƒ½åšå‡ºç¾å‘³çš„å®¶å¸¸èœï¼',
        images: ['app.media.dish3', 'app.media.dish4', 'app.media.dish5'],
        videos: [],
        likeCount: 189,
        commentCount: 42,
        createTimeOffsetMinutes: 150
      }
    ];

    return samples.map((sample: SamplePostData) => {
      const post = new Post();
      post.id = sample.id;
      post.username = sample.username;
      post.avatar = sample.avatar;
      post.content = sample.content;
      post.images = sample.images ? sample.images : [];
      post.videos = sample.videos ? sample.videos : [];
      post.likeCount = sample.likeCount;
      post.commentCount = sample.commentCount;
      post.isLiked = false;
      post.createTime = now - sample.createTimeOffsetMinutes * 60 * 1000;
      return post;
    });
  }
}