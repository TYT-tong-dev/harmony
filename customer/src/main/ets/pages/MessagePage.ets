// MessagePage.ets
import { Message, ChatMessage, UserInfo, ConversationListResponse, MessageListResponse, SendMessageRequest, CreateConversationRequest, UserSearchResponse, ConversationListResponseData, ConversationItemData, MessageListResponseData, ChatMessageItemData, SendMessageResponseData, NotificationListResponse, NotificationType, AppNotification } from '../common/Types';
import { ApiUtils, ToastUtils } from '../common/Utils';
import { NotificationUtils, NotificationData, NotificationExtraData } from '../common/NotificationUtils';
import { ApiResponse } from '../common/Types';
import router from '@ohos.router';
import picker from '@ohos.file.picker';
import media from '@ohos.multimedia.media';
import abilityAccessCtrl from '@ohos.abilityAccessCtrl';
import common from '@ohos.app.ability.common';
import fs from '@ohos.file.fs';
import { BusinessError } from '@kit.BasicServicesKit';

type MediaPermissionName =
  | 'ohos.permission.READ_MEDIA'
  | 'ohos.permission.WRITE_MEDIA'
  | 'ohos.permission.READ_IMAGEVIDEO'
  | 'ohos.permission.WRITE_IMAGEVIDEO'
  | 'ohos.permission.CAMERA';

interface PermissionRequestResult {
  permissions: MediaPermissionName[];
  authResults: number[];
}

@Entry
@Component
export struct MessagePage {
  @State messages: Message[] = [];
  @State selectedChat: Message | null = null;
  @State chatInput: string = '';
  @State showAddUserDialog: boolean = false;
  @State searchKeyword: string = '';
  @State searchUsers: UserInfo[] = [];
  @State loading: boolean = false;
  @State recording: boolean = false;
  @State recordingDuration: number = 0; // å½•éŸ³æ—¶é•¿ï¼ˆç§’ï¼‰

  private context?: common.UIAbilityContext;
  private atManager?: abilityAccessCtrl.AtManager;
  private mediaPermissionsGranted: boolean = false;
  private audioRecorder?: media.AudioRecorder;
  private audioPlayer?: media.AudioPlayer;
  private recordingTimer?: number;
  private recordingStartTime: number = 0;
  private recordingFilePath: string = '';
  private readonly mediaPermissions: MediaPermissionName[] = [
    'ohos.permission.READ_MEDIA',
    'ohos.permission.WRITE_MEDIA',
    'ohos.permission.READ_IMAGEVIDEO',
    'ohos.permission.WRITE_IMAGEVIDEO',
    'ohos.permission.CAMERA'
  ];

  // æ¶ˆæ¯è½®è¯¢å®šæ—¶å™¨
  private messagePollingTimer: number = -1;
  private readonly POLLING_INTERVAL: number = 5000; // 5ç§’è½®è¯¢ä¸€æ¬¡

  // é€šçŸ¥ç›¸å…³
  private lastMessageNotificationId: number = 0;
  @State unreadMessageCount: number = 0;

  aboutToAppear() {
    const token: string = (AppStorage.get('userToken') as string) || '';
    if (!token) {
      ToastUtils.showToast('è¯·å…ˆç™»å½•');
      router.replaceUrl({ url: 'pages/LoginPage' });
      return;
    }
    try {
      this.context = getContext(this) as common.UIAbilityContext;
      this.atManager = abilityAccessCtrl.createAtManager();
    } catch (error) {
      console.error('åˆå§‹åŒ–é¡µé¢ä¸Šä¸‹æ–‡å¤±è´¥:' + JSON.stringify(error));
    }
    this.loadMessages();
    // å¯åŠ¨æ¶ˆæ¯è½®è¯¢
    this.startMessagePolling();
    // æ£€æŸ¥æ¶ˆæ¯é€šçŸ¥æƒé™
    this.checkNotificationPermission();
  }

  // æ£€æŸ¥é€šçŸ¥æƒé™
  private async checkNotificationPermission(): Promise<void> {
    try {
      await NotificationUtils.requestPermission();
    } catch (error) {
      console.error('æ£€æŸ¥é€šçŸ¥æƒé™å¤±è´¥:' + JSON.stringify(error));
    }
  }

  aboutToDisappear() {
    // æ¸…ç†è½®è¯¢å®šæ—¶å™¨
    this.stopMessagePolling();
    
    // æ¸…ç†å½•éŸ³èµ„æº
    if (this.recording && this.audioRecorder) {
      try {
        this.audioRecorder.stop();
        this.audioRecorder.release();
      } catch (error) {
        console.error('åœæ­¢å½•éŸ³å¤±è´¥:', JSON.stringify(error));
      }
    }
    
    // æ¸…ç†æ’­æ”¾èµ„æº
    if (this.audioPlayer) {
      try {
        this.audioPlayer.stop();
        this.audioPlayer.release();
      } catch (error) {
        console.error('åœæ­¢æ’­æ”¾å¤±è´¥:', JSON.stringify(error));
      }
    }
    
    // æ¸…ç†å½•éŸ³è®¡æ—¶å™¨
    if (this.recordingTimer) {
      clearInterval(this.recordingTimer);
      this.recordingTimer = undefined;
    }
  }

  // å¯åŠ¨æ¶ˆæ¯è½®è¯¢
  private startMessagePolling(): void {
    this.stopMessagePolling(); // å…ˆæ¸…ç†å·²æœ‰å®šæ—¶å™¨
    this.messagePollingTimer = setInterval(() => {
      this.pollMessages();
    }, this.POLLING_INTERVAL);
  }

  // åœæ­¢æ¶ˆæ¯è½®è¯¢
  private stopMessagePolling(): void {
    if (this.messagePollingTimer !== -1) {
      clearInterval(this.messagePollingTimer);
      this.messagePollingTimer = -1;
    }
  }

  // è½®è¯¢è·å–æ–°æ¶ˆæ¯
  private async pollMessages(): Promise<void> {
    try {
      // å¦‚æœåœ¨èŠå¤©è¯¦æƒ…é¡µï¼Œåˆ·æ–°å½“å‰å¯¹è¯çš„æ¶ˆæ¯
      if (this.selectedChat) {
        await this.loadChatMessagesQuietly(this.selectedChat.conversationId);
      } else {
        // åœ¨ä¼šè¯åˆ—è¡¨é¡µï¼Œåˆ·æ–°ä¼šè¯åˆ—è¡¨
        await this.loadMessagesQuietly();
      }
      // æ£€æŸ¥æ¶ˆæ¯é€šçŸ¥
      await this.checkMessageNotifications();
    } catch (error) {
      console.error('è½®è¯¢æ¶ˆæ¯å¤±è´¥:', JSON.stringify(error));
    }
  }

  // æ£€æŸ¥æ¶ˆæ¯é€šçŸ¥
  private async checkMessageNotifications(): Promise<void> {
    try {
      const response: ApiResponse = await ApiUtils.get('/notifications/list?unread_only=true&limit=10');
      if (response.statusCode === 200 && response.data) {
        const data = response.data as NotificationListResponse;
        this.unreadMessageCount = data.unread_count;

        // æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ¶ˆæ¯é€šçŸ¥
        if (data.notifications && data.notifications.length > 0) {
          for (const notification of data.notifications) {
            // åªå¤„ç†æ¶ˆæ¯ç±»å‹ä¸”æ¯”ä¸Šæ¬¡æ›´æ–°çš„é€šçŸ¥
            if (notification.type === 'message' && notification.id > this.lastMessageNotificationId) {
              // å‘é€æœ¬åœ°é€šçŸ¥
              const notificationData = new NotificationData(
                notification.id,
                NotificationType.MESSAGE,
                notification.title,
                notification.content
              );
              const extra = new NotificationExtraData();
              extra.conversationId = notification.related_id?.toString() || '';
              notificationData.extra = extra;
              await NotificationUtils.sendNotification(notificationData);
            }
          }
          // æ›´æ–°æœ€åä¸€æ¡é€šçŸ¥ID
          const messageNotifications = data.notifications.filter((n: AppNotification) => n.type === 'message');
          if (messageNotifications.length > 0) {
            let maxId = 0;
            for (const n of messageNotifications) {
              if (n.id > maxId) {
                maxId = n.id;
              }
            }
            this.lastMessageNotificationId = maxId;
          }
        }
      }
    } catch (error) {
      console.error('æ£€æŸ¥æ¶ˆæ¯é€šçŸ¥å¤±è´¥:' + JSON.stringify(error));
    }
  }

  // é™é»˜åŠ è½½æ¶ˆæ¯åˆ—è¡¨ï¼ˆä¸æ˜¾ç¤ºloadingçŠ¶æ€ï¼‰
  private async loadMessagesQuietly(): Promise<void> {
    try {
      const response: ApiResponse = await ApiUtils.get('/messages/conversations');
      if (response.statusCode === 200 && response.data) {
        const data = response.data as ConversationListResponseData;
        const conversations: ConversationItemData[] = data.conversations || [];
        this.messages = conversations.map((conv: ConversationItemData) => {
          const message = new Message();
          message.id = conv.conversationId || conv.id || 0;
          message.conversationId = conv.conversationId || conv.id || 0;
          message.userId = conv.userId || 0;
          message.username = conv.username || '';
          message.avatar = conv.avatar || '';
          message.lastContent = conv.lastContent || '';
          message.lastTime = conv.lastTime || 0;
          message.unreadCount = conv.unreadCount || 0;
          message.isOnline = conv.isOnline || false;
          message.messages = [];
          return message;
        });
      }
    } catch (error) {
      console.error('é™é»˜åŠ è½½æ¶ˆæ¯åˆ—è¡¨å¤±è´¥:', JSON.stringify(error));
    }
  }

  // é™é»˜åŠ è½½èŠå¤©æ¶ˆæ¯ï¼ˆä¸æ˜¾ç¤ºloadingçŠ¶æ€ï¼‰
  private async loadChatMessagesQuietly(conversationId: number): Promise<void> {
    if (!this.selectedChat) return;
    try {
      const response: ApiResponse = await ApiUtils.get(`/messages/list?conversation_id=${conversationId}`);
      if (response.statusCode === 200 && response.data) {
        const data = response.data as MessageListResponseData;
        const messages: ChatMessageItemData[] = data.messages || [];
        const newMessages: ChatMessage[] = messages.map((msg: ChatMessageItemData) => {
          const chatMessage = new ChatMessage();
          chatMessage.id = msg.id || 0;
          chatMessage.content = msg.content || '';
          chatMessage.time = msg.time || 0;
          chatMessage.isMe = msg.isMe || false;
          chatMessage.type = msg.type || 'text';
          chatMessage.imageUrl = msg.imageUrl || '';
          chatMessage.videoUrl = msg.videoUrl || '';
          chatMessage.voiceUrl = msg.voiceUrl || '';
          chatMessage.voiceDuration = msg.voiceDuration || 0;
          return chatMessage;
        });

        // åªæœ‰åœ¨æœ‰æ–°æ¶ˆæ¯æ—¶æ‰æ›´æ–°
        if (newMessages.length > (this.selectedChat.messages?.length || 0)) {
          this.selectedChat.messages = newMessages;
        }
      }
    } catch (error) {
      console.error('é™é»˜åŠ è½½èŠå¤©æ¶ˆæ¯å¤±è´¥:', JSON.stringify(error));
    }
  }

  build() {
    Stack() {
      Column() {
        if (this.selectedChat) {
          this.ChatDetail()
        } else {
          this.ChatList()
        }
      }
      .width('100%')
      .height('100%')

      // å›¾ç‰‡é¢„è§ˆå¯¹è¯æ¡†
      if (this.showImagePreview) {
        this.ImagePreviewDialog()
      }

      // è§†é¢‘é¢„è§ˆå¯¹è¯æ¡†
      if (this.showVideoPreview) {
        this.VideoPreviewDialog()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  @Builder
  ChatList() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('æ¶ˆæ¯')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
          .layoutWeight(1)

        // é€šçŸ¥å…¥å£ï¼ˆå¸¦çº¢ç‚¹ï¼‰
        Stack() {
          Image($r('app.media.message'))
            .width(24)
            .height(24)
            .onClick(() => {
              router.pushUrl({ url: 'pages/NotificationPage' });
            })

          // æœªè¯»çº¢ç‚¹
          if (this.unreadMessageCount > 0) {
            Text(this.unreadMessageCount > 99 ? '99+' : this.unreadMessageCount.toString())
              .fontSize(10)
              .fontColor(Color.White)
              .backgroundColor('#FF3B30')
              .borderRadius(8)
              .padding({ left: 4, right: 4, top: 1, bottom: 1 })
              .position({ x: 14, y: -4 })
          }
        }
        .margin({ right: 12 })

        Button('æ·»åŠ æœ‹å‹', { type: ButtonType.Normal })
          .fontSize(14)
          .fontColor('#007DFF')
          .fontWeight(FontWeight.Medium)
          .backgroundColor(Color.Transparent)
          .borderColor(Color.Transparent)
          .padding({ left: 8, right: 8 })
          .onClick(() => {
            this.showAddUserDialog = true;
          })
      }
      .padding(16)
      .backgroundColor('#FFFFFF')
      .width('100%')

      // æ¶ˆæ¯åˆ—è¡¨
      if (this.messages.length === 0 && !this.loading) {
        Column() {
          Text('æš‚æ— æ¶ˆæ¯')
            .fontSize(14)
            .fontColor('#999')
            .textAlign(TextAlign.Center)
            .width('100%')
            .padding(16)
        }
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      } else {
      List() {
        ForEach(this.messages, (message: Message) => {
          ListItem() {
            this.MessageItem(message)
          }
        }, (message: Message) => message.id.toString())
      }
      .layoutWeight(1)
      .width('100%')
      }

      // æ·»åŠ ç”¨æˆ·å¯¹è¯æ¡†
      if (this.showAddUserDialog) {
        this.AddUserDialog()
      }
    }
  }

  @Builder
  MessageItem(message: Message) {
    Row() {
      // å¤´åƒå’Œåœ¨çº¿çŠ¶æ€
      Stack() {
        if (message.avatar && message.avatar.startsWith('app.media.avatar')) {
          Image($r(message.avatar))
            .width(48)
            .height(48)
            .borderRadius(24)
        } else if (message.avatar) {
          Image(message.avatar)
            .width(48)
            .height(48)
            .borderRadius(24)
        } else {
          Image($r('app.media.ic_user_avatar'))
            .width(48)
            .height(48)
            .borderRadius(24)
        }

        if (message.isOnline) {
          Circle()
            .width(12)
            .height(12)
            .fill('#52C41A')
            .position({ x: 36, y: 36 })
        }
      }

      Column() {
        Text(message.username)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')

        Text(message.lastContent)
          .fontSize(14)
          .fontColor('#666666')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .margin({ top: 4 })
          .width('100%')
      }
      .margin({ left: 12 })
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)

      // æœªè¯»æ¶ˆæ¯æ•°
      if (message.unreadCount > 0) {
        Text(message.unreadCount > 99 ? '99+' : message.unreadCount.toString())
          .fontSize(10)
          .fontColor('#FFFFFF')
          .backgroundColor('#FF3B30')
          .padding({
            left: 6,
            right: 6,
            top: 2,
            bottom: 2
          })
          .borderRadius(10)
      }
    }
    .padding(12)
    .backgroundColor('#FFFFFF')
    .onClick(() => {
      this.selectedChat = message;
    })
  }

  @Builder
  ChatDetail() {
    Column() {
      // èŠå¤©å¤´éƒ¨ - å…¨å±é¡¶éƒ¨ï¼Œæ˜µç§°å±…ä¸­
      Row() {
        Image($r('app.media.back_icon'))
          .width(24)
          .height(24)
          .onClick(() => {
            this.selectedChat = null;
            this.loadMessages(); // åˆ·æ–°æ¶ˆæ¯åˆ—è¡¨
          })

        Text(this.selectedChat?.username || '')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        // å ä½ï¼Œä¿æŒå¯¹ç§°
        Blank()
          .width(24)
      }
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      .backgroundColor('#FFFFFF')
      .width('100%')
      .border({ width: { bottom: 1 }, color: '#F0F0F0' })

      // èŠå¤©å†…å®¹
      List() {
        ForEach(this.selectedChat?.messages || [], (msg: ChatMessage) => {
          ListItem() {
            this.ChatBubble(msg)
          }
        }, (msg: ChatMessage) => msg.id.toString())
      }
      .layoutWeight(1)
      .width('100%')
      .backgroundColor('#F5F5F5')

      // è¾“å…¥åŒºåŸŸ
      Row() {
        // è¯­éŸ³æŒ‰é’®
        Row({ space: 4 }) {
        Button(this.recording ? 'ğŸ¤' : 'ğŸ™', { type: ButtonType.Normal })
          .fontSize(20)
          .backgroundColor(Color.Transparent)
          .borderColor(Color.Transparent)
          .width(32)
          .height(32)
          .onClick(() => {
            if (this.recording) {
              this.stopRecording();
            } else {
              this.startRecording();
            }
          })
          if (this.recording) {
            Text(`${this.recordingDuration}''`)
              .fontSize(12)
              .fontColor('#FF3B30')
              .fontWeight(FontWeight.Medium)
          }
        }
        .margin({ right: 8 })

        // è¾“å…¥æ¡†
        TextInput({ placeholder: 'è¾“å…¥æ¶ˆæ¯...', text: this.chatInput })
          .layoutWeight(1)
          .height(40)
          .backgroundColor('#FFFFFF')
          .borderRadius(20)
          .padding({ left: 12, right: 12 })
          .onChange((value: string) => {
            this.chatInput = value;
          })

        // å›¾ç‰‡æŒ‰é’®
        Button('ğŸ“·', { type: ButtonType.Normal })
          .fontSize(20)
          .backgroundColor(Color.Transparent)
          .borderColor(Color.Transparent)
          .width(32)
          .height(32)
          .margin({ left: 8, right: 4 })
          .onClick(() => {
            this.selectImage();
          })

        // è§†é¢‘æŒ‰é’®
        Button('ğŸ¥', { type: ButtonType.Normal })
          .fontSize(20)
          .backgroundColor(Color.Transparent)
          .borderColor(Color.Transparent)
          .width(32)
          .height(32)
          .margin({ left: 4, right: 8 })
          .onClick(() => {
            this.selectVideo();
          })

        // å‘é€æŒ‰é’®
        if (this.chatInput.trim()) {
          Button('å‘é€', { type: ButtonType.Normal })
            .fontSize(14)
            .backgroundColor('#007DFF')
            .fontColor('#FFFFFF')
            .padding({ left: 12, right: 12 })
          .onClick(() => {
            this.sendMessage();
          })
        }
      }
      .padding(12)
      .backgroundColor('#FFFFFF')
      .width('100%')
    }
    .onAppear(() => {
      if (this.selectedChat) {
        this.loadChatMessages(this.selectedChat.conversationId);
      }
    })
  }

  @Builder
  ChatBubble(message: ChatMessage) {
    Row() {
      if (!message.isMe) {
        if (this.selectedChat?.avatar && this.selectedChat.avatar.startsWith('app.media.avatar')) {
          Image($r(this.selectedChat.avatar))
            .width(32)
            .height(32)
            .borderRadius(16)
            .margin({ right: 8 })
        } else if (this.selectedChat?.avatar) {
          Image(this.selectedChat.avatar)
            .width(32)
            .height(32)
            .borderRadius(16)
            .margin({ right: 8 })
        } else {
          Image($r('app.media.ic_user_avatar'))
            .width(32)
            .height(32)
            .borderRadius(16)
            .margin({ right: 8 })
        }
      }

      Column() {
        if (message.type === 'text') {
          Text(message.content)
            .fontSize(14)
            .fontColor(message.isMe ? '#FFFFFF' : '#333333')
            .backgroundColor(message.isMe ? '#007DFF' : '#FFFFFF')
            .padding(12)
            .borderRadius(12)
            .constraintSize({ maxWidth: '70%' })
            .maxLines(10)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        } else if (message.type === 'image' && message.imageUrl) {
          Stack() {
            if (message.imageUrl.startsWith('app.media.')) {
              Image($r(message.imageUrl))
                .width(200)
                .height(200)
                .borderRadius(12)
                .objectFit(ImageFit.Cover)
            } else {
              Image(this.normalizeImagePath(message.imageUrl))
                .width(200)
                .height(200)
                .borderRadius(12)
                .objectFit(ImageFit.Cover)
            }
          }
          .width(200)
          .height(200)
          .borderRadius(12)
          .onClick(() => {
            // ç‚¹å‡»å›¾ç‰‡å…¨å±å±•ç¤º
            this.previewImage(message.imageUrl || '');
          })
        } else if (message.type === 'video' && message.videoUrl) {
          Stack({ alignContent: Alignment.Center }) {
            if (message.videoUrl.startsWith('app.media.')) {
              Image($r(message.videoUrl))
                .width(200)
                .height(200)
                .borderRadius(12)
                .objectFit(ImageFit.Cover)
            } else {
              Image(this.normalizeImagePath(message.videoUrl))
                .width(200)
                .height(200)
                .borderRadius(12)
                .objectFit(ImageFit.Cover)
            }
            // æ’­æ”¾æŒ‰é’®
            Row() {
              Text('â–¶')
                .fontSize(32)
                .fontColor('#FFFFFF')
            }
            .width(60)
            .height(60)
            .borderRadius(30)
            .backgroundColor('rgba(0, 0, 0, 0.5)')
            .justifyContent(FlexAlign.Center)
          }
          .width(200)
          .height(200)
          .borderRadius(12)
          .onClick(() => {
            this.playVideo(message.videoUrl || '');
          })
        } else if (message.type === 'voice' && message.voiceUrl) {
          Row() {
            Text('â–¶')
              .fontSize(16)
              .fontColor(message.isMe ? '#FFFFFF' : '#333333')
              .margin({ right: 8 })
            Text(`${message.voiceDuration || 0}''`)
              .fontSize(14)
              .fontColor(message.isMe ? '#FFFFFF' : '#333333')
          }
          .backgroundColor(message.isMe ? '#007DFF' : '#FFFFFF')
          .padding(12)
          .borderRadius(12)
          .onClick(() => {
            this.playVoice(message.voiceUrl || '');
          })
        }
      }
      .alignItems(message.isMe ? HorizontalAlign.End : HorizontalAlign.Start)

      if (message.isMe) {
        Image($r('app.media.ic_user_avatar'))
          .width(32)
          .height(32)
          .borderRadius(16)
          .margin({ left: 8 })
      }
    }
    .width('100%')
    .padding({ left: 12, right: 12, top: 8 })
    .justifyContent(message.isMe ? FlexAlign.End : FlexAlign.Start)
  }

  // æ·»åŠ ç”¨æˆ·å¯¹è¯æ¡†
  @Builder
  AddUserDialog() {
    Column() {
      // æœç´¢æ¡†
      Row() {
        TextInput({ placeholder: 'æœç´¢ç”¨æˆ·åæˆ–é‚®ç®±...', text: this.searchKeyword })
          .layoutWeight(1)
          .height(40)
          .backgroundColor('#F5F5F5')
          .borderRadius(20)
          .padding({ left: 12, right: 12 })
          .onChange((value: string) => {
            this.searchKeyword = value;
            if (value.trim()) {
              this.searchUsersByName(value);
            } else {
              this.searchUsers = [];
            }
          })

        Text('å–æ¶ˆ')
          .fontSize(14)
          .fontColor('#007DFF')
          .margin({ left: 12 })
          .onClick(() => {
            this.showAddUserDialog = false;
            this.searchKeyword = '';
            this.searchUsers = [];
          })
      }
      .padding(16)
      .backgroundColor('#FFFFFF')
      .width('100%')

      // ç”¨æˆ·åˆ—è¡¨
      if (this.searchUsers.length > 0) {
        List() {
          ForEach(this.searchUsers, (user: UserInfo) => {
            ListItem() {
              Row() {
                Image(user.avatar || $r('app.media.ic_user_avatar'))
                  .width(48)
                  .height(48)
                  .borderRadius(24)

                Column() {
                  Text(user.username)
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#333333')
                  if (user.email) {
                    Text(user.email)
                      .fontSize(12)
                      .fontColor('#999999')
                      .margin({ top: 4 })
                  }
                }
                .margin({ left: 12 })
                .layoutWeight(1)
                .alignItems(HorizontalAlign.Start)

                Button('æ·»åŠ ', { type: ButtonType.Normal })
                  .fontSize(14)
                  .backgroundColor('#007DFF')
                  .fontColor('#FFFFFF')
                  .onClick(() => {
                    this.createConversation(user.id);
                  })
              }
              .padding(12)
              .width('100%')
            }
          }, (user: UserInfo) => user.id.toString())
        }
        .layoutWeight(1)
        .width('100%')
      } else if (this.searchKeyword.trim() && !this.loading) {
        Column() {
          Text('æœªæ‰¾åˆ°ç”¨æˆ·')
            .fontSize(14)
            .fontColor('#999')
            .textAlign(TextAlign.Center)
            .width('100%')
            .padding(16)
        }
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  // åŠ è½½æ¶ˆæ¯åˆ—è¡¨
  async loadMessages() {
    try {
      this.loading = true;
      const response: ApiResponse = await ApiUtils.get('/messages/conversations');

      if (response.statusCode === 200 && response.data) {
        const data = response.data as ConversationListResponseData;
        const conversations: ConversationItemData[] = data.conversations || [];
        this.messages = conversations.map((conv: ConversationItemData) => {
          const message = new Message();
          message.id = conv.conversationId || conv.id || 0;
          message.conversationId = conv.conversationId || conv.id || 0;
          message.userId = conv.userId || 0;
          message.username = conv.username || '';
          message.avatar = conv.avatar || '';
          message.lastContent = conv.lastContent || '';
          message.lastTime = conv.lastTime || 0;
          message.unreadCount = conv.unreadCount || 0;
          message.isOnline = conv.isOnline || false;
          message.messages = [];
          return message;
        });
        if (this.messages.length === 0) {
          // æœ¬åœ°ç¤ºä¾‹ï¼ˆå¨å¸ˆã€å®¢æœã€ç”¨æˆ·ï¼‰
          this.messages = this.createLocalConversations();
        }
      } else {
        ToastUtils.showToast(response.message || 'åŠ è½½å¤±è´¥');
        // å¤±è´¥æ—¶ä½¿ç”¨æœ¬åœ°ç¤ºä¾‹
        this.messages = this.createLocalConversations();
      }
    } catch (error) {
      console.error('åŠ è½½æ¶ˆæ¯åˆ—è¡¨å¤±è´¥:', JSON.stringify(error));
      ToastUtils.showToast('ç½‘ç»œå¼‚å¸¸ï¼Œè¯·é‡è¯•');
      // å¼‚å¸¸æ—¶ä½¿ç”¨æœ¬åœ°ç¤ºä¾‹
      this.messages = this.createLocalConversations();
    } finally {
      this.loading = false;
    }
  }

  // åŠ è½½èŠå¤©æ¶ˆæ¯
  async loadChatMessages(conversationId: number) {
    if (!this.selectedChat) return;

    try {
      const response: ApiResponse = await ApiUtils.get(`/messages/list?conversation_id=${conversationId}`);

      if (response.statusCode === 200 && response.data) {
        const data = response.data as MessageListResponseData;
        const messages: ChatMessageItemData[] = data.messages || [];
        this.selectedChat.messages = messages.map((msg: ChatMessageItemData) => {
          const chatMessage = new ChatMessage();
          chatMessage.id = msg.id || 0;
          chatMessage.content = msg.content || '';
          chatMessage.time = msg.time || 0;
          chatMessage.isMe = msg.isMe || false;
          chatMessage.type = msg.type || 'text';
          chatMessage.imageUrl = msg.imageUrl || '';
          chatMessage.videoUrl = msg.videoUrl || '';
          chatMessage.voiceUrl = msg.voiceUrl || '';
          chatMessage.voiceDuration = msg.voiceDuration || 0;
          return chatMessage;
        });
      } else {
        ToastUtils.showToast(response.message || 'åŠ è½½æ¶ˆæ¯å¤±è´¥');
      }
    } catch (error) {
      console.error('åŠ è½½èŠå¤©æ¶ˆæ¯å¤±è´¥:', JSON.stringify(error));
      ToastUtils.showToast('ç½‘ç»œå¼‚å¸¸ï¼Œè¯·é‡è¯•');
    }
  }

  // å‘é€æ¶ˆæ¯
  async sendMessage() {
    if (!this.chatInput.trim() || !this.selectedChat) {
      return;
    }

    const content = this.chatInput;
    this.chatInput = '';

    try {
      const request: SendMessageRequest = {
        conversation_id: this.selectedChat.conversationId,
        content: content,
        type: 'text'
      };

      const response: ApiResponse = await ApiUtils.post('/messages/send', request);

      if (response.statusCode === 200 && response.data) {
        const data = response.data as SendMessageResponseData;
        const newMessage = new ChatMessage();
        newMessage.id = data.id || 0;
        newMessage.content = data.content || content;
        newMessage.time = data.time || new Date().getTime();
        newMessage.isMe = true;
        newMessage.type = data.type || 'text';

        if (!this.selectedChat.messages) {
          this.selectedChat.messages = [];
        }
        this.selectedChat.messages.push(newMessage);
        this.selectedChat.lastContent = content;
        this.selectedChat.lastTime = newMessage.time;

        // åˆ·æ–°æ¶ˆæ¯åˆ—è¡¨
        this.loadMessages();
      } else {
        // å¦‚æœAPIå¤±è´¥ï¼Œå¯¹äºæœ¬åœ°ç¤ºä¾‹å¯¹è¯ï¼Œç›´æ¥æ·»åŠ åˆ°æ¶ˆæ¯åˆ—è¡¨
        if (this.selectedChat.conversationId >= 1001 && this.selectedChat.conversationId <= 1003) {
          const newMessage = new ChatMessage();
          newMessage.id = Date.now();
          newMessage.content = content;
          newMessage.time = new Date().getTime();
          newMessage.isMe = true;
          newMessage.type = 'text';

          if (!this.selectedChat.messages) {
            this.selectedChat.messages = [];
          }
          this.selectedChat.messages.push(newMessage);
          this.selectedChat.lastContent = content;
          this.selectedChat.lastTime = newMessage.time;
        } else {
          ToastUtils.showToast(response.message || 'å‘é€å¤±è´¥');
          this.chatInput = content; // æ¢å¤è¾“å…¥å†…å®¹
        }
      }
    } catch (error) {
      console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', JSON.stringify(error));
      // å¯¹äºæœ¬åœ°ç¤ºä¾‹å¯¹è¯ï¼Œå³ä½¿ç½‘ç»œå¤±è´¥ä¹Ÿå…è®¸å‘é€
      if (this.selectedChat && this.selectedChat.conversationId >= 1001 && this.selectedChat.conversationId <= 1003) {
        const newMessage = new ChatMessage();
        newMessage.id = Date.now();
        newMessage.content = content;
        newMessage.time = new Date().getTime();
        newMessage.isMe = true;
        newMessage.type = 'text';

        if (!this.selectedChat.messages) {
          this.selectedChat.messages = [];
        }
        this.selectedChat.messages.push(newMessage);
        this.selectedChat.lastContent = content;
        this.selectedChat.lastTime = newMessage.time;
      } else {
        ToastUtils.showToast('ç½‘ç»œå¼‚å¸¸ï¼Œè¯·é‡è¯•');
        this.chatInput = content; // æ¢å¤è¾“å…¥å†…å®¹
      }
    }
  }

  // æœç´¢ç”¨æˆ·
  async searchUsersByName(keyword: string) {
    try {
      const response: ApiResponse = await ApiUtils.get(`/messages/users/search?keyword=${encodeURIComponent(keyword)}`);

      if (response.statusCode === 200 && response.data) {
        const data = response.data as UserSearchResponse;
        this.searchUsers = data.users || [];
      } else {
        this.searchUsers = [];
      }
    } catch (error) {
      console.error('æœç´¢ç”¨æˆ·å¤±è´¥:', JSON.stringify(error));
      this.searchUsers = [];
    }
  }

  // åˆ›å»ºä¼šè¯
  async createConversation(userId: number) {
    try {
      const request: CreateConversationRequest = {
        user_id: userId
      };

      const response: ApiResponse = await ApiUtils.post('/messages/conversation/create', request);

      if (response.statusCode === 200 && response.data) {
        // åˆ›å»ºä¼šè¯æˆåŠŸï¼Œä¸éœ€è¦è§£æå“åº”æ•°æ®
        ToastUtils.showToast('æ·»åŠ æˆåŠŸ');
        this.showAddUserDialog = false;
        this.searchKeyword = '';
        this.searchUsers = [];
        
        // åˆ·æ–°æ¶ˆæ¯åˆ—è¡¨
        this.loadMessages();
      } else {
        ToastUtils.showToast(response.message || 'æ·»åŠ å¤±è´¥');
      }
    } catch (error) {
      console.error('åˆ›å»ºä¼šè¯å¤±è´¥:', JSON.stringify(error));
      ToastUtils.showToast('ç½‘ç»œå¼‚å¸¸ï¼Œè¯·é‡è¯•');
    }
  }

  // é€‰æ‹©å›¾ç‰‡
  async selectImage() {
    const granted = await this.ensureMediaPermissions();
    if (!granted) {
      return;
    }
    try {
      const photoViewPicker = new picker.PhotoViewPicker();
      const photoSelectOptions = new picker.PhotoSelectOptions();
      photoSelectOptions.MIMEType = picker.PhotoViewMIMETypes.IMAGE_TYPE;
      photoSelectOptions.maxSelectNumber = 1;

      const photoSelectResult = await photoViewPicker.select(photoSelectOptions);
      if (photoSelectResult && photoSelectResult.photoUris && photoSelectResult.photoUris.length > 0) {
        const imageUri = photoSelectResult.photoUris[0];
        await this.sendImageMessage(imageUri);
      }
    } catch (error) {
      console.error('é€‰æ‹©å›¾ç‰‡å¤±è´¥:', JSON.stringify(error));
      ToastUtils.showToast('é€‰æ‹©å›¾ç‰‡å¤±è´¥');
    }
  }

  // å‘é€å›¾ç‰‡æ¶ˆæ¯
  async sendImageMessage(imageUri: string) {
    if (!this.selectedChat) return;

    try {
      // ä¿å­˜å›¾ç‰‡åˆ°åº”ç”¨ç§æœ‰ç›®å½•
      const storedPath = await this.persistMedia(imageUri, 'image');
      
      const request: SendMessageRequest = {
        conversation_id: this.selectedChat.conversationId,
        content: '[å›¾ç‰‡]',
        type: 'image',
        image_url: storedPath
      };

      const response: ApiResponse = await ApiUtils.post('/messages/send', request);

      if (response.statusCode === 200 && response.data) {
        const data = response.data as SendMessageResponseData;
        const newMessage = new ChatMessage();
        newMessage.id = data.id || 0;
        newMessage.content = data.content || '[å›¾ç‰‡]';
        newMessage.time = data.time || new Date().getTime();
        newMessage.isMe = true;
        newMessage.type = 'image';
        newMessage.imageUrl = data.imageUrl || storedPath;

        if (!this.selectedChat.messages) {
          this.selectedChat.messages = [];
        }
        this.selectedChat.messages.push(newMessage);
        this.selectedChat.lastContent = '[å›¾ç‰‡]';
        this.selectedChat.lastTime = newMessage.time;

        // åˆ·æ–°æ¶ˆæ¯åˆ—è¡¨
        this.loadMessages();
      } else {
        // å¦‚æœAPIå¤±è´¥ï¼Œå¯¹äºæœ¬åœ°ç¤ºä¾‹å¯¹è¯ï¼Œç›´æ¥æ·»åŠ åˆ°æ¶ˆæ¯åˆ—è¡¨
        if (this.selectedChat.conversationId >= 1001 && this.selectedChat.conversationId <= 1003) {
          const newMessage = new ChatMessage();
          newMessage.id = Date.now();
          newMessage.content = '[å›¾ç‰‡]';
          newMessage.time = new Date().getTime();
          newMessage.isMe = true;
          newMessage.type = 'image';
          newMessage.imageUrl = storedPath;

          if (!this.selectedChat.messages) {
            this.selectedChat.messages = [];
          }
          this.selectedChat.messages.push(newMessage);
          this.selectedChat.lastContent = '[å›¾ç‰‡]';
          this.selectedChat.lastTime = newMessage.time;
        } else {
          ToastUtils.showToast(response.message || 'å‘é€å¤±è´¥');
        }
      }
    } catch (error) {
      console.error('å‘é€å›¾ç‰‡å¤±è´¥:', JSON.stringify(error));
      ToastUtils.showToast('ç½‘ç»œå¼‚å¸¸ï¼Œè¯·é‡è¯•');
    }
  }

  // å¼€å§‹å½•éŸ³
  async startRecording() {
    if (!this.selectedChat) {
      ToastUtils.showToast('è¯·å…ˆé€‰æ‹©å¯¹è¯');
      return;
    }

    try {
      if (!this.context) {
        this.context = getContext(this) as common.UIAbilityContext;
      }
      if (!this.context) {
        ToastUtils.showToast('æ— æ³•è·å–åº”ç”¨ä¸Šä¸‹æ–‡');
        return;
      }

      // åˆ›å»ºå½•éŸ³æ–‡ä»¶è·¯å¾„
      const filesDir = this.context.filesDir;
      const messagesDir = `${filesDir}/messages`;
      try {
        fs.accessSync(messagesDir);
      } catch {
        fs.mkdirSync(messagesDir, true);
      }

      const fileName = `voice_${Date.now()}.m4a`;
      this.recordingFilePath = `${messagesDir}/${fileName}`;

      // åˆ›å»ºAudioRecorder - æš‚æ—¶ç¦ç”¨ï¼Œå› ä¸ºAPIå¯èƒ½ä¸å…¼å®¹
      // TODO: æ ¹æ®HarmonyOS SDKç‰ˆæœ¬å®ç°æ­£ç¡®çš„å½•éŸ³åŠŸèƒ½
      ToastUtils.showToast('å½•éŸ³åŠŸèƒ½æš‚æœªå®ç°');
      return;

      this.recording = true;
      this.recordingStartTime = Date.now();
      this.recordingDuration = 0;

      // å¯åŠ¨è®¡æ—¶å™¨
      this.recordingTimer = setInterval(() => {
        this.recordingDuration = Math.floor((Date.now() - this.recordingStartTime) / 1000);
      }, 1000);

      ToastUtils.showToast('å¼€å§‹å½•éŸ³');
    } catch (error) {
      console.error('å¼€å§‹å½•éŸ³å¤±è´¥:', JSON.stringify(error));
      ToastUtils.showToast('å½•éŸ³å¤±è´¥ï¼Œè¯·é‡è¯•');
      this.recording = false;
      if (this.audioRecorder) {
        try {
          await this.audioRecorder.release();
        } catch (e) {
          console.error('é‡Šæ”¾å½•éŸ³å™¨å¤±è´¥:', JSON.stringify(e));
        }
        this.audioRecorder = undefined;
      }
    }
  }

  // åœæ­¢å½•éŸ³
  async stopRecording() {
    if (!this.recording || !this.audioRecorder) {
      return;
    }

    try {
      // åœæ­¢å½•éŸ³
      await this.audioRecorder.stop();
      await this.audioRecorder.release();
      this.audioRecorder = undefined;

      // æ¸…é™¤è®¡æ—¶å™¨
      if (this.recordingTimer) {
        clearInterval(this.recordingTimer);
        this.recordingTimer = undefined;
      }

      const duration = this.recordingDuration;
      this.recording = false;
      this.recordingDuration = 0;

      // å¦‚æœå½•éŸ³æ—¶é•¿å¤ªçŸ­ï¼ˆå°äº1ç§’ï¼‰ï¼Œå–æ¶ˆå‘é€
      if (duration < 1) {
        ToastUtils.showToast('å½•éŸ³æ—¶é—´å¤ªçŸ­');
        // åˆ é™¤å½•éŸ³æ–‡ä»¶
        try {
          if (this.recordingFilePath) {
            fs.unlinkSync(this.recordingFilePath);
          }
        } catch (e) {
          console.error('åˆ é™¤å½•éŸ³æ–‡ä»¶å¤±è´¥:', JSON.stringify(e));
        }
        return;
      }

      // å‘é€è¯­éŸ³æ¶ˆæ¯
      if (this.recordingFilePath && this.selectedChat) {
        const relativePath = `messages/${this.recordingFilePath.split('/').pop()}`;
        await this.sendVoiceMessage(relativePath, duration);
      }
    } catch (error) {
      console.error('åœæ­¢å½•éŸ³å¤±è´¥:', JSON.stringify(error));
      ToastUtils.showToast('å½•éŸ³å¤±è´¥ï¼Œè¯·é‡è¯•');
      this.recording = false;
      this.recordingDuration = 0;
    }
  }

  // å‘é€è¯­éŸ³æ¶ˆæ¯
  async sendVoiceMessage(voicePath: string, duration: number) {
    if (!this.selectedChat) return;

    try {
      const request: SendMessageRequest = {
        conversation_id: this.selectedChat.conversationId,
        content: '[è¯­éŸ³]',
        type: 'voice',
        voice_url: voicePath,
        voice_duration: duration
      };

      const response: ApiResponse = await ApiUtils.post('/messages/send', request);

      if (response.statusCode === 200 && response.data) {
        const data = response.data as SendMessageResponseData;
        const newMessage = new ChatMessage();
        newMessage.id = data.id || 0;
        newMessage.content = data.content || '[è¯­éŸ³]';
        newMessage.time = data.time || new Date().getTime();
        newMessage.isMe = true;
        newMessage.type = 'voice';
        newMessage.voiceUrl = data.voiceUrl || voicePath;
        newMessage.voiceDuration = data.voiceDuration || duration;

        if (!this.selectedChat.messages) {
          this.selectedChat.messages = [];
        }
        this.selectedChat.messages.push(newMessage);
        this.selectedChat.lastContent = '[è¯­éŸ³]';
        this.selectedChat.lastTime = newMessage.time;

        // åˆ·æ–°æ¶ˆæ¯åˆ—è¡¨
        this.loadMessages();
        ToastUtils.showToast('è¯­éŸ³å‘é€æˆåŠŸ');
      } else {
        // å¦‚æœAPIå¤±è´¥ï¼Œå¯¹äºæœ¬åœ°ç¤ºä¾‹å¯¹è¯ï¼Œç›´æ¥æ·»åŠ åˆ°æ¶ˆæ¯åˆ—è¡¨
        if (this.selectedChat.conversationId >= 1001 && this.selectedChat.conversationId <= 1003) {
          const newMessage = new ChatMessage();
          newMessage.id = Date.now();
          newMessage.content = '[è¯­éŸ³]';
          newMessage.time = new Date().getTime();
          newMessage.isMe = true;
          newMessage.type = 'voice';
          newMessage.voiceUrl = voicePath;
          newMessage.voiceDuration = duration;

          if (!this.selectedChat.messages) {
            this.selectedChat.messages = [];
          }
          this.selectedChat.messages.push(newMessage);
          this.selectedChat.lastContent = '[è¯­éŸ³]';
          this.selectedChat.lastTime = newMessage.time;
        } else {
          ToastUtils.showToast(response.message || 'å‘é€å¤±è´¥');
        }
      }
    } catch (error) {
      console.error('å‘é€è¯­éŸ³å¤±è´¥:', JSON.stringify(error));
      ToastUtils.showToast('ç½‘ç»œå¼‚å¸¸ï¼Œè¯·é‡è¯•');
    }
  }

  // æ’­æ”¾è¯­éŸ³
  async playVoice(voiceUrl: string) {
    try {
      // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œå…ˆåœæ­¢
      if (this.audioPlayer) {
        try {
          await this.audioPlayer.stop();
          await this.audioPlayer.release();
        } catch (e) {
          console.error('åœæ­¢æ’­æ”¾å¤±è´¥:', JSON.stringify(e));
        }
        this.audioPlayer = undefined;
      }

      if (!this.context) {
        this.context = getContext(this) as common.UIAbilityContext;
      }
      if (!this.context) {
        ToastUtils.showToast('æ— æ³•è·å–åº”ç”¨ä¸Šä¸‹æ–‡');
        return;
      }

      // è·å–è¯­éŸ³æ–‡ä»¶è·¯å¾„
      let filePath = voiceUrl;
      if (voiceUrl.startsWith('messages/')) {
        filePath = `${this.context.filesDir}/${voiceUrl}`;
      } else if (!voiceUrl.startsWith('/') && !voiceUrl.startsWith('file://')) {
        filePath = `${this.context.filesDir}/messages/${voiceUrl}`;
      }

      // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
      try {
        fs.accessSync(filePath);
      } catch {
        ToastUtils.showToast('è¯­éŸ³æ–‡ä»¶ä¸å­˜åœ¨');
        return;
      }

      // åˆ›å»ºAudioPlayer - æš‚æ—¶ç¦ç”¨ï¼Œå› ä¸ºAPIå¯èƒ½ä¸å…¼å®¹
      // TODO: æ ¹æ®HarmonyOS SDKç‰ˆæœ¬å®ç°æ­£ç¡®çš„æ’­æ”¾åŠŸèƒ½
      ToastUtils.showToast('æ’­æ”¾åŠŸèƒ½æš‚æœªå®ç°');
    } catch (error) {
      console.error('æ’­æ”¾è¯­éŸ³å¤±è´¥:', JSON.stringify(error));
      ToastUtils.showToast('æ’­æ”¾å¤±è´¥');
      if (this.audioPlayer) {
        try {
          await this.audioPlayer.release();
        } catch (e) {
          console.error('é‡Šæ”¾æ’­æ”¾å™¨å¤±è´¥:', JSON.stringify(e));
        }
        this.audioPlayer = undefined;
      }
    }
  }

  // é€‰æ‹©è§†é¢‘
  async selectVideo() {
    const granted = await this.ensureMediaPermissions();
    if (!granted) {
      return;
    }
    try {
      const photoViewPicker = new picker.PhotoViewPicker();
      const photoSelectOptions = new picker.PhotoSelectOptions();
      photoSelectOptions.MIMEType = picker.PhotoViewMIMETypes.VIDEO_TYPE;
      photoSelectOptions.maxSelectNumber = 1;

      const photoSelectResult = await photoViewPicker.select(photoSelectOptions);
      if (photoSelectResult && photoSelectResult.photoUris && photoSelectResult.photoUris.length > 0) {
        const videoUri = photoSelectResult.photoUris[0];
        await this.sendVideoMessage(videoUri);
      }
    } catch (error) {
      console.error('é€‰æ‹©è§†é¢‘å¤±è´¥:', JSON.stringify(error));
      ToastUtils.showToast('é€‰æ‹©è§†é¢‘å¤±è´¥');
    }
  }

  // å‘é€è§†é¢‘æ¶ˆæ¯
  async sendVideoMessage(videoUri: string) {
    if (!this.selectedChat) return;

    try {
      // ä¿å­˜è§†é¢‘åˆ°åº”ç”¨ç§æœ‰ç›®å½•
      const storedPath = await this.persistMedia(videoUri, 'video');
      
      const request: SendMessageRequest = {
        conversation_id: this.selectedChat.conversationId,
        content: '[è§†é¢‘]',
        type: 'video',
        video_url: storedPath
      };

      const response: ApiResponse = await ApiUtils.post('/messages/send', request);

      if (response.statusCode === 200 && response.data) {
        const data = response.data as SendMessageResponseData;
        const newMessage = new ChatMessage();
        newMessage.id = data.id || 0;
        newMessage.content = data.content || '[è§†é¢‘]';
        newMessage.time = data.time || new Date().getTime();
        newMessage.isMe = true;
        newMessage.type = 'video';
        newMessage.videoUrl = data.videoUrl || storedPath;

        if (!this.selectedChat.messages) {
          this.selectedChat.messages = [];
        }
        this.selectedChat.messages.push(newMessage);
        this.selectedChat.lastContent = '[è§†é¢‘]';
        this.selectedChat.lastTime = newMessage.time;

        // åˆ·æ–°æ¶ˆæ¯åˆ—è¡¨
        this.loadMessages();
      } else {
        // å¦‚æœAPIå¤±è´¥ï¼Œå¯¹äºæœ¬åœ°ç¤ºä¾‹å¯¹è¯ï¼Œç›´æ¥æ·»åŠ åˆ°æ¶ˆæ¯åˆ—è¡¨
        if (this.selectedChat.conversationId >= 1001 && this.selectedChat.conversationId <= 1003) {
          const newMessage = new ChatMessage();
          newMessage.id = Date.now();
          newMessage.content = '[è§†é¢‘]';
          newMessage.time = new Date().getTime();
          newMessage.isMe = true;
          newMessage.type = 'video';
          newMessage.videoUrl = storedPath;

          if (!this.selectedChat.messages) {
            this.selectedChat.messages = [];
          }
          this.selectedChat.messages.push(newMessage);
          this.selectedChat.lastContent = '[è§†é¢‘]';
          this.selectedChat.lastTime = newMessage.time;
        } else {
          ToastUtils.showToast(response.message || 'å‘é€å¤±è´¥');
        }
      }
    } catch (error) {
      console.error('å‘é€è§†é¢‘å¤±è´¥:', JSON.stringify(error));
      ToastUtils.showToast('ç½‘ç»œå¼‚å¸¸ï¼Œè¯·é‡è¯•');
    }
  }

  // é¢„è§ˆå›¾ç‰‡ï¼ˆå…¨å±å±•ç¤ºï¼‰
  @State showImagePreview: boolean = false;
  @State previewImageUrl: string = '';

  // é¢„è§ˆè§†é¢‘ï¼ˆå…¨å±å±•ç¤ºï¼‰
  @State showVideoPreview: boolean = false;
  @State previewVideoUrl: string = '';

  previewImage(imageUrl: string) {
    this.previewImageUrl = imageUrl;
    this.showImagePreview = true;
  }

  @Builder
  ImagePreviewDialog() {
    if (this.showImagePreview) {
      Column() {
        // é¡¶éƒ¨ä¿¡æ¯æ  - å›ºå®šåœ¨é¡¶éƒ¨ï¼Œæ˜µç§°å±…ä¸­
        Row() {
          Image($r('app.media.back_icon'))
            .width(24)
            .height(24)
            .fillColor('#FFFFFF')
            .onClick(() => {
              this.showImagePreview = false;
            })

          Text(this.selectedChat?.username || 'å›¾ç‰‡é¢„è§ˆ')
            .layoutWeight(1)
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .fontColor('#FFFFFF')
            .textAlign(TextAlign.Center)

          Blank()
            .width(24)
        }
        .width('100%')
        .padding({ top: 40, left: 16, right: 16, bottom: 12 })
        .backgroundColor('#000000')

        // å›¾ç‰‡å±•ç¤ºåŒºåŸŸ
        Stack({ alignContent: Alignment.Center }) {
          if (this.previewImageUrl.startsWith('app.media.')) {
            Image($r(this.previewImageUrl))
              .width('100%')
              .height('100%')
              .objectFit(ImageFit.Contain)
          } else {
            Image(this.normalizeImagePath(this.previewImageUrl))
              .width('100%')
              .height('100%')
              .objectFit(ImageFit.Contain)
          }
        }
        .layoutWeight(1)
        .width('100%')
        .onClick(() => {
          this.showImagePreview = false;
        })
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#000000')
    }
  }

  // æ’­æ”¾è§†é¢‘ï¼ˆå…¨å±å±•ç¤ºï¼‰
  playVideo(videoUrl: string) {
    this.previewVideoUrl = videoUrl;
    this.showVideoPreview = true;
  }

  @Builder
  VideoPreviewDialog() {
    if (this.showVideoPreview) {
      Column() {
        // é¡¶éƒ¨ä¿¡æ¯æ  - å›ºå®šåœ¨é¡¶éƒ¨ï¼Œæ˜µç§°å±…ä¸­
        Row() {
          Image($r('app.media.back_icon'))
            .width(24)
            .height(24)
            .fillColor('#FFFFFF')
            .onClick(() => {
              this.showVideoPreview = false;
            })

          Text(this.selectedChat?.username || 'è§†é¢‘æ’­æ”¾')
            .layoutWeight(1)
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .fontColor('#FFFFFF')
            .textAlign(TextAlign.Center)

          Blank()
            .width(24)
        }
        .width('100%')
        .padding({ top: 40, left: 16, right: 16, bottom: 12 })
        .backgroundColor('#000000')

        // è§†é¢‘æ’­æ”¾åŒºåŸŸ
        Stack({ alignContent: Alignment.Center }) {
          Video({
            src: this.normalizeImagePath(this.previewVideoUrl),
            controller: new VideoController()
          })
            .width('100%')
            .height('100%')
            .autoPlay(true)
            .controls(true)
            .objectFit(ImageFit.Contain)
        }
        .layoutWeight(1)
        .width('100%')
        .backgroundColor('#000000')
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#000000')
    }
  }

  // æœ¬åœ°ç¤ºä¾‹å¯¹è¯ï¼ˆå¤´åƒï¼šavatar1=å¨å¸ˆã€avatar2=å®¢æœã€avatar3=ç”¨æˆ·ï¼‰
  createLocalConversations(): Message[] {
    const now = Date.now();

    const chef = new Message();
    chef.id = 1001;
    chef.conversationId = 1001;
    chef.userId = 501;
    chef.username = 'å¨å¸ˆ';
    chef.avatar = 'app.media.avatar1';
    chef.isOnline = true;
    chef.messages = [
      this.createTextMsg(1, 'æ‚¨å¥½ï¼Œä»Šå¤©çš„æ–°å“æ˜¯é»‘æ¤’ç‰›æŸ³é…çƒ¤æ—¶è”¬ï¼Œè¦å°è¯•ä¸€ä¸‹å—ï¼Ÿ', false, now - 60 * 60 * 1000),
      this.createTextMsg(2, 'æœ‰æ— è¾£ç‰ˆå—ï¼Ÿæˆ‘ä¸å¤ªèƒ½åƒè¾£ã€‚', true, now - 59 * 60 * 1000),
      this.createTextMsg(3, 'å¯ä»¥çš„ï½é»‘æ¤’å£å‘³åé²œé¦™ï¼Œä¸è¾£ã€‚ä¹Ÿå¯æŒ‰æ‚¨å£å‘³è°ƒæ•´ã€‚', false, now - 58 * 60 * 1000)
    ];
    chef.lastContent = chef.messages[chef.messages.length - 1].content;
    chef.lastTime = chef.messages[chef.messages.length - 1].time;
    chef.unreadCount = 0;

    const support = new Message();
    support.id = 1002;
    support.conversationId = 1002;
    support.userId = 502;
    support.username = 'å®¢æœ';
    support.avatar = 'app.media.avatar2';
    support.isOnline = true;
    support.messages = [
      this.createTextMsg(4, 'æ‚¨å¥½ï¼Œè¿™é‡Œæ˜¯å®¢æœï¼Œè¯·é—®éœ€è¦ä»€ä¹ˆå¸®åŠ©ï¼Ÿ', false, now - 30 * 60 * 1000),
      this.createTextMsg(5, 'æˆ‘æƒ³å’¨è¯¢ä¸€ä¸‹é…é€æ—¶é—´ï¼Œå¤§æ¦‚å¤šä¹…èƒ½åˆ°ï¼Ÿ', true, now - 29 * 60 * 1000),
      this.createTextMsg(6, 'åŒåŸå¹³å‡30-45åˆ†é’Ÿï¼Œå°–å³°æ—¶æ®µå¯èƒ½ç•¥æœ‰å»¶è¿Ÿå“¦ï½', false, now - 28 * 60 * 1000)
    ];
    support.lastContent = support.messages[support.messages.length - 1].content;
    support.lastTime = support.messages[support.messages.length - 1].time;
    support.unreadCount = 2;

    const user = new Message();
    user.id = 1003;
    user.conversationId = 1003;
    user.userId = 503;
    user.username = 'ç”¨æˆ·';
    user.avatar = 'app.media.avatar3';
    user.isOnline = false;
    user.messages = [
      this.createTextMsg(7, 'å‘¨æœ«ä¸€èµ·å»å°å°åº—é‡Œçš„æ–°ç”œå“ï¼Ÿ', false, now - 10 * 60 * 1000),
      this.createTextMsg(8, 'å¥½å‘€ï¼æˆ‘çœ‹è¯„ä»·éƒ½ä¸é”™ï½', true, now - 9 * 60 * 1000),
      this.createTextMsg(9, 'é‚£å°±è¿™ä¹ˆå®šå•¦ï¼Œå‘¨å…­ä¸‹åˆè§ã€‚', false, now - 8 * 60 * 1000)
    ];
    user.lastContent = user.messages[user.messages.length - 1].content;
    user.lastTime = user.messages[user.messages.length - 1].time;
    user.unreadCount = 0;

    return [chef, support, user];
  }

  // ä¾¿æ·åˆ›å»ºæ–‡æœ¬æ¶ˆæ¯
  private createTextMsg(id: number, content: string, isMe: boolean, time: number): ChatMessage {
    const m = new ChatMessage();
    m.id = id;
    m.content = content;
    m.isMe = isMe;
    m.time = time;
    m.type = 'text';
    return m;
  }

  // æƒé™ç”³è¯·
  private async ensureMediaPermissions(): Promise<boolean> {
    if (this.mediaPermissionsGranted) {
      return true;
    }
    if (!this.atManager || !this.context) {
      try {
        this.context = getContext(this) as common.UIAbilityContext;
        this.atManager = abilityAccessCtrl.createAtManager();
      } catch (error) {
        console.error('è·å–ä¸Šä¸‹æ–‡å¤±è´¥:' + JSON.stringify(error));
        return false;
      }
    }
    if (!this.atManager || !this.context) {
      return false;
    }
    try {
      const permissionResult = await this.atManager.requestPermissionsFromUser(
        this.context,
        this.mediaPermissions
      ) as PermissionRequestResult;
      const granted = permissionResult.authResults.every((status: number) => status === 0);
      this.mediaPermissionsGranted = granted;
      if (!granted) {
        ToastUtils.showToast('è¯·æˆäºˆç›¸å†Œä¸ç›¸æœºæƒé™åå†è¯•');
      }
      return granted;
    } catch (error) {
      console.error('ç”³è¯·åª’ä½“æƒé™å¤±è´¥:' + JSON.stringify(error));
      ToastUtils.showToast('æƒé™ç”³è¯·å¤±è´¥');
      return false;
    }
  }

  // ä¿å­˜åª’ä½“æ–‡ä»¶åˆ°åº”ç”¨ç§æœ‰ç›®å½•
  private async persistMedia(uri: string, type: 'image' | 'video'): Promise<string> {
    if (!this.context) {
      try {
        this.context = getContext(this) as common.UIAbilityContext;
      } catch (error) {
        console.error('è·å–ä¸Šä¸‹æ–‡å¤±è´¥:' + JSON.stringify(error));
        return uri;
      }
    }
    if (!this.context) {
      return uri;
    }
    try {
      const sourcePath: string = this.resolveFilePath(uri);
      if (!sourcePath) {
        console.error('æ— æ³•è§£æåª’ä½“è·¯å¾„:' + uri);
        return uri;
      }
      
      // æ£€æŸ¥æºæ–‡ä»¶æ˜¯å¦å­˜åœ¨
      try {
        fs.accessSync(sourcePath);
      } catch (error) {
        console.error('æºåª’ä½“æ–‡ä»¶ä¸å­˜åœ¨:' + sourcePath);
        return uri;
      }
      
      // ç¡®ä¿åº”ç”¨ç§æœ‰ç›®å½•å­˜åœ¨
      const filesDir: string = this.context.filesDir;
      try {
        fs.accessSync(filesDir);
      } catch (error) {
        // ç›®å½•ä¸å­˜åœ¨,åˆ›å»ºå®ƒ
        try {
          fs.mkdirSync(filesDir, true);
        } catch (mkdirError) {
          console.error('åˆ›å»ºfilesDirå¤±è´¥:' + JSON.stringify(mkdirError));
        }
      }
      
      // åˆ›å»ºmessageså­ç›®å½•ç”¨äºå­˜å‚¨æ¶ˆæ¯åª’ä½“
      const messagesDir: string = `${filesDir}/messages`;
      try {
        fs.accessSync(messagesDir);
      } catch (error) {
        // ç›®å½•ä¸å­˜åœ¨,åˆ›å»ºå®ƒ
        try {
          fs.mkdirSync(messagesDir, true);
        } catch (mkdirError) {
          console.error('åˆ›å»ºmessagesDirå¤±è´¥:' + JSON.stringify(mkdirError));
        }
      }
      
      // ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
      const extension: string = this.extractExtension(sourcePath, type === 'video' ? '.mp4' : '.jpg');
      const fileName: string = `msg_${type}_${Date.now()}_${Math.floor(Math.random() * 10000)}${extension}`;
      const targetPath: string = `${messagesDir}/${fileName}`;
      
      // å¤åˆ¶æ–‡ä»¶åˆ°åº”ç”¨ç§æœ‰ç›®å½•
      fs.copyFileSync(sourcePath, targetPath);
      
      // è¿”å›ç›¸å¯¹è·¯å¾„(ç›¸å¯¹äºfilesDir),è¿™æ ·æ•°æ®åº“åªå­˜å‚¨ç›¸å¯¹è·¯å¾„
      const relativePath: string = `messages/${fileName}`;
      console.log('åª’ä½“å·²ä¿å­˜åˆ°:' + targetPath + ', ç›¸å¯¹è·¯å¾„:' + relativePath);
      return relativePath;
    } catch (error) {
      console.error('ä¿å­˜åª’ä½“æ–‡ä»¶å¤±è´¥:' + JSON.stringify(error));
      ToastUtils.showToast('åª’ä½“ä¿å­˜å¤±è´¥ï¼Œå°†ä½¿ç”¨åŸå§‹è·¯å¾„');
      return uri;
    }
  }

  // å°†ç›¸å¯¹è·¯å¾„è½¬æ¢ä¸ºç»å¯¹è·¯å¾„ç”¨äºæ˜¾ç¤º
  private normalizeImagePath(path: string): string {
    if (!path) {
      return '';
    }
    // å¦‚æœæ˜¯app.mediaèµ„æºï¼Œç›´æ¥è¿”å›
    if (path.startsWith('app.media.')) {
      return path;
    }
    // å¦‚æœæ˜¯ç»å¯¹è·¯å¾„ï¼Œç›´æ¥è¿”å›
    if (path.startsWith('/') || path.startsWith('file://')) {
      return path.startsWith('file://') ? path.replace('file://', '') : path;
    }
    // å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼ˆmessages/xxxï¼‰ï¼Œè½¬æ¢ä¸ºç»å¯¹è·¯å¾„
    if (path.startsWith('messages/')) {
      if (!this.context) {
        try {
          this.context = getContext(this) as common.UIAbilityContext;
        } catch (error) {
          console.error('è·å–ä¸Šä¸‹æ–‡å¤±è´¥:' + JSON.stringify(error));
          return path;
        }
      }
      if (this.context) {
        return `${this.context.filesDir}/${path}`;
      }
    }
    return path;
  }

  // è§£ææ–‡ä»¶è·¯å¾„
  private resolveFilePath(uri: string): string {
    if (!uri) {
      return '';
    }
    if (uri.startsWith('file://')) {
      return uri.replace('file://', '');
    }
    return uri;
  }

  // æå–æ–‡ä»¶æ‰©å±•å
  private extractExtension(path: string, fallback: string = ''): string {
    if (!path) {
      return fallback;
    }
    const dotIndex = path.lastIndexOf('.');
    if (dotIndex === -1) {
      return fallback;
    }
    return path.substring(dotIndex);
  }
}