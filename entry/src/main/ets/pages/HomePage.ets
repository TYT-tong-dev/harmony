// HomePage.ets - å•†å®¶æ‰«ç ç‚¹å•åº”ç”¨é¦–é¡µ
// åŒ…å«åº—é“ºä¿¡æ¯ã€èœå“ç®¡ç†ã€è´­ç‰©è½¦ç­‰åŠŸèƒ½
import { ShopInfo, Dish, ApiResponse, CartResponse, AddToCartRequest, CreateDishRequest, NewDishForm, ShopInfoResponse, DishListResponse, DishReview, AppMode, NotificationListResponse, AppNotification, NotificationType } from '../common/Types';
import { ApiUtils, ToastUtils, CartSyncManager, LocalCartManager, AppModeManager } from '../common/Utils';
import { NotificationUtils, NotificationData } from '../common/NotificationUtils';
import router from '@ohos.router';
import picker from '@ohos.file.picker';
import common from '@ohos.app.ability.common';
import abilityAccessCtrl from '@ohos.abilityAccessCtrl';
import fs from '@ohos.file.fs';
// Map SDKæš‚ä¸å¯ç”¨ï¼Œä½¿ç”¨é™æ€åœ°å›¾é¢„è§ˆæ›¿ä»£
// import { MapComponent, MapProperties, MapType, MapController, MarkerOptions } from '@hms/map';

type MediaPermissionName =
  | 'ohos.permission.READ_MEDIA'
  | 'ohos.permission.WRITE_MEDIA'
  | 'ohos.permission.READ_IMAGEVIDEO'
  | 'ohos.permission.WRITE_IMAGEVIDEO'
  | 'ohos.permission.CAMERA';

interface PermissionRequestResult {
  permissions: MediaPermissionName[];
  authResults: number[];
}

const DEFAULT_LATITUDE: number = 39.9042;
const DEFAULT_LONGITUDE: number = 116.4074;
const HUAWEI_MAP_PROJECT_ID: string = '101653523862716962';
const HUAWEI_MAP_CLIENT_ID: string = '1829108310557615936';
const HUAWEI_MAP_CLIENT_SECRET: string = 'E36A71B8A0116DEE2B9E5272F7F2256C36BDF972217E18BAFF1BF20D205D6EE5';
const HUAWEI_MAP_API_KEY: string = 'DgEDAOP2OZMamC/Ot5UM8pXwFOtm5CCi2QrjHmSfx7YOlpmhBXWl2wL/fkua55f6Wa86BI+0s53oF7Wk5Q/EQbC5uwcufMWnls+HyA==';

@Entry
@Component
export struct HomePage {
  // åº—é“ºä¿¡æ¯
  @State shopInfo: ShopInfo = new ShopInfo();
  @StorageLink('appMode') appMode: AppMode = AppMode.MERCHANT;
  @StorageLink('currentTableId') currentTableId: string = '';
  
  // èœå“åˆ—è¡¨
  @State dishes: Dish[] = [];
  
  // é€‰ä¸­çš„åˆ†ç±»
  @State selectedCategory: string = 'å…¨éƒ¨';
  
  // åŠ è½½çŠ¶æ€
  @State isLoading: boolean = true;
  
  // è´­ç‰©è½¦æ•°é‡ï¼ˆåŒæ­¥ï¼‰
  @StorageLink('cartItemCount') cartItemCount: number = 0;
  
  // è´­ç‰©è½¦æ€»é‡‘é¢ï¼ˆåŒæ­¥ï¼‰
  @StorageLink('cartTotalAmount') cartTotalAmount: number = 0;
  
  // èœå“åˆ†ç±»
  @State categories: string[] = ['å…¨éƒ¨', 'çƒ­èœ', 'å‡‰èœ', 'ä¸»é£Ÿ', 'æ±¤ç±»', 'é¥®æ–™', 'ç”œå“', 'æ‹›ç‰Œèœ'];
  
  // æ˜¯å¦æ˜¾ç¤ºæ·»åŠ èœå“å¯¹è¯æ¡†
  @State showAddDishDialog: boolean = false;
  
  // æ˜¯å¦æ˜¾ç¤ºå›¾ç‰‡é€‰æ‹©å™¨
  @State showImagePicker: boolean = false;
  
  // æ–°èœå“è¡¨å•
  @State newDish: NewDishForm = new NewDishForm();
  
  // æœ¬åœ°å›¾ç‰‡èµ„æºåˆ—è¡¨
  @State localImages: string[] = [
    'app.media.dish1',
    'app.media.dish2',
    'app.media.dish3',
    'app.media.dish4',
    'app.media.dish5',
    'app.media.default_dish'
  ];

  private defaultFeaturedDishes?: Dish[];
  private context?: common.UIAbilityContext;
  private atManager?: abilityAccessCtrl.AtManager;
  private mediaPermissionsGranted: boolean = false;
  @State featuredActiveIndex: number = 0;
  @State featuredSlides: Dish[] = [];
  @State isRefreshing: boolean = false;
  @State imageProcessing: boolean = false;
  private pageScroller: Scroller = new Scroller();
  private categoryScroller: Scroller = new Scroller();
  @State showDishDetail: boolean = false;
  @State selectedDish?: Dish = undefined;
  @State reviewRating: number = 5;
  @State reviewContent: string = '';
  @State dishReviewStore: Record<number, DishReview[]> = {};
  @State showMapDialog: boolean = false;
  @State mapCenterLat: number = DEFAULT_LATITUDE;
  @State mapCenterLng: number = DEFAULT_LONGITUDE;
  
  private readonly mediaPermissions: MediaPermissionName[] = [
    'ohos.permission.READ_MEDIA',
    'ohos.permission.WRITE_MEDIA',
    'ohos.permission.READ_IMAGEVIDEO',
    'ohos.permission.WRITE_IMAGEVIDEO',
    'ohos.permission.CAMERA'
  ];

  // é€šçŸ¥è½®è¯¢
  private notificationPollingId: number = -1;
  @State unreadNotificationCount: number = 0;
  @State lastNotificationId: number = 0;

  aboutToAppear() {
    try {
      this.context = getContext(this) as common.UIAbilityContext;
      this.atManager = abilityAccessCtrl.createAtManager();
    } catch (error) {
      console.error('è·å–é¡µé¢ä¸Šä¸‹æ–‡å¤±è´¥:' + JSON.stringify(error));
    }
    this.featuredSlides = this.buildCarouselSlidesFromAssets();
    this.loadShopData();
    this.loadDishes();
    this.loadCartData();
    // å•†å®¶æ¨¡å¼ä¸‹å¯åŠ¨é€šçŸ¥è½®è¯¢
    if (!this.isCustomerMode) {
      this.startNotificationPolling();
    }
  }

  aboutToDisappear() {
    this.stopNotificationPolling();
  }

  // å¯åŠ¨é€šçŸ¥è½®è¯¢
  private startNotificationPolling(): void {
    // ç«‹å³æ£€æŸ¥ä¸€æ¬¡
    this.checkNewNotifications();
    // æ¯10ç§’è½®è¯¢ä¸€æ¬¡
    this.notificationPollingId = setInterval(() => {
      this.checkNewNotifications();
    }, 10000);
  }

  // åœæ­¢é€šçŸ¥è½®è¯¢
  private stopNotificationPolling(): void {
    if (this.notificationPollingId !== -1) {
      clearInterval(this.notificationPollingId);
      this.notificationPollingId = -1;
    }
  }

  // æ£€æŸ¥æ–°é€šçŸ¥
  private async checkNewNotifications(): Promise<void> {
    try {
      const response: ApiResponse = await ApiUtils.get('/notifications/list?unread_only=true&limit=5');
      if (response.statusCode === 200 && response.data) {
        const data = response.data as NotificationListResponse;
        this.unreadNotificationCount = data.unread_count;

        // æ£€æŸ¥æ˜¯å¦æœ‰æ–°è®¢å•é€šçŸ¥
        if (data.notifications && data.notifications.length > 0) {
          for (const notification of data.notifications) {
            // åªå¤„ç†æ¯”ä¸Šæ¬¡æ›´æ–°çš„é€šçŸ¥
            if (notification.id > this.lastNotificationId) {
              // å‘é€æœ¬åœ°é€šçŸ¥
              if (notification.type === 'order') {
                const notificationData = new NotificationData(
                  notification.id,
                  NotificationType.ORDER,
                  notification.title,
                  notification.content
                );
                await NotificationUtils.sendNotification(notificationData);
              }
            }
          }
          // æ›´æ–°æœ€åä¸€æ¡é€šçŸ¥ID
          let maxId = 0;
          for (const n of data.notifications) {
            if (n.id > maxId) {
              maxId = n.id;
            }
          }
          this.lastNotificationId = maxId;
        }
      }
    } catch (error) {
      console.error('æ£€æŸ¥é€šçŸ¥å¤±è´¥:' + JSON.stringify(error));
    }
  }

  private get isCustomerMode(): boolean {
    return this.appMode === AppMode.CUSTOMER;
  }

  private get tableDisplayText(): string {
    return this.currentTableId ? `å½“å‰é¤æ¡Œï¼š${this.currentTableId}` : 'å ‚é£Ÿé¡¾å®¢';
  }

  private hasValidCoordinates(): boolean {
    return typeof this.shopInfo.latitude === 'number' && typeof this.shopInfo.longitude === 'number';
  }

  private openMapPreview(): void {
    if (!this.shopInfo.address) {
      ToastUtils.showToast('æš‚æ— åº—é“ºåœ°å€');
      return;
    }
    if (!this.hasValidCoordinates()) {
      if (this.shopInfo.latitude === undefined) {
        this.shopInfo.latitude = DEFAULT_LATITUDE;
      }
      if (this.shopInfo.longitude === undefined) {
        this.shopInfo.longitude = DEFAULT_LONGITUDE;
      }
    }
    this.mapCenterLat = this.shopInfo.latitude ?? DEFAULT_LATITUDE;
    this.mapCenterLng = this.shopInfo.longitude ?? DEFAULT_LONGITUDE;
    this.showMapDialog = true;
  }

  // Map SDKæš‚ä¸å¯ç”¨ï¼Œç§»é™¤handleMapReadyæ–¹æ³•
  // å¦‚éœ€åœ°å›¾åŠŸèƒ½ï¼Œè¯·ç¡®ä¿@hms/mapä¾èµ–æ­£ç¡®å®‰è£…å¹¶é…ç½®

  private closeMapDialog(): void {
    this.showMapDialog = false;
  }


  build() {
    Stack() {
      // ä¸»å†…å®¹åŒºåŸŸ + ä¸‹æ‹‰åˆ·æ–°
      Refresh({ refreshing: this.isRefreshing, offset: 120 }) {
        Scroll(this.pageScroller) {
          Column() {
          // é¡¶éƒ¨å¯¼èˆªæ ï¼ˆå³ä¸Šè§’æ·»åŠ èœå“æŒ‰é’®ï¼‰
          this.TopNavigation()
          if (this.isCustomerMode) {
            this.CustomerAnnouncement()
          }

          // 1. åº—é“ºä¿¡æ¯
          this.ShopInfoCard()

          // 2. ä¸»æ¨èœå“
          this.RecommendedDishesSection(this.getCarouselSlides())

          // 3. èœå“ä¿¡æ¯ï¼ˆåˆ†ç±»å¯¼èˆª + èœå“åˆ—è¡¨ï¼‰
          this.DishesSection()
        }
        .width('100%')
        .padding({ bottom: 110 }) // ä¸ºåº•éƒ¨æŒ‰é’®ç•™å‡ºç©ºé—´
        }
        .width('100%')
        .height('100%')
        .scrollable(ScrollDirection.Vertical)
        .scrollBar(BarState.Auto)
        .edgeEffect(EdgeEffect.Spring)
        .backgroundColor('#F8FAFF')
        .zIndex(0)
      }
      .width('100%')
      .height('100%')
      .onRefreshing(() => {
        if (!this.isRefreshing) {
          this.refreshHomeData();
        }
      })

      // å³ä¸‹è§’å›ºå®šè´­ç‰©è½¦æŒ‰é’®ï¼Œæµ®äºå†…å®¹ä¹‹ä¸Š
      Column() {
        Blank()
          .layoutWeight(1)
        Row() {
          this.FloatingCartButton()
        }
        .width('100%')
        .justifyContent(FlexAlign.End)
      }
      .width('100%')
      .height('100%')
      .hitTestBehavior(HitTestMode.Transparent)
      .padding({ right: 20, bottom: 24 })

      // æ·»åŠ èœå“å¯¹è¯æ¡†
      if (this.showAddDishDialog && !this.isCustomerMode) {
        this.AddDishDialog()
      }

      // å›¾ç‰‡é€‰æ‹©å™¨å¯¹è¯æ¡†
      if (this.showImagePicker) {
        this.ImagePickerDialog()
      }

      if (this.showDishDetail && this.selectedDish) {
        this.DishDetailDialog()
      }

      if (this.showMapDialog) {
        this.MapPreviewDialog()
      }
    }
    .width('100%')
    .height('100%')
  }

  // é¡¶éƒ¨å¯¼èˆªæ ï¼ˆå³ä¸Šè§’æ·»åŠ èœå“æŒ‰é’®ï¼‰
  @Builder
  TopNavigation() {
    Row() {
      // åº—é“ºLogoå’Œåç§°
      Row() {
        Image($r('app.media.ic_shop'))
          .width(44)
          .height(44)
          .borderRadius(22)
          .margin({ right: 12 })
          .shadow({
            radius: 6,
            color: '#20000000',
            offsetX: 0,
            offsetY: 2
          })

        Column() {
          Text(this.shopInfo.shop_name || this.shopInfo.name || 'ç¾å‘³é¤å…')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1A1A1A')
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })

          Row({ space: 4 }) {
            Image($r('app.media.star'))
              .width(14)
              .height(14)
              .fillColor('#FFB800')
            Text((this.shopInfo.score || 4.8).toFixed(1))
              .fontSize(13)
              .fontColor('#FF9500')
              .fontWeight(FontWeight.Medium)
            Text('Â·')
              .fontSize(13)
              .fontColor('#CCCCCC')
            Text('è¥ä¸šä¸­')
              .fontSize(12)
              .fontColor('#34C759')
          }
          .alignItems(VerticalAlign.Center)
          .margin({ top: 4 })
        }
        .alignItems(HorizontalAlign.Start)
      }
      .layoutWeight(1)

      if (!this.isCustomerMode) {
        // å³ä¸Šè§’ã€Œæ·»åŠ èœå“ã€æŒ‰é’®
        Button({ type: ButtonType.Normal, stateEffect: true }) {
          Row({ space: 6 }) {
            Text('+')
              .fontSize(18)
              .fontColor('#FFFFFF')
              .fontWeight(FontWeight.Bold)
            Text('æ·»åŠ èœå“')
              .fontSize(13)
              .fontColor('#FFFFFF')
              .fontWeight(FontWeight.Medium)
          }
          .alignItems(VerticalAlign.Center)
          .justifyContent(FlexAlign.Center)
        }
        .height(40)
        .padding({ left: 16, right: 18 })
        .backgroundColor('#34C759')
        .borderRadius(20)
        .shadow({
          radius: 10,
          color: '#4034C759',
          offsetX: 0,
          offsetY: 4
        })
        .onClick(() => {
          console.info('æ·»åŠ èœå“æŒ‰é’®è¢«ç‚¹å‡»');
          this.navigateToAddDishPage();
        })
      } else {
        this.CustomerModeBadge()
      }
    }
    .width('100%')
    .padding({
      left: 16,
      right: 16,
      top: 12,
      bottom: 12
    })
    .backgroundColor('#FFFFFF')
    .shadow({
      radius: 12,
      color: '#12000000',
      offsetX: 0,
      offsetY: 4
    })
  }

  @Builder
  CustomerModeBadge() {
    Row({ space: 6 }) {
      Image($r('app.media.qr_code'))
        .width(18)
        .height(18)
        .fillColor('#007DFF')
      Text(this.tableDisplayText)
        .fontSize(13)
        .fontColor('#007DFF')
        .fontWeight(FontWeight.Medium)
    }
    .padding({ left: 12, right: 12, top: 8, bottom: 8 })
    .backgroundColor('#EAF3FF')
    .borderRadius(18)
  }

  @Builder
  CustomerAnnouncement() {
    Row() {
      Column({ space: 4 }) {
        Text('æ¬¢è¿ä½¿ç”¨é¡¾å®¢ç‚¹é¤ç‰ˆ')
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor('#1A1A1A')
        Text(this.tableDisplayText)
          .fontSize(12)
          .fontColor('#666666')
      }
      .layoutWeight(1)

      Button('åˆ‡æ¢å•†å®¶ç«¯', { type: ButtonType.Normal, stateEffect: true })
        .height(34)
        .padding({ left: 12, right: 12 })
        .fontSize(12)
        .borderRadius(17)
        .backgroundColor('#FFFFFF')
        .fontColor('#007DFF')
        .onClick(() => {
          AppModeManager.setMode(AppMode.MERCHANT);
          ToastUtils.showToast('å·²åˆ‡å›å•†å®¶ç«¯ï¼Œè¯·é‡æ–°ç™»å½•');
          router.replaceUrl({
            url: 'pages/LoginPage'
          });
        })
    }
    .width('100%')
    .padding({ left: 20, right: 20, top: 4, bottom: 4 })
    .backgroundColor('#F5F9FF')
  }

  // åº—é“ºä¿¡æ¯å¡ç‰‡
  @Builder
  ShopInfoCard() {
    Column() {
      // åº—é“ºè¯¦æƒ…ä¿¡æ¯
      Row() {
        // è¥ä¸šæ—¶é—´
        Column() {
          Row() {
            Image($r('app.media.time'))
              .width(14)
              .height(14)
              .margin({ right: 6 })
            Text('è¥ä¸šæ—¶é—´')
              .fontSize(11)
              .fontColor('#666666')
          }
          .alignItems(VerticalAlign.Center)
          .justifyContent(FlexAlign.Start)

          Text(this.shopInfo.business_hours || this.shopInfo.businessHours)
            .fontSize(12)
            .fontColor('#333333')
            .margin({ top: 4 })
            .textAlign(TextAlign.Start)
            .width('100%')
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)
        .padding({ right: 10 })

        // åº—é“ºåœ°å€
        Column() {
          Row() {
            Image($r('app.media.location'))
              .width(14)
              .height(14)
              .margin({ right: 6 })
            Text('åº—é“ºåœ°å€')
              .fontSize(11)
              .fontColor('#666666')
          }
          .alignItems(VerticalAlign.Center)
          .justifyContent(FlexAlign.Start)

          Row({ space: 8 }) {
            Text(this.shopInfo.address)
              .fontSize(12)
              .fontColor('#333333')
              .margin({ top: 4 })
              .textAlign(TextAlign.Start)
              .width('100%')
              .maxLines(2)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .layoutWeight(1)

            Button({ type: ButtonType.Normal }) {
              Row({ space: 4 }) {
                Image($r('app.media.location'))
                  .width(14)
                  .height(14)
                  .fillColor('#FFFFFF')
                Text('æŸ¥çœ‹åœ°å›¾')
                  .fontSize(11)
                  .fontColor('#FFFFFF')
              }
              .alignItems(VerticalAlign.Center)
            }
            .height(28)
            .padding({ left: 10, right: 10 })
            .backgroundColor('#007DFF')
            .borderRadius(16)
            .onClick(() => {
              this.openMapPreview();
            })
          }
          .alignItems(VerticalAlign.Center)
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)
        .padding({ left: 10 })
      }
      .width('100%')
      .padding({
        top: 12,
        bottom: 12,
        left: 16,
        right: 16
      })
      .alignItems(VerticalAlign.Top)
    }
    .width('94%')
    .backgroundColor('#FFFFFF')
    .borderRadius(18)
    .margin({ top: 8, bottom: 2, left: '3%', right: '3%' })
    .padding({ top: 14, bottom: 14, left: 14, right: 14 })
    .shadow({
      radius: 16,
      color: '#15000000',
      offsetX: 0,
      offsetY: 6
    })
  }

  // ä¸»æ¨èœå“åŒºåŸŸ - è½®æ’­å±•ç¤ºdish1-dish5å›¾ç‰‡
  @Builder
  RecommendedDishesSection(slides: Dish[]) {
    Column() {
      if (slides.length > 0) {
        Row() {
          Row({ space: 8 }) {
            Image($r('app.media.recommend_tag'))
              .width(20)
              .height(20)
              .fillColor('#FF6B00')
            Text('ä¸»æ¨èœå“')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#1A1A1A')
          }
          .layoutWeight(1)

          Row({ space: 4 }) {
            Text('è‡ªåŠ¨è½®æ’­')
              .fontSize(11)
              .fontColor('#999999')
            Image($r('app.media.arrow_right'))
              .width(12)
              .height(12)
              .fillColor('#999999')
          }
        }
        .width('100%')
        .padding({ left: 18, right: 18, top: 10, bottom: 8 })

        Swiper() {
          ForEach(slides, (dish: Dish, index: number) => {
            Column() {
              this.FeaturedDishCard(dish)
            }
            .width('100%')
          }, (dish: Dish, index: number) => `featured-${dish.id}-${index}`)
        }
        .height(300)
        .width('100%')
        .padding({ left: 16, right: 16 })
        .indicator(false)
        .loop(true)
        .autoPlay(true)
        .interval(3500)
        .duration(400)
        .cachedCount(5)
        .itemSpace(12)
        .displayCount(1)
        .index(this.featuredActiveIndex)
        .onChange((index: number) => {
          this.featuredActiveIndex = index;
        })

        // è½®æ’­æŒ‡ç¤ºå™¨ - æ›´ç¾è§‚çš„è®¾è®¡
        Row({ space: 8 }) {
          ForEach(slides, (_dish: Dish, index: number) => {
            Column()
              .width(this.featuredActiveIndex === index ? 24 : 8)
              .height(8)
              .borderRadius(4)
              .backgroundColor(this.featuredActiveIndex === index ? '#007DFF' : '#E0E0E0')
              .animation({ duration: 300, curve: Curve.EaseInOut })
          }, (_dish: Dish, index: number) => `indicator-${index}`)
        }
        .justifyContent(FlexAlign.Center)
        .padding({ top: 12, bottom: 8 })
      }
    }
    .width('100%')
    .backgroundColor('#FFFFFF')
    .borderRadius(20)
    .margin({ left: 12, right: 12, top: 4, bottom: 0 })
    .padding({ top: 4, bottom: 4 })
    .shadow({
      radius: 16,
      color: '#10000000',
      offsetX: 0,
      offsetY: 4
    })
  }

  @Builder
  FeaturedDishCard(dish: Dish) {
    Column() {
      Stack({ alignContent: Alignment.BottomStart }) {
        if (dish.imageUrl && dish.imageUrl.startsWith('app.media.')) {
          Image($r(dish.imageUrl))
            .width('100%')
            .height(200)
            .borderRadius(16)
            .objectFit(ImageFit.Cover)
        } else if (dish.imageUrl) {
          Image(this.normalizeDishImagePath(dish.imageUrl))
            .width('100%')
            .height(200)
            .borderRadius(16)
            .objectFit(ImageFit.Cover)
        } else {
          Image($r('app.media.dish1'))
            .width('100%')
            .height(200)
            .borderRadius(16)
            .objectFit(ImageFit.Cover)
        }

        // æ¸å˜é®ç½©å±‚å’Œä¿¡æ¯
        Column() {
          Row({ space: 8 }) {
            Text('ä¸»æ¨')
              .fontSize(11)
              .fontColor('#FFFFFF')
              .padding({ left: 8, right: 8, top: 4, bottom: 4 })
              .backgroundColor('#FF6B00')
              .borderRadius(10)
            Text(`æœˆå”®${dish.sales}ä»½`)
              .fontSize(11)
              .fontColor('#FFFFFF')
              .padding({ left: 8, right: 8, top: 4, bottom: 4 })
              .backgroundColor('#00000060')
              .borderRadius(10)
          }
          .margin({ bottom: 8 })

          Text(dish.name || 'ç²¾é€‰èœå“')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FFFFFF')
            .margin({ bottom: 4 })

          Text(dish.description || 'ä»Šæ—¥ç²¾é€‰æ¨è')
            .fontSize(13)
            .fontColor('#FFFFFFDD')
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }
        .padding({ left: 16, right: 16, bottom: 16, top: 40 })
        .width('100%')
        .linearGradient({
          direction: GradientDirection.Bottom,
          colors: [['#00000000', 0], ['#00000080', 0.5], ['#000000CC', 1]]
        })
        .borderRadius({ bottomLeft: 16, bottomRight: 16 })
        .alignItems(HorizontalAlign.Start)
      }

      // åº•éƒ¨ä»·æ ¼å’ŒåŠ å…¥è´­ç‰©è½¦æŒ‰é’®
      Row() {
        Column({ space: 2 }) {
          Row() {
            Text('Â¥')
              .fontSize(14)
              .fontColor('#FF3B30')
              .fontWeight(FontWeight.Bold)
            Text(dish.price.toFixed(2))
              .fontSize(22)
              .fontColor('#FF3B30')
              .fontWeight(FontWeight.Bold)
          }
          Row({ space: 4 }) {
            Image($r('app.media.star'))
              .width(12)
              .height(12)
              .fillColor('#FFB800')
            Text(`${(dish.rating || 4.8).toFixed(1)}åˆ†`)
              .fontSize(11)
              .fontColor('#888888')
          }
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)

        Button({ type: ButtonType.Normal, stateEffect: true }) {
          Row({ space: 6 }) {
            Image($r('app.media.shopping_cart'))
              .width(16)
              .height(16)
              .fillColor('#FFFFFF')
            Text('åŠ å…¥è´­ç‰©è½¦')
              .fontSize(13)
              .fontColor('#FFFFFF')
              .fontWeight(FontWeight.Medium)
          }
        }
        .height(36)
        .padding({ left: 16, right: 16 })
        .backgroundColor('#007DFF')
        .borderRadius(18)
        .onClick(() => {
          this.addToCart(dish);
        })
      }
      .width('100%')
      .padding({ top: 12, left: 4, right: 4 })
    }
    .width('100%')
    .padding(8)
    .backgroundColor('#FFFFFF')
    .borderRadius(20)
    .shadow({
      radius: 12,
      color: '#15000000',
      offsetX: 0,
      offsetY: 4
    })
  }

  // èœå“ä¿¡æ¯åŒºåŸŸï¼ˆåˆ†ç±»å¯¼èˆª + èœå“åˆ—è¡¨ï¼‰
  @Builder
  DishesSection() {
    Column() {
      // åˆ†ç±»å¯¼èˆª
      this.CategoryTabs()

      // èœå“åˆ—è¡¨
      if (this.isLoading) {
        this.LoadingView()
      } else {
        this.DishListView()
      }
    }
    .width('100%')
    .backgroundColor('#FFFFFF')
    .borderRadius(20)
    .margin({ left: 12, right: 12, top: 8 })
    .padding({ bottom: 16 })
    .shadow({
      radius: 12,
      color: '#08000000',
      offsetX: 0,
      offsetY: 2
    })
  }

  // åˆ†ç±»å¯¼èˆª - ä¼˜åŒ–æ»‘åŠ¨ä½“éªŒ
  @Builder
  CategoryTabs() {
    Column() {
      Row() {
        Row({ space: 8 }) {
          Text('ğŸ½')
            .fontSize(18)
          Text('èœå“åˆ†ç±»')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1A1A1A')
        }
        .layoutWeight(1)

        Text('å·¦å³æ»‘åŠ¨')
          .fontSize(11)
          .fontColor('#AAAAAA')
      }
      .width('100%')
      .padding({ left: 18, right: 18, top: 12, bottom: 10 })

      // ä½¿ç”¨Listç»„ä»¶å®ç°æ›´æµç•…çš„æ¨ªå‘æ»‘åŠ¨
      List({ space: 10 }) {
        ForEach(this.categories, (category: string, index: number) => {
          ListItem() {
            Column() {
              Text(category)
                .fontSize(14)
                .fontWeight(this.selectedCategory === category ? FontWeight.Bold : FontWeight.Medium)
                .fontColor(this.selectedCategory === category ? '#FFFFFF' : '#666666')
                .padding({
                  left: 20,
                  right: 20,
                  top: 10,
                  bottom: 10
                })
                .backgroundColor(this.selectedCategory === category ? '#007DFF' : '#F0F2F5')
                .borderRadius(20)
                .shadow(this.selectedCategory === category ? {
                  radius: 8,
                  color: '#40007DFF',
                  offsetX: 0,
                  offsetY: 2
                } : {
                  radius: 0,
                  color: '#00000000',
                  offsetX: 0,
                  offsetY: 0
                })
            }
            .onClick(() => {
              this.selectedCategory = category;
            })
          }
        }, (category: string) => category)
      }
      .listDirection(Axis.Horizontal)
      .scrollBar(BarState.Off)
      .width('100%')
      .height(50)
      .padding({ left: 16, right: 16 })
      .edgeEffect(EdgeEffect.Spring)
    }
    .width('100%')
  }

  // å³ä¸‹è§’æµ®åŠ¨è´­ç‰©è½¦æŒ‰é’® - ä¼˜åŒ–è®¾è®¡
  @Builder
  FloatingCartButton() {
    Column() {
      // è´­ç‰©è½¦æŒ‰é’®
      Button({ type: ButtonType.Normal }) {
        Stack({ alignContent: Alignment.TopEnd }) {
          Column() {
            Image($r('app.media.shopping_cart'))
              .width(24)
              .height(24)
              .fillColor('#FFFFFF')
          }
          .width(56)
          .height(56)
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)

          // è´­ç‰©è½¦æ•°é‡å¾½ç« 
          if (this.cartItemCount > 0) {
            Text(this.cartItemCount > 99 ? '99+' : this.cartItemCount.toString())
              .fontSize(10)
              .fontColor('#FFFFFF')
              .fontWeight(FontWeight.Bold)
              .backgroundColor('#FF3B30')
              .padding({
                left: this.cartItemCount > 9 ? 5 : 6,
                right: this.cartItemCount > 9 ? 5 : 6,
                top: 2,
                bottom: 2
              })
              .borderRadius(10)
              .textAlign(TextAlign.Center)
              .border({ width: 2, color: '#FFFFFF' })
              .position({ x: 32, y: 2 })
          }
        }
      }
      .width(56)
      .height(56)
      .backgroundColor('#007DFF')
      .borderRadius(28)
      .shadow({
        radius: 16,
        color: '#50007DFF',
        offsetX: 0,
        offsetY: 6
      })
      .onClick(() => {
        router.pushUrl({ url: 'pages/CartPage' });
      })

      // æ˜¾ç¤ºæ€»é‡‘é¢
      if (this.cartTotalAmount > 0) {
        Text(`Â¥${this.cartTotalAmount.toFixed(0)}`)
          .fontSize(11)
          .fontColor('#007DFF')
          .fontWeight(FontWeight.Bold)
          .margin({ top: 4 })
      }
    }
    .alignItems(HorizontalAlign.Center)
  }

  // åŠ è½½è§†å›¾
  @Builder
  LoadingView() {
    Column() {
      LoadingProgress()
        .width(50)
        .height(50)
        .color('#007DFF')

      Text('ç¾å‘³åŠ è½½ä¸­...')
        .fontSize(14)
        .fontColor('#666666')
        .margin({ top: 16 })
    }
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  // èœå“åˆ—è¡¨è§†å›¾
  @Builder
  DishListView() {
    Column() {
      if (this.getFilteredDishes().length === 0) {
        this.EmptyDishView()
      } else {
        // æ˜¾ç¤ºèœå“æ•°é‡
        Row() {
          Text(`å…± ${this.getFilteredDishes().length} é“èœå“`)
            .fontSize(12)
            .fontColor('#999999')
        }
        .width('100%')
        .padding({ left: 18, right: 18, top: 8, bottom: 4 })

        Column({ space: 10 }) {
          ForEach(this.getFilteredDishes(), (dish: Dish) => {
            this.DishItem(dish)
          }, (dish: Dish) => dish.id.toString())
        }
        .width('100%')
        .padding({ left: 12, right: 12, bottom: 16, top: 4 })
      }
    }
  }

  // ç©ºçŠ¶æ€è§†å›¾
  @Builder
  EmptyDishView() {
    Column() {
      Image($r('app.media.empty'))
        .width(150)
        .height(150)
        .margin({ bottom: 24 })

      Text('æš‚æ— èœå“')
        .fontSize(16)
        .fontColor('#999999')
        .margin({ bottom: 8 })

      if (!this.isCustomerMode) {
        Text('å½“å‰åˆ†ç±»æš‚æ— èœå“ï¼Œå¿«å»æ·»åŠ å§')
          .fontSize(14)
          .fontColor('#CCCCCC')

        Button({ type: ButtonType.Capsule, stateEffect: true }) {
          Text('æ·»åŠ èœå“')
            .fontSize(14)
            .fontColor('#FFFFFF')
            .fontWeight(FontWeight.Medium)
        }
        .height(38)
        .padding({ left: 24, right: 24 })
        .backgroundColor('#007DFF')
        .borderRadius(19)
        .margin({ top: 20 })
        .onClick(() => {
          this.navigateToAddDishPage();
        })
      } else {
        Text('è¯·ç¨å€™ï¼ŒæœåŠ¡å‘˜å°†ä¸ºæ‚¨æ¨èèœå“')
          .fontSize(14)
          .fontColor('#CCCCCC')
      }
    }
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  // èœå“é¡¹ - ä¼˜åŒ–è®¾è®¡
  @Builder
  DishItem(dish: Dish) {
    Row() {
      // èœå“å›¾ç‰‡
      Stack({ alignContent: Alignment.TopStart }) {
        if (dish.imageUrl) {
          if (dish.imageUrl.startsWith('app.media.')) {
            Image($r(dish.imageUrl))
              .width(100)
              .height(100)
              .borderRadius(12)
              .objectFit(ImageFit.Cover)
          } else {
            Image(this.normalizeDishImagePath(dish.imageUrl))
              .width(100)
              .height(100)
              .borderRadius(12)
              .objectFit(ImageFit.Cover)
          }
        } else {
          Image($r('app.media.dish1'))
            .width(100)
            .height(100)
            .borderRadius(12)
            .objectFit(ImageFit.Cover)
        }

        // æ¨èæ ‡ç­¾
        if (dish.isRecommended) {
          Text('è')
            .fontSize(10)
            .fontColor('#FFFFFF')
            .padding({ left: 6, right: 6, top: 3, bottom: 3 })
            .backgroundColor('#FF6B00')
            .borderRadius({ topLeft: 12, bottomRight: 8 })
        }
      }
      .margin({ right: 12 })

      // èœå“ä¿¡æ¯
      Column() {
        // åç§°å’Œè¯„åˆ†
        Row() {
          Text(dish.name)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1A1A1A')
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .layoutWeight(1)

          Row({ space: 2 }) {
            Image($r('app.media.star'))
              .width(12)
              .height(12)
              .fillColor('#FFB800')
            Text((dish.rating || 4.5).toFixed(1))
              .fontSize(12)
              .fontColor('#FF9500')
              .fontWeight(FontWeight.Medium)
            Text('ç‚¹å‡»è¯„ä»·')
              .fontSize(10)
              .fontColor('#007DFF')
              .margin({ left: 4 })
          }
          .onClick(() => {
            // è·³è½¬åˆ°èœå“è¯¦æƒ…é¡µè¿›è¡Œè¯„ä»·
            router.pushUrl({
              url: 'pages/DishDetailPage',
              params: { dishId: dish.id, dish: dish }
            });
          })
        }
        .width('100%')

        // æè¿°
        Text(dish.description || 'ç¾å‘³å¯å£ï¼Œå€¼å¾—å“å°')
          .fontSize(12)
          .fontColor('#888888')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .margin({ top: 4 })

        // é”€é‡æ ‡ç­¾
        Row({ space: 8 }) {
          Text(`æœˆå”®${dish.sales}`)
            .fontSize(11)
            .fontColor('#999999')
          if (dish.cookingMethod) {
            Text(dish.cookingMethod)
              .fontSize(11)
              .fontColor('#007DFF')
              .padding({ left: 6, right: 6, top: 2, bottom: 2 })
              .backgroundColor('#E6F2FF')
              .borderRadius(4)
          }
        }
        .margin({ top: 6 })

        // ä»·æ ¼å’Œè´­ç‰©è½¦æŒ‰é’®
        Row() {
          Row() {
            Text('Â¥')
              .fontSize(14)
              .fontColor('#FF3B30')
              .fontWeight(FontWeight.Bold)
            Text(dish.price.toFixed(2))
              .fontSize(18)
              .fontColor('#FF3B30')
              .fontWeight(FontWeight.Bold)
          }
          .layoutWeight(1)

          // åŠ å…¥è´­ç‰©è½¦æŒ‰é’®
          Button({ type: ButtonType.Circle, stateEffect: true }) {
            Text('+')
              .fontSize(20)
              .fontColor('#FFFFFF')
              .fontWeight(FontWeight.Bold)
          }
          .width(32)
          .height(32)
          .backgroundColor('#007DFF')
          .shadow({
            radius: 6,
            color: '#40007DFF',
            offsetX: 0,
            offsetY: 2
          })
          .onClick(() => {
            console.info('åŠ å…¥è´­ç‰©è½¦æŒ‰é’®è¢«ç‚¹å‡»ï¼Œèœå“ï¼š' + dish.name);
            this.addToCart(dish);
          })
        }
        .width('100%')
        .margin({ top: 8 })
        .alignItems(VerticalAlign.Center)
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)
      .justifyContent(FlexAlign.SpaceBetween)
      .height(100)
    }
    .width('100%')
    .padding(12)
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .shadow({
      radius: 8,
      color: '#0A000000',
      offsetX: 0,
      offsetY: 2
    })
    .onClick(() => {
      this.openDishDetail(dish);
    })
  }

  @Builder
  StarRating(score: number, size: number = 16, interactive: boolean = false, onChange?: (value: number) => void) {
    Row({ space: 4 }) {
      ForEach([0, 1, 2, 3, 4], (index: number) => {
        Image($r('app.media.star'))
          .width(size)
          .height(size)
          .fillColor(score >= index + 1 ? '#FFB800' : '#D9D9D9')
          .opacity(score >= index + 1 ? 1 : (score > index && score < index + 1 ? 0.7 : 0.4))
          .onClick(() => {
            if (interactive && onChange) {
              onChange(index + 1);
            }
          })
      }, (index: number) => index.toString())
    }
  }

  @Builder
  DishDetailDialog() {
    Column() {
      Blank()
        .layoutWeight(1)
        .onClick(() => {
          this.closeDishDetail();
        })

      Column() {
        Row() {
          Text('èœå“è¯¦æƒ…')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1A1A1A')
            .layoutWeight(1)
            .textAlign(TextAlign.Center)

          Image($r('app.media.back_icon'))
            .width(24)
            .height(24)
            .fillColor('#333333')
            .onClick(() => {
              this.closeDishDetail();
            })
        }
        .width('100%')
        .padding({ left: 20, right: 20, top: 16, bottom: 8 })

        Scroll() {
          Column({ space: 20 }) {
            if (this.selectedDish) {
              this.DishHeroSection(this.selectedDish)
              this.DishMetaSection(this.selectedDish)
              this.DishCookingSection(this.selectedDish)
              this.DishReviewSection(this.selectedDish, this.getDishReviews(this.selectedDish.id))
            }
          }
          .width('100%')
          .padding({ left: 20, right: 20, bottom: 120 })
        }
        .layoutWeight(1)

        Row({ space: 12 }) {
          Button('åŠ å…¥è´­ç‰©è½¦', { type: ButtonType.Normal, stateEffect: true })
            .layoutWeight(1)
            .height(48)
            .backgroundColor('#007DFF')
            .fontColor('#FFFFFF')
            .fontSize(16)
            .borderRadius(24)
            .onClick(() => {
              if (this.selectedDish) {
                this.addToCart(this.selectedDish);
              }
            })
        }
        .width('100%')
        .padding({ left: 20, right: 20, top: 12, bottom: 28 })
        .backgroundColor('#FFFFFF')
        .shadow({
          radius: 12,
          color: '#20000000',
          offsetX: 0,
          offsetY: -4
        })
      }
      .width('100%')
      .height('82%')
      .backgroundColor('#FFFFFF')
      .borderRadius({ topLeft: 24, topRight: 24 })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#99000000')
  }

  @Builder
  MapPreviewDialog() {
    Column() {
      Blank()
        .layoutWeight(1)
        .onClick(() => {
          this.closeMapDialog();
        })

      Column({ space: 12 }) {
        Row() {
          Text('åº—é“ºåœ°å›¾')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .layoutWeight(1)
            .textAlign(TextAlign.Center)

          Image($r('app.media.close'))
            .width(20)
            .height(20)
            .fillColor('#333333')
            .onClick(() => {
              this.closeMapDialog();
            })
        }
        .width('100%')
        .padding({ left: 20, right: 20, top: 18, bottom: 10 })

        // é™æ€åœ°å›¾é¢„è§ˆï¼ˆMap SDKæš‚ä¸å¯ç”¨ï¼‰
        Column() {
          Image($r('app.media.location'))
            .width(48)
            .height(48)
            .fillColor('#007DFF')
            .margin({ bottom: 12 })

          Text('åº—é“ºä½ç½®')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#1A1A1A')
            .margin({ bottom: 8 })

          Text(`ç»åº¦: ${this.mapCenterLng.toFixed(4)}`)
            .fontSize(13)
            .fontColor('#666666')
            .margin({ bottom: 4 })

          Text(`çº¬åº¦: ${this.mapCenterLat.toFixed(4)}`)
            .fontSize(13)
            .fontColor('#666666')
        }
        .width('92%')
        .height(260)
        .borderRadius(20)
        .backgroundColor('#F5F8FF')
        .alignSelf(ItemAlign.Center)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)

        Column({ space: 4 }) {
          Text('åº—é“ºåœ°å€')
            .fontSize(13)
            .fontColor('#888888')
          Text(this.shopInfo.address || 'æœªé…ç½®')
            .fontSize(15)
            .fontColor('#1A1A1A')
            .fontWeight(FontWeight.Medium)
        }
        .width('90%')
        .alignSelf(ItemAlign.Center)

        Button('æˆ‘çŸ¥é“äº†', { type: ButtonType.Capsule, stateEffect: true })
          .width('90%')
          .height(46)
          .backgroundColor('#007DFF')
          .fontColor('#FFFFFF')
          .fontSize(16)
          .borderRadius(23)
          .alignSelf(ItemAlign.Center)
          .margin({ bottom: 24 })
          .onClick(() => {
            this.closeMapDialog();
          })
      }
      .width('100%')
      .backgroundColor('#FFFFFF')
      .borderRadius({ topLeft: 24, topRight: 24 })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#80000000')
  }

  @Builder
  DishHeroSection(dish: Dish) {
    Column({ space: 12 }) {
      Stack() {
        if (dish.imageUrl && dish.imageUrl.startsWith('app.media.')) {
          Image($r(dish.imageUrl))
            .width('100%')
            .height(220)
            .borderRadius(20)
            .objectFit(ImageFit.Cover)
        } else if (dish.imageUrl) {
          Image(this.normalizeDishImagePath(dish.imageUrl))
            .width('100%')
            .height(220)
            .borderRadius(20)
            .objectFit(ImageFit.Cover)
        } else {
          Image($r('app.media.image_gallery'))
            .width('100%')
            .height(220)
            .borderRadius(20)
            .objectFit(ImageFit.Cover)
        }

        Column({ space: 6 }) {
          Row({ space: 12 }) {
            Text(dish.category || 'ç¾å‘³èœå“')
              .fontSize(12)
              .fontColor('#FFFFFF')
              .padding({ left: 10, right: 10, top: 6, bottom: 6 })
              .backgroundColor('#40000000')
              .borderRadius(14)

            Text(dish.cookTime || this.getDefaultCookTime(dish.category))
              .fontSize(12)
              .fontColor('#FFFFFF')
              .padding({ left: 10, right: 10, top: 6, bottom: 6 })
              .backgroundColor('#40000000')
              .borderRadius(14)
          }

          Column({ space: 6 }) {
            Row({ space: 6 }) {
              this.StarRating(dish.rating || 0)
              Text(`${(dish.rating || 0).toFixed(1)}åˆ†`)
                .fontSize(14)
                .fontColor('#FFFFFF')
                .fontWeight(FontWeight.Medium)
              Text(`${dish.reviewCount || 0} æ¡è¯„ä»·`)
                .fontSize(12)
                .fontColor('#F5F5F5')
            }
            Text(dish.name)
              .fontSize(22)
              .fontWeight(FontWeight.Bold)
              .fontColor('#FFFFFF')

            Text(dish.description || 'å¨å¸ˆç²¾é€‰ Â· ç°ç‚¹ç°åš Â· ç¾å‘³å³è¾¾')
              .fontSize(13)
              .fontColor('#F2F2F2')
              .maxLines(2)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
          }
        }
        .padding({ left: 16, right: 16, bottom: 18, top: 18 })
        .width('100%')
        .backgroundImage('linear-gradient(to top, rgba(0,0,0,0.7), rgba(0,0,0,0.05))')
        .borderRadius(20)
        .alignItems(HorizontalAlign.Start)
      }

      Row({ space: 24 }) {
        this.DishStatCard('å”®ä»·', `Â¥${dish.price.toFixed(2)}`, 'æ¯æ—¥é™é‡ä¾›åº”')
        this.DishStatCard('æœˆå”®', `${dish.sales} ä»½`, 'å‡ºé¤é«˜å³°å¸¸å”®ç½„')
      }

      Row({ space: 10 }) {
        ForEach(this.resolveFlavorTags(dish), (tag: string) => {
          Text(tag)
            .fontSize(12)
            .fontColor('#007DFF')
            .padding({ left: 12, right: 12, top: 6, bottom: 6 })
            .backgroundColor('#E8F2FF')
            .borderRadius(14)
        }, (tag: string) => `${dish.id}-${tag}`)
      }
    }
  }

  @Builder
  DishStatCard(title: string, value: string, tip: string) {
    Column({ space: 4 }) {
      Text(title)
        .fontSize(12)
        .fontColor('#999999')
      Text(value)
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1A1A1A')
      Text(tip)
        .fontSize(11)
        .fontColor('#BBBBBB')
    }
    .padding({ left: 16, right: 16, top: 12, bottom: 12 })
    .backgroundColor('#F7F9FC')
    .borderRadius(16)
    .layoutWeight(1)
  }

  @Builder
  DishMetaSection(dish: Dish) {
    Column({ space: 12 }) {
      Text('èœå“äº®ç‚¹')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1A1A1A')

      Column({ space: 12 }) {
        this.DetailInfoRow('æ‰€å±åˆ†ç±»', dish.category || 'æš‚æ— åˆ†ç±»ä¿¡æ¯')
        this.DetailInfoRow('é¢„è®¡å‡ºé¤', dish.cookTime || this.getDefaultCookTime(dish.category))
        this.DetailInfoRow('ä¸»è¦é£Ÿæ', dish.ingredients || this.getDefaultIngredients(dish.category))
      }
      .padding(16)
      .backgroundColor('#FFFFFF')
      .borderRadius(16)
      .shadow({
        radius: 6,
        color: '#08000000',
        offsetX: 0,
        offsetY: 2
      })
    }
  }

  @Builder
  DetailInfoRow(label: string, value: string) {
    Column() {
      Text(label)
        .fontSize(12)
        .fontColor('#999999')
      Text(value)
        .fontSize(14)
        .fontColor('#1A1A1A')
        .fontWeight(FontWeight.Medium)
        .margin({ top: 4 })
    }
  }

  @Builder
  DishCookingSection(dish: Dish) {
    Column({ space: 10 }) {
      Text('çƒ¹é¥ªæ–¹å¼')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1A1A1A')

      Text(dish.cookingMethod || 'å¨å¸ˆæ­£åœ¨è¡¥å……è¯¦ç»†åšæ³•ï¼Œæ•¬è¯·æœŸå¾…ã€‚')
        .fontSize(14)
        .fontColor('#555555')
        .lineHeight(22)
        .backgroundColor('#FFFFFF')
        .padding(16)
        .borderRadius(16)
    }
  }

  @Builder
  DishReviewSection(dish: Dish, reviews: DishReview[]) {
    Column({ space: 12 }) {
      Text('é£Ÿå®¢è¯„ä»·')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1A1A1A')

      if (reviews.length === 0) {
        Column() {
          Text('è¿˜æ²¡æœ‰è¯„ä»·ï¼Œæˆä¸ºç¬¬ä¸€ä½å“é‰´å®˜å§')
            .fontSize(13)
            .fontColor('#999999')
        }
        .width('100%')
        .padding(16)
        .backgroundColor('#FFFFFF')
        .borderRadius(16)
      } else {
        Column({ space: 12 }) {
          ForEach(reviews, (review: DishReview) => {
            this.ReviewCard(review)
          }, (review: DishReview) => review.id.toString())
        }
      }

      Column({ space: 12 }) {
        Text('å†™ä¸‹ä½ çš„æ„Ÿå—')
          .fontSize(15)
          .fontWeight(FontWeight.Medium)
          .fontColor('#1A1A1A')

        Row({ space: 8 }) {
          Text('è¯„åˆ†')
            .fontSize(13)
            .fontColor('#666666')
          this.StarRating(this.reviewRating, 20, true, (value: number) => {
            this.reviewRating = value;
          })
          Text(`${this.reviewRating} åˆ†`)
            .fontSize(12)
            .fontColor('#FF9500')
        }

        TextInput({ placeholder: 'åˆ†äº«å£å‘³ã€å£æ„Ÿæˆ–æ­é…å»ºè®®', text: this.reviewContent })
          .width('100%')
          .height(90)
          .backgroundColor('#F5F5F5')
          .borderRadius(12)
          .padding(12)
          .maxLines(4)
          .onChange((value: string) => {
            this.reviewContent = value;
          })

        Button('æäº¤è¯„ä»·', { type: ButtonType.Capsule, stateEffect: true })
          .width('100%')
          .height(44)
          .backgroundColor('#34C759')
          .fontColor('#FFFFFF')
          .fontSize(15)
          .borderRadius(22)
          .enabled(this.reviewContent.trim().length > 0)
          .opacity(this.reviewContent.trim().length > 0 ? 1 : 0.5)
          .onClick(() => {
            this.submitDishReview();
          })
      }
      .padding(16)
      .backgroundColor('#FFFFFF')
      .borderRadius(16)
    }
  }

  @Builder
  ReviewCard(review: DishReview) {
    Column({ space: 8 }) {
      Row({ space: 10 }) {
        Image($r('app.media.ic_user_avatar'))
          .width(36)
          .height(36)
          .borderRadius(18)
          .backgroundColor('#F0F0F0')

        Column() {
          Text(review.user)
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .fontColor('#1A1A1A')
          Row({ space: 6 }) {
            this.StarRating(review.rating, 14, false)
            Text(this.formatReviewTime(review.createdAt))
              .fontSize(11)
              .fontColor('#999999')
          }
        }
        .layoutWeight(1)
      }

      Text(review.content)
        .fontSize(13)
        .fontColor('#444444')
        .lineHeight(20)

      if (review.highlights && review.highlights.length > 0) {
        Row({ space: 8 }) {
          ForEach(review.highlights, (tag: string) => {
            Text(tag)
              .fontSize(11)
              .fontColor('#FF6B00')
              .padding({ left: 10, right: 10, top: 4, bottom: 4 })
              .backgroundColor('#FFF3E6')
              .borderRadius(12)
          }, (tag: string) => `${review.id}-${tag}`)
        }
      }
    }
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderRadius(16)
    .shadow({
      radius: 4,
      color: '#08000000',
      offsetX: 0,
      offsetY: 2
    })
  }

  openDishDetail(dish: Dish) {
    if (!dish) {
      return;
    }
    // è·³è½¬åˆ°ç‹¬ç«‹çš„èœå“è¯¦æƒ…é¡µé¢
    router.pushUrl({
      url: 'pages/DishDetailPage',
      params: {
        dishId: dish.id,
        dish: dish
      }
    });
  }

  closeDishDetail() {
    this.showDishDetail = false;
    this.selectedDish = undefined;
    this.reviewContent = '';
  }

  private getDishReviews(dishId: number): DishReview[] {
    return this.dishReviewStore[dishId] ? this.dishReviewStore[dishId] : [];
  }

  private createDefaultReviews(dish: Dish): DishReview[] {
    const now = Date.now();
    const baseRating = dish.rating || 4.8;
    return [
      {
        id: Number(`${dish.id}01`),
        user: 'ç¾é£Ÿå®¢Â·æ¸©æš–',
        rating: Math.min(5, Math.max(4, Math.round(baseRating))),
        content: `${dish.name} éå¸¸ä¸‹é¥­ï¼Œå£æ„Ÿå±‚æ¬¡ä¸°å¯Œï¼Œæ­é…ç±³é¥­ä¸€ç»ï¼`,
        createdAt: now - 1000 * 60 * 60 * 4,
        highlights: ['å£å‘³æ­£å®—', 'åˆ†é‡è¶³']
      },
      {
        id: Number(`${dish.id}02`),
        user: 'åƒè´§ç¬”è®°',
        rating: Math.min(5, Math.max(4, Math.round(baseRating - 0.2))),
        content: 'é£Ÿææ–°é²œï¼Œç«å€™æŠŠæ¡å¾—å¾ˆå¥½ï¼Œæ¨èåŠ ä¸€ä»½æ‹›ç‰Œé¥®å“æ›´æ­ã€‚',
        createdAt: now - 1000 * 60 * 60 * 10,
        highlights: ['å‡ºé¤å¿«', 'ç¯å¢ƒå¥½']
      }
    ];
  }

  private submitDishReview() {
    if (!this.selectedDish) {
      return;
    }
    const content = this.reviewContent.trim();
    if (content.length === 0) {
      ToastUtils.showToast('è¯·è¾“å…¥è¯„ä»·å†…å®¹');
      return;
    }
    const dishId = this.selectedDish.id;
    const current = this.getDishReviews(dishId);
    const newReview: DishReview = {
      id: Date.now(),
      user: 'åŒ¿åé£Ÿå®¢',
      rating: this.reviewRating,
      content,
      createdAt: Date.now(),
      highlights: ['å£å‘³', 'æœåŠ¡']
    };
    const updated: DishReview[] = current.concat(newReview);
    if (!this.dishReviewStore) {
      this.dishReviewStore = {};
    }
    this.dishReviewStore[dishId] = updated;
    this.reviewContent = '';
    this.reviewRating = 5;
    this.recalculateDishRating(dishId, updated);
    ToastUtils.showToast('æ„Ÿè°¢æ‚¨çš„è¯„ä»·');
  }

  private recalculateDishRating(dishId: number, reviews: DishReview[]) {
    if (reviews.length === 0) {
      return;
    }
    const total = reviews.reduce((sum: number, review: DishReview) => sum + review.rating, 0);
    const avg = parseFloat((total / reviews.length).toFixed(1));
    this.dishes = this.dishes.map((item: Dish) => {
      if (item.id === dishId) {
        const updated = this.cloneDish(item);
        updated.rating = avg;
        updated.reviewCount = reviews.length;
        if (this.selectedDish && this.selectedDish.id === dishId) {
          this.selectedDish = updated;
        }
        return updated;
      }
      return item;
    });
  }

  private resolveFlavorTags(dish: Dish): string[] {
    if (dish.flavorTags && dish.flavorTags.length > 0) {
      return dish.flavorTags;
    }
    return this.getDefaultFlavorTags(dish.category);
  }

  private formatReviewTime(timestamp: number): string {
    const diff = Date.now() - timestamp;
    const minutes = Math.floor(diff / (1000 * 60));
    if (minutes < 60) {
      return `${Math.max(1, minutes)}åˆ†é’Ÿå‰`;
    }
    const hours = Math.floor(minutes / 60);
    if (hours < 24) {
      return `${hours}å°æ—¶å‰`;
    }
    const days = Math.floor(hours / 24);
    return `${days}å¤©å‰`;
  }

  private cloneDish(dish: Dish): Dish {
    const cloned = new Dish();
    // ArkTS å¯¹æ ‡å‡†åº“çš„é™åˆ¶ä½¿å¾—ä¸èƒ½ç›´æ¥ä½¿ç”¨ Object.assignï¼Œè¿™é‡Œé€å­—æ®µå¤åˆ¶
    cloned.id = dish.id;
    cloned.name = dish.name;
    cloned.category = dish.category;
    cloned.price = dish.price;
    cloned.imageUrl = dish.imageUrl;
    cloned.description = dish.description;
    cloned.sales = dish.sales;
    cloned.tags = dish.tags;
    cloned.isSignature = dish.isSignature;
    cloned.isNew = dish.isNew;
    cloned.isRecommended = dish.isRecommended;
    cloned.rating = dish.rating;
    cloned.reviewCount = dish.reviewCount;
    cloned.flavorTags = dish.flavorTags;
    return cloned;
  }

  // æ·»åŠ èœå“å¯¹è¯æ¡†
  @Builder
  AddDishDialog() {
    // åŠé€æ˜èƒŒæ™¯
    Column() {
      // ç©ºç™½åŒºåŸŸï¼Œç‚¹å‡»å…³é—­å¯¹è¯æ¡†
      Blank()
        .layoutWeight(1)
        .onClick(() => {
          this.showAddDishDialog = false;
          this.resetNewDishForm();
        })

      // å¯¹è¯æ¡†å†…å®¹
      Column() {
        // æ ‡é¢˜æ 
        Row() {
          Text('æ·»åŠ èœå“')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1A1A1A')
            .layoutWeight(1)
            .textAlign(TextAlign.Center)

          Image($r('app.media.back_icon'))
            .width(24)
            .height(24)
            .onClick(() => {
              this.showAddDishDialog = false;
              this.resetNewDishForm();
            })
        }
        .width('100%')
        .padding({ left: 20, right: 20, top: 16, bottom: 16 })

        // è¡¨å•å†…å®¹
        Scroll() {
          Column() {
            // èœå“ç…§ç‰‡
            Column() {
              Text('èœå“ç…§ç‰‡')
                .fontSize(14)
                .fontColor('#333333')
                .margin({ bottom: 8 })

              Stack({ alignContent: Alignment.Center }) {
                if (this.newDish.imageUrl) {
                  if (this.newDish.imageUrl.startsWith('app.media.')) {
                    Image($r(this.newDish.imageUrl))
                      .width(120)
                      .height(120)
                      .borderRadius(12)
                      .objectFit(ImageFit.Cover)
                      .backgroundColor('#F5F5F5')
                  } else {
                    Image(this.getPreviewImageSource())
                      .width(120)
                      .height(120)
                      .borderRadius(12)
                      .objectFit(ImageFit.Cover)
                      .backgroundColor('#F5F5F5')
                  }

                  Button({ type: ButtonType.Normal }) {
                    Image($r('app.media.delete'))
                      .width(20)
                      .height(20)
                      .fillColor('#FFFFFF')
                  }
                  .width(32)
                  .height(32)
                  .backgroundColor('#CC000000')
                  .borderRadius(16)
                  .position({ x: 100, y: 4 })
                  .onClick(() => {
                    this.newDish.imageUrl = '';
                  })
                } else {
                  Column() {
                    if (this.imageProcessing) {
                      LoadingProgress()
                        .width(32)
                        .height(32)
                        .color('#007DFF')
                    } else {
                      Image($r('app.media.camera'))
                        .width(32)
                        .height(32)
                        .fillColor('#999999')
                        .margin({ bottom: 8 })
                    }
                    Text(this.imageProcessing ? 'å¤„ç†ä¸­...' : 'ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡')
                      .fontSize(12)
                      .fontColor('#999999')
                  }
                  .position({ x: 0, y: 0 })
                }
              }
              .width(120)
              .height(120)
              .onClick(() => {
                if (!this.imageProcessing) {
                  this.showImagePicker = true;
                }
              })
            }
            .width('100%')
            .alignItems(HorizontalAlign.Center)
            .margin({ top: 16 })

            // èœå“åç§°
            Column() {
              Text('èœå“åç§° *')
                .fontSize(14)
                .fontColor('#333333')
                .margin({ bottom: 8 })

              TextInput({ placeholder: 'è¯·è¾“å…¥èœå“åç§°', text: this.newDish.name })
                .width('100%')
                .height(44)
                .backgroundColor('#F5F5F5')
                .borderRadius(8)
                .padding(12)
                .onChange((value: string) => {
                  this.newDish.name = value;
                })
            }
            .margin({ top: 16 })

            // ä»·æ ¼
            Column() {
              Text('ä»·æ ¼ *')
                .fontSize(14)
                .fontColor('#333333')
                .margin({ bottom: 8 })

              TextInput({ placeholder: '0.00', text: this.newDish.price })
                .width('100%')
                .height(44)
                .backgroundColor('#F5F5F5')
                .borderRadius(8)
                .padding(12)
                .type(InputType.Number)
                .onChange((value: string) => {
                  this.newDish.price = value;
                })
            }
            .margin({ top: 16 })

            // åˆ†ç±»
            Column() {
              Text('åˆ†ç±» *')
                .fontSize(14)
                .fontColor('#333333')
                .margin({ bottom: 8 })

              Scroll() {
                Row() {
                  ForEach(this.categories.filter(c => c !== 'å…¨éƒ¨'), (category: string) => {
                    Text(category)
                      .fontSize(14)
                      .fontColor(this.newDish.category === category ? '#FFFFFF' : '#666666')
                      .backgroundColor(this.newDish.category === category ? '#007DFF' : '#F0F0F0')
                      .padding({
                        left: 16,
                        right: 16,
                        top: 10,
                        bottom: 10
                      })
                      .borderRadius(16)
                      .margin({ right: 8 })
                      .onClick(() => {
                        this.newDish.category = category;
                      })
                  })
                }
                .padding(12)
              }
              .scrollBar(BarState.Off)
              .scrollable(ScrollDirection.Horizontal)
              .backgroundColor('#F5F5F5')
              .borderRadius(8)
            }
            .margin({ top: 16 })

            // æè¿°
            Column() {
              Text('æè¿°')
                .fontSize(14)
                .fontColor('#333333')
                .margin({ bottom: 8 })

              TextInput({ placeholder: 'è¯·è¾“å…¥èœå“æè¿°', text: this.newDish.description })
                .width('100%')
                .height(80)
                .backgroundColor('#F5F5F5')
                .borderRadius(8)
                .padding(12)
                .onChange((value: string) => {
                  this.newDish.description = value;
                })
            }
            .margin({ top: 16 })

            // åšæ³•
            Column() {
              Text('åšæ³• *')
                .fontSize(14)
                .fontColor('#333333')
                .margin({ bottom: 8 })

              TextInput({ placeholder: 'è¯·è¾“å…¥è¯¦ç»†åšæ³•æ­¥éª¤ï¼Œæ–¹ä¾¿å¨æˆ¿æ“ä½œ', text: this.newDish.cookingMethod })
                .width('100%')
                .height(100)
                .backgroundColor('#F5F5F5')
                .borderRadius(8)
                .padding(12)
                .maxLines(4)
                .onChange((value: string) => {
                  this.newDish.cookingMethod = value;
                })
            }
            .margin({ top: 16 })

            // æ¨èå¼€å…³
            Row() {
              Text('è®¾ä¸ºæ¨èèœå“')
                .fontSize(14)
                .fontColor('#333333')
                .layoutWeight(1)

              Toggle({
                type: ToggleType.Switch,
                isOn: this.newDish.isRecommended
              })
                .onChange((value: boolean) => {
                  this.newDish.isRecommended = value;
                })
            }
            .width('100%')
            .padding(16)
            .backgroundColor('#F5F5F5')
            .borderRadius(8)
            .margin({ top: 16 })

            // å¿«é€Ÿæ·»åŠ ç¤ºä¾‹èœå“æŒ‰é’®
            Button('å¿«é€Ÿæ·»åŠ ç¤ºä¾‹èœå“', { type: ButtonType.Normal, stateEffect: true })
              .width('100%')
              .height(44)
              .backgroundColor('#34C759')
              .fontColor('#FFFFFF')
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .borderRadius(22)
              .margin({ top: 16 })
              .onClick(() => {
                this.addSampleDishes();
                this.showAddDishDialog = false;
              })

            // ä¿å­˜æŒ‰é’®
            Button('ä¿å­˜èœå“', { type: ButtonType.Normal, stateEffect: true })
              .width('100%')
              .height(50)
              .backgroundColor('#007DFF')
              .fontColor('#FFFFFF')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .borderRadius(25)
              .margin({ top: 16, bottom: 24 })
              .onClick(() => {
                this.saveDish();
              })
          }
          .width('100%')
          .padding({ left: 20, right: 20 })
        }
        .layoutWeight(1)
      }
      .width('100%')
      .height('80%')
      .backgroundColor('#FFFFFF')
      .borderRadius({ topLeft: 20, topRight: 20 })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#80000000')
    .onClick(() => {
      this.showAddDishDialog = false;
      this.resetNewDishForm();
    })
  }

  // è·å–ç­›é€‰åçš„èœå“
  getFilteredDishes(): Dish[] {
    if (this.selectedCategory === 'å…¨éƒ¨') {
      return this.dishes;
    }
    return this.dishes.filter(dish => dish.category === this.selectedCategory);
  }

  // è·å–æ¨èèœå“
  private buildDefaultFeaturedDishes(): Dish[] {
    const dishes: Dish[] = [];

    const dish1 = new Dish();
    dish1.id = -101;
    dish1.name = 'å®«ä¿é¸¡ä¸';
    dish1.description = 'é¸¡ä¸é…¥å«©ï¼ŒèŠ±ç”Ÿè„†é¦™ï¼Œé…¸ç”œå¾®è¾£çš„ç»å…¸å·å‘³';
    dish1.cookingMethod = 'é¸¡è‚‰åˆ‡ä¸è…Œåˆ¶ï¼Œè¾…ä»¥èŠ±ç”Ÿã€è¾£æ¤’çˆ†ç‚’ï¼ŒåŠ å…¥é…±æ±æ”¶æ±å³å¯ã€‚';
    dish1.price = 38;
    dish1.imageUrl = 'app.media.dish1';
    dish1.category = 'æ‹›ç‰Œèœ';
    dish1.isRecommended = true;
    dish1.status = 'available';
    dishes.push(dish1);

    const dish2 = new Dish();
    dish2.id = -102;
    dish2.name = 'éº»å©†è±†è…';
    dish2.description = 'è±†è…å«©æ»‘ï¼Œéº»è¾£é²œé¦™ï¼Œåœ°é“å·èœé£å‘³';
    dish2.cookingMethod = 'è±†è…ç„¯æ°´åä¸ç‰›è‚‰æœ«ã€è±†ç“£é…±åŒç‚’ï¼ŒåŠ å…¥èŠ±æ¤’ç²‰ä¿æŒéº»è¾£å£æ„Ÿã€‚';
    dish2.price = 28;
    dish2.imageUrl = 'app.media.dish2';
    dish2.category = 'æ‹›ç‰Œèœ';
    dish2.isRecommended = true;
    dish2.status = 'available';
    dishes.push(dish2);

    const dish3 = new Dish();
    dish3.id = -103;
    dish3.name = 'ç³–é†‹é‡Œè„Š';
    dish3.description = 'å¤–é…¥é‡Œå«©ï¼Œé…¸ç”œçˆ½å£ï¼Œè€å°‘çš†å®œ';
    dish3.cookingMethod = 'é‡Œè„Šè…Œåˆ¶åè£¹æµ†ç‚¸è‡³é‡‘é»„ï¼Œç³–é†‹æ±å‹¾èŠ¡ç¿»ç‚’åŒ…è£¹å³å¯ã€‚';
    dish3.price = 42;
    dish3.imageUrl = 'app.media.dish3';
    dish3.category = 'æ‹›ç‰Œèœ';
    dish3.isRecommended = true;
    dish3.status = 'available';
    dishes.push(dish3);

    const dish4 = new Dish();
    dish4.id = -104;
    dish4.name = 'çº¢çƒ§è‚‰';
    dish4.description = 'è‚¥è€Œä¸è…»ï¼Œå…¥å£å³åŒ–çš„å®¶å¸¸ç»å…¸';
    dish4.cookingMethod = 'äº”èŠ±è‚‰ç„¯æ°´ååŠ å†°ç³–å°ç«æ…¢ç‚–ï¼ŒåŠ å…¥é…±æ²¹è°ƒè‰²ï¼Œæ”¶æ±å³æˆã€‚';
    dish4.price = 48;
    dish4.imageUrl = 'app.media.dish4';
    dish4.category = 'æ‹›ç‰Œèœ';
    dish4.isRecommended = true;
    dish4.status = 'available';
    dishes.push(dish4);

    const dish5 = new Dish();
    dish5.id = -105;
    dish5.name = 'æ¸…è’¸é²ˆé±¼';
    dish5.description = 'é²œå«©æ¸…é¦™ï¼ŒåŸæ±åŸå‘³çš„è¥å…»å¥½å‘³é“';
    dish5.cookingMethod = 'é²ˆé±¼å¤„ç†å¹²å‡€ï¼Œé“ºå§œè‘±è’¸ç†Ÿï¼Œæ·‹çƒ­æ²¹ä¸è’¸é±¼è±‰æ²¹å³å¯ã€‚';
    dish5.price = 68;
    dish5.imageUrl = 'app.media.dish5';
    dish5.category = 'æ‹›ç‰Œèœ';
    dish5.isRecommended = true;
    dish5.status = 'available';
    dishes.push(dish5);

    return dishes;
  }

  private getDefaultFeaturedDishes(): Dish[] {
    if (!this.defaultFeaturedDishes || this.defaultFeaturedDishes.length === 0) {
      this.defaultFeaturedDishes = this.buildDefaultFeaturedDishes();
    }
    return this.defaultFeaturedDishes;
  }

  private getCarouselSlides(): Dish[] {
    if (!this.featuredSlides || this.featuredSlides.length === 0) {
      this.featuredSlides = this.buildCarouselSlidesFromAssets();
    }
    return this.featuredSlides;
  }

  private buildCarouselSlidesFromAssets(): Dish[] {
    const source: Dish[] = this.createLocalSampleDishes();
    if (!source || source.length === 0) {
      return [];
    }
    const fallbackImages: string[] = ['app.media.dish1', 'app.media.dish2', 'app.media.dish3', 'app.media.dish4', 'app.media.dish5'];
    const slides: Dish[] = [];
    for (let index = 0; index < Math.min(5, source.length); index++) {
      const original = source[index];
      const cloned = this.cloneDish(original);
      cloned.imageUrl = fallbackImages[index] || fallbackImages[fallbackImages.length - 1];
      cloned.isRecommended = true;
      slides.push(cloned);
    }
    return slides;
  }

  private async navigateToAddDishPage(): Promise<void> {
    if (this.isCustomerMode) {
      ToastUtils.showToast('é¡¾å®¢ç«¯ä¸æ”¯æŒæ·»åŠ èœå“');
      return;
    }
    try {
      await router.pushUrl({
        url: 'pages/AddDishPage',
        params: {}
      });
    } catch (error) {
      console.error('è·³è½¬æ·»åŠ èœå“å¤±è´¥:' + JSON.stringify(error));
      // å¦‚æœè·³è½¬å¤±è´¥ï¼Œæ‰“å¼€å†…ç½®å¯¹è¯æ¡†
      this.resetNewDishForm();
      if (!this.isCustomerMode) {
        this.showAddDishDialog = true;
      }
    }
  }

  private normalizeDishImagePath(path: string): string {
    if (!path) {
      return '';
    }
    const lower = path.toLowerCase();
    // èµ„æºå¼•ç”¨(app.media.xxx)
    if (path.startsWith('app.media.')) {
      return path;
    }
    // HTTP/HTTPS URL
    if (lower.startsWith('http://') || lower.startsWith('https://')) {
      return path;
    }
    // file://åè®®
    if (lower.startsWith('file://')) {
      return path.replace('file://', '');
    }
    // ç»å¯¹è·¯å¾„
    if (path.startsWith('/')) {
      return path;
    }
    // ç›¸å¯¹è·¯å¾„(dishes/xxx),éœ€è¦è½¬æ¢ä¸ºç»å¯¹è·¯å¾„
    if (!this.context) {
      try {
        this.context = getContext(this) as common.UIAbilityContext;
      } catch (error) {
        console.error('è·å–ä¸Šä¸‹æ–‡å¤±è´¥:' + JSON.stringify(error));
        return path;
      }
    }
    if (!this.context) {
      return path;
    }
    // å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„(å¦‚dishes/xxx),æ‹¼æ¥filesDir
    return `${this.context.filesDir}/${path}`;
  }

  private async refreshHomeData(): Promise<void> {
    if (this.isRefreshing) {
      return;
    }
    this.isRefreshing = true;
    try {
      await this.loadShopData();
      await this.loadDishes();
      await this.loadCartData();
      this.featuredSlides = this.buildCarouselSlidesFromAssets();
    } catch (error) {
      console.error('åˆ·æ–°é¦–é¡µå¤±è´¥:' + JSON.stringify(error));
    } finally {
      this.isRefreshing = false;
    }
  }

  // åŠ è½½åº—é“ºæ•°æ®
  async loadShopData() {
    try {
      const response: ApiResponse = await ApiUtils.get('/shops/info');
      if (response.statusCode === 200 && response.data) {
        const shopData = response.data as ShopInfoResponse;
        this.shopInfo.id = shopData.id || 0;
        this.shopInfo.shop_name = shopData.shop_name || '';
        this.shopInfo.name = shopData.shop_name || shopData.name || 'é£Ÿå…‰è®°';
        this.shopInfo.description = shopData.description || '';
        this.shopInfo.business_hours = shopData.business_hours || '';
        this.shopInfo.businessHours = shopData.business_hours || '09:00-22:00';
        this.shopInfo.address = shopData.address || 'å®å¤å¤§å­¦ä¸­å«æ ¡åŒº';
        this.shopInfo.phone = shopData.phone || '13800138000';
        this.shopInfo.score = shopData.score || 4.8;
        this.shopInfo.todayOrders = shopData.todayOrders || 45;
        this.shopInfo.todayRevenue = shopData.todayRevenue || 2860.50;
        if (typeof shopData.latitude === 'number' && typeof shopData.longitude === 'number') {
          this.shopInfo.latitude = shopData.latitude;
          this.shopInfo.longitude = shopData.longitude;
        } else {
          this.shopInfo.latitude = this.shopInfo.latitude ?? DEFAULT_LATITUDE;
          this.shopInfo.longitude = this.shopInfo.longitude ?? DEFAULT_LONGITUDE;
        }
      }
    } catch (error) {
      console.error('åŠ è½½åº—é“ºä¿¡æ¯å¤±è´¥:' + error);
      // ä½¿ç”¨é»˜è®¤æ•°æ®
      this.shopInfo = new ShopInfo();
    }
  }

  // åŠ è½½èœå“æ•°æ®
  async loadDishes() {
    try {
      this.isLoading = true;
      const response: ApiResponse = await ApiUtils.get('/dishes/list');

      if (response.statusCode === 200 && response.data) {
        const dishesData = response.data as DishListResponse[];
        if (Array.isArray(dishesData)) {
          this.dishes = dishesData.map((item: DishListResponse) => {
            const dish = new Dish();
            dish.id = item.id || 0;
            dish.name = item.name || '';
            dish.description = item.description || '';
            dish.cookingMethod = item.cooking_method || '';
            const priceValue = typeof item.price === 'string' ? parseFloat(item.price) : (item.price || 0);
            dish.price = priceValue;
            const rawImage = item.image_url || '';
            dish.imageUrl = this.normalizeDishImagePath(rawImage);
            dish.category = item.category || '';
            dish.isRecommended = item.is_recommended || false;
            dish.sales = item.sales || 0;
            dish.status = item.status || 'available';
            dish.quantity = 0;
            dish.rating = item.rating || this.generateFallbackRating(dish.category);
            dish.reviewCount = item.review_count || this.generateFallbackReviewCount();
            dish.ingredients = item.ingredients || this.getDefaultIngredients(dish.category);
            dish.cookTime = item.cook_time || this.getDefaultCookTime(dish.category);
            dish.flavorTags = (item.flavor_tags && item.flavor_tags.length > 0) ? item.flavor_tags : this.getDefaultFlavorTags(dish.category);
            return dish;
          });

          // å¦‚æœåç«¯æš‚æ— èœå“ï¼Œä½¿ç”¨æœ¬åœ°ç¤ºä¾‹èœå“ä½œä¸ºå ä½
          if (!this.dishes || this.dishes.length === 0) {
            const localDishes = this.createLocalSampleDishes();
            this.dishes = localDishes;
            // åŒæ—¶å°†ç¤ºä¾‹èœå“æ·»åŠ åˆ°é»˜è®¤æ¨èèœå“åˆ—è¡¨
            if (!this.defaultFeaturedDishes || this.defaultFeaturedDishes.length === 0) {
              this.defaultFeaturedDishes = localDishes.filter(d => d.isRecommended).slice(0, 5);
            }
          } else {
            // å¦‚æœåç«¯æœ‰èœå“ï¼Œä¹Ÿç¡®ä¿æœ‰æ¨èèœå“ç”¨äºè½®æ’­
            const recommended = this.dishes.filter(d => d.isRecommended);
            if (recommended.length === 0) {
              // å¦‚æœæ²¡æœ‰æ¨èèœå“ï¼Œä½¿ç”¨å‰5ä¸ªä½œä¸ºæ¨è
              this.defaultFeaturedDishes = this.dishes.slice(0, 5).map(d => {
                const featured = new Dish();
                featured.id = d.id;
                featured.name = d.name;
                featured.description = d.description;
                featured.cookingMethod = d.cookingMethod;
                featured.price = d.price;
                featured.imageUrl = d.imageUrl;
                featured.category = d.category;
                featured.isRecommended = d.isRecommended;
                featured.sales = d.sales;
                featured.status = d.status;
                featured.quantity = d.quantity;
                return featured;
              });
            } else {
              this.defaultFeaturedDishes = recommended.slice(0, 5).map(d => {
                const featured = new Dish();
                featured.id = d.id;
                featured.name = d.name;
                featured.description = d.description;
                featured.cookingMethod = d.cookingMethod;
                featured.price = d.price;
                featured.imageUrl = d.imageUrl;
                featured.category = d.category;
                featured.isRecommended = d.isRecommended;
                featured.sales = d.sales;
                featured.status = d.status;
                featured.quantity = d.quantity;
                return featured;
              });
            }
          }
        }
      }
    } catch (error) {
      console.error('åŠ è½½èœå“å¤±è´¥:' + error);
      // åŠ è½½å¤±è´¥æ—¶å›é€€åˆ°æœ¬åœ°ç¤ºä¾‹èœå“ï¼Œä¾¿äºæ¼”ç¤º
      const localDishes = this.createLocalSampleDishes();
      this.dishes = localDishes;
      // è®¾ç½®é»˜è®¤æ¨èèœå“
      if (!this.defaultFeaturedDishes || this.defaultFeaturedDishes.length === 0) {
        this.defaultFeaturedDishes = localDishes.filter(d => d.isRecommended).slice(0, 5);
      }
    } finally {
      this.isLoading = false;
      if (!this.featuredSlides || this.featuredSlides.length === 0) {
        this.featuredSlides = this.buildCarouselSlidesFromAssets();
      }
    }
  }

  // åŠ è½½è´­ç‰©è½¦æ•°æ®
  async loadCartData() {
    try {
      const response: ApiResponse = await ApiUtils.get('/cart/items');
      if (response.statusCode === 200 && response.data) {
        const cartData: CartResponse = response.data as CartResponse;
        const localSummary = LocalCartManager.getSummary();
        const remoteQuantity = cartData.total_quantity || 0;
        const remoteAmount = cartData.total_amount || 0;
        this.cartItemCount = remoteQuantity + localSummary.quantity;
        this.cartTotalAmount = remoteAmount + localSummary.amount;
        CartSyncManager.updateCartQuantity(this.cartItemCount);
        CartSyncManager.updateCartTotalAmount(this.cartTotalAmount);
      }
    } catch (error) {
      console.error('åŠ è½½è´­ç‰©è½¦å¤±è´¥:' + error);
      const localSummary = LocalCartManager.getSummary();
      this.cartItemCount = localSummary.quantity;
      this.cartTotalAmount = localSummary.amount;
      CartSyncManager.updateCartQuantity(this.cartItemCount);
      CartSyncManager.updateCartTotalAmount(this.cartTotalAmount);
    }
  }

  // æ·»åŠ åˆ°è´­ç‰©è½¦
  async addToCart(dish: Dish) {
    if (!dish) {
      ToastUtils.showToast('èœå“ä¿¡æ¯é”™è¯¯');
      return;
    }

    console.info(`æ·»åŠ èœå“åˆ°è´­ç‰©è½¦: ${dish.name}, ID: ${dish.id}, ä»·æ ¼: ${dish.price}`);

    // ç¤ºä¾‹èœå“(id < 0 æˆ– id ä¸º undefined/null/0)ç›´æ¥åŠ å…¥æœ¬åœ°è´­ç‰©è½¦
    if (dish.id === undefined || dish.id === null || dish.id <= 0) {
      console.info('ç¤ºä¾‹èœå“ï¼Œä½¿ç”¨æœ¬åœ°è´­ç‰©è½¦');
      this.handleAddToLocalCart(dish);
      ToastUtils.showToast(`${dish.name} å·²åŠ å…¥è´­ç‰©è½¦`);
      return;
    }

    try {
      const requestData: AddToCartRequest = {
        dish_id: dish.id,
        quantity: 1
      };

      const response: ApiResponse = await ApiUtils.post('/cart/add', requestData);

      if (response.statusCode === 200) {
        ToastUtils.showToast(`${dish.name} å·²åŠ å…¥è´­ç‰©è½¦`);
        await this.loadCartData();
      } else {
        // å¦‚æœåç«¯æ·»åŠ å¤±è´¥ï¼Œä¹ŸåŠ å…¥æœ¬åœ°è´­ç‰©è½¦
        console.info('åç«¯æ·»åŠ å¤±è´¥ï¼Œå›é€€åˆ°æœ¬åœ°è´­ç‰©è½¦');
        this.handleAddToLocalCart(dish);
        ToastUtils.showToast(`${dish.name} å·²åŠ å…¥è´­ç‰©è½¦`);
      }
    } catch (error) {
      console.error('æ·»åŠ åˆ°è´­ç‰©è½¦å¤±è´¥:' + JSON.stringify(error));
      // ç½‘ç»œé”™è¯¯æ—¶åŠ å…¥æœ¬åœ°è´­ç‰©è½¦
      this.handleAddToLocalCart(dish);
      ToastUtils.showToast(`${dish.name} å·²åŠ å…¥è´­ç‰©è½¦`);
    }
  }

  private handleAddToLocalCart(dish: Dish) {
    const cartDish: Dish = this.prepareDishForLocalCart(dish);
    LocalCartManager.addDish(cartDish, 1);
    const summary = LocalCartManager.getSummary();
    this.cartItemCount = summary.quantity;
    this.cartTotalAmount = summary.amount;
    CartSyncManager.updateCartQuantity(this.cartItemCount);
    CartSyncManager.updateCartTotalAmount(this.cartTotalAmount);
  }

  private prepareDishForLocalCart(dish: Dish): Dish {
    if (dish.id && dish.id !== 0) {
      return dish;
    }
    const clonedDish = new Dish();
    clonedDish.id = this.generateLocalDishId(dish);
    clonedDish.name = dish.name;
    clonedDish.description = dish.description;
    clonedDish.cookingMethod = dish.cookingMethod;
    clonedDish.price = dish.price;
    clonedDish.imageUrl = dish.imageUrl;
    clonedDish.category = dish.category;
    clonedDish.isRecommended = dish.isRecommended;
    clonedDish.sales = dish.sales;
    clonedDish.status = dish.status;
    clonedDish.quantity = dish.quantity;
    clonedDish.rating = dish.rating;
    clonedDish.reviewCount = dish.reviewCount;
    clonedDish.ingredients = dish.ingredients;
    clonedDish.cookTime = dish.cookTime;
    clonedDish.flavorTags = dish.flavorTags;
    return clonedDish;
  }

  private generateLocalDishId(dish: Dish): number {
    const base: string = `${dish.name}-${dish.price}-${dish.category}`.trim();
    if (!base) {
      return -Date.now();
    }
    let hash: number = 0;
    for (let index = 0; index < base.length; index++) {
      hash = ((hash << 5) - hash) + base.charCodeAt(index);
      hash |= 0;
    }
    if (hash === 0) {
      hash = -Date.now();
    }
    return hash > 0 ? -hash : hash;
  }

  private async handleImageSelection(imageUri: string) {
    if (!imageUri || imageUri.length === 0) {
      return;
    }
    this.imageProcessing = true;
    try {
      const storedPath = await this.persistDishImage(imageUri);
      this.newDish.imageUrl = storedPath;
      ToastUtils.showToast('å›¾ç‰‡é€‰æ‹©æˆåŠŸ');
    } catch (error) {
      console.error('å¤„ç†å›¾ç‰‡å¤±è´¥:' + JSON.stringify(error));
      ToastUtils.showToast('å›¾ç‰‡å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•');
    } finally {
      this.imageProcessing = false;
    }
  }

  // ä¿å­˜èœå“
  async saveDish() {
    // éªŒè¯å¿…å¡«å­—æ®µ
    if (!this.newDish.name || !this.newDish.price || !this.newDish.category || !this.newDish.cookingMethod) {
      ToastUtils.showToast('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼ˆåç§°ã€ä»·æ ¼ã€åˆ†ç±»ã€åšæ³•å¿…å¡«ï¼‰');
      return;
    }

    // éªŒè¯ä»·æ ¼æ ¼å¼
    const price = parseFloat(this.newDish.price);
    if (isNaN(price) || price <= 0) {
      ToastUtils.showToast('ä»·æ ¼æ ¼å¼ä¸æ­£ç¡®');
      return;
    }

    try {
      const imagePayloadPath: string = this.normalizePayloadImagePath(this.newDish.imageUrl);
      const dishData: CreateDishRequest = {
        name: this.newDish.name,
        description: this.newDish.description || '',
        cooking_method: this.newDish.cookingMethod,
        price: price,
        category: this.newDish.category,
        is_recommended: this.newDish.isRecommended,
        image_url: imagePayloadPath,
        status: 'available'
      };

      const response: ApiResponse = await ApiUtils.post('/dishes/add', dishData);

      if (response.statusCode === 200) {
        ToastUtils.showToast('æ·»åŠ èœå“æˆåŠŸ');
        this.showAddDishDialog = false;
        this.resetNewDishForm();
        
        // é‡æ–°åŠ è½½èœå“åˆ—è¡¨
        await this.loadDishes();
      } else {
        ToastUtils.showToast(response.message || 'æ·»åŠ èœå“å¤±è´¥');
      }
    } catch (error) {
      console.error('æ·»åŠ èœå“å¤±è´¥:' + error);
      ToastUtils.showToast('æ·»åŠ èœå“å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }

  // é‡ç½®æ–°èœå“è¡¨å•
  resetNewDishForm() {
    this.newDish = new NewDishForm();
  }

  // å›¾ç‰‡é€‰æ‹©å™¨å¯¹è¯æ¡†
  @Builder
  ImagePickerDialog() {
    Column() {
      Blank()
        .layoutWeight(1)
        .onClick(() => {
          this.showImagePicker = false;
        })

      Column() {
        // æ ‡é¢˜æ 
        Row() {
          Text('é€‰æ‹©å›¾ç‰‡')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1A1A1A')
            .layoutWeight(1)
            .textAlign(TextAlign.Center)

          Image($r('app.media.close'))
            .width(24)
            .height(24)
            .onClick(() => {
              this.showImagePicker = false;
            })
        }
        .width('100%')
        .padding({ left: 20, right: 20, top: 16, bottom: 16 })

        // æœ¬åœ°å›¾ç‰‡èµ„æº
        Column() {
          Text('æœ¬åœ°å›¾ç‰‡')
            .fontSize(14)
            .fontColor('#666666')
            .margin({ bottom: 12, left: 20 })
            .alignSelf(ItemAlign.Start)

          Grid() {
            ForEach(this.localImages, (imagePath: string) => {
              GridItem() {
                Stack({ alignContent: Alignment.Center }) {
                  Image($r(imagePath))
                    .width('100%')
                    .height('100%')
                    .borderRadius(8)
                    .objectFit(ImageFit.Cover)

                  if (this.newDish.imageUrl === imagePath) {
                    Image($r('app.media.check_circle'))
                      .width(24)
                      .height(24)
                      .position({ x: 0, y: 0 })
                  }
                }
                .width('100%')
                .height('100%')
                .onClick(() => {
                  this.newDish.imageUrl = imagePath;
                  this.showImagePicker = false;
                  ToastUtils.showToast('å›¾ç‰‡é€‰æ‹©æˆåŠŸ');
                })
              }
            })
          }
          .columnsTemplate('1fr 1fr 1fr')
          .rowsGap(12)
          .columnsGap(12)
          .width('100%')
          .height(200)
          .padding({ left: 20, right: 20 })
        }
        .width('100%')
        .margin({ bottom: 20 })

        // ä»ç›¸å†Œé€‰æ‹©æŒ‰é’®
        Button({ type: ButtonType.Normal, stateEffect: true }) {
          Row() {
            Image($r('app.media.image_gallery'))
              .width(20)
              .height(20)
              .fillColor('#FFFFFF')
              .margin({ right: 8 })
            Text('ä»ç›¸å†Œé€‰æ‹©')
              .fontSize(16)
              .fontColor('#FFFFFF')
              .fontWeight(FontWeight.Medium)
          }
        }
        .width('90%')
        .height(50)
        .backgroundColor('#007DFF')
        .borderRadius(25)
        .margin({ bottom: 12 })
        .onClick(() => {
          this.pickImageFromGallery();
        })

        // æ‹ç…§æŒ‰é’®
        Button({ type: ButtonType.Normal, stateEffect: true }) {
          Row() {
            Image($r('app.media.camera'))
              .width(20)
              .height(20)
              .fillColor('#FFFFFF')
              .margin({ right: 8 })
            Text('æ‹ç…§')
              .fontSize(16)
              .fontColor('#FFFFFF')
              .fontWeight(FontWeight.Medium)
          }
        }
        .width('90%')
        .height(50)
        .backgroundColor('#34C759')
        .borderRadius(25)
        .margin({ bottom: 20 })
        .onClick(() => {
          this.takePhoto();
        })
      }
      .width('100%')
      .backgroundColor('#FFFFFF')
      .borderRadius({ topLeft: 20, topRight: 20 })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#80000000')
    .onClick(() => {
      this.showImagePicker = false;
    })
  }

  // ä»ç›¸å†Œé€‰æ‹©å›¾ç‰‡
  async pickImageFromGallery() {
    try {
      this.showImagePicker = false;
      const granted = await this.ensureMediaPermissions();
      if (!granted) {
        return;
      }
      const photoViewPicker = new picker.PhotoViewPicker();
      const photoSelectOptions = new picker.PhotoSelectOptions();
      photoSelectOptions.MIMEType = picker.PhotoViewMIMETypes.IMAGE_TYPE;
      photoSelectOptions.maxSelectNumber = 1;

      const photoSelectResult = await photoViewPicker.select(photoSelectOptions);
      if (photoSelectResult && photoSelectResult.photoUris && photoSelectResult.photoUris.length > 0) {
        const imageUri = photoSelectResult.photoUris[0];
        await this.handleImageSelection(imageUri);
      }
    } catch (error) {
      console.error('é€‰æ‹©å›¾ç‰‡å¤±è´¥:', JSON.stringify(error));
      ToastUtils.showToast('é€‰æ‹©å›¾ç‰‡å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }

  // æ‹ç…§
  async takePhoto() {
    try {
      this.showImagePicker = false;
      const granted = await this.ensureMediaPermissions();
      if (!granted) {
        return;
      }
      // ä½¿ç”¨PhotoViewPickerï¼Œå®ƒä¼šè‡ªåŠ¨æä¾›ç›¸å†Œå’Œç›¸æœºé€‰é¡¹
      const photoViewPicker = new picker.PhotoViewPicker();
      const photoSelectOptions = new picker.PhotoSelectOptions();
      photoSelectOptions.MIMEType = picker.PhotoViewMIMETypes.IMAGE_TYPE;
      photoSelectOptions.maxSelectNumber = 1;

      // PhotoViewPickerä¼šè‡ªåŠ¨æ˜¾ç¤ºç›¸å†Œå’Œç›¸æœºé€‰é¡¹
      const photoSelectResult = await photoViewPicker.select(photoSelectOptions);
      if (photoSelectResult && photoSelectResult.photoUris && photoSelectResult.photoUris.length > 0) {
        const imageUri = photoSelectResult.photoUris[0];
        await this.handleImageSelection(imageUri);
      }
    } catch (error) {
      console.error('æ‹ç…§å¤±è´¥:', JSON.stringify(error));
      ToastUtils.showToast('æ‹ç…§å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }

  // å¿«é€Ÿæ·»åŠ ç¤ºä¾‹èœå“
  async addSampleDishes() {
    const sampleDishes: CreateDishRequest[] = [
      {
        name: 'å®«ä¿é¸¡ä¸',
        description: 'ç»å…¸å·èœï¼Œé¸¡è‚‰é²œå«©ï¼ŒèŠ±ç”Ÿé¦™è„†ï¼Œå¾®è¾£å¾®ç”œ',
        cooking_method: 'é¸¡ä¸æ·€ç²‰æŠ“åŒ€è…Œåˆ¶ï¼ŒèŠ±ç”Ÿç‚¸é¦™åä¸è¾£æ¤’ã€èŠ±æ¤’ä¸€åŒå¤§ç«ç¿»ç‚’ï¼ŒåŠ å…¥ç³–é†‹é…±æ±æ”¶æ±ã€‚',
        price: 38.00,
        category: 'çƒ­èœ',
        is_recommended: true,
        image_url: 'app.media.dish1',
        status: 'available'
      },
      {
        name: 'éº»å©†è±†è…',
        description: 'å››å·ä¼ ç»Ÿåèœï¼Œè±†è…å«©æ»‘ï¼Œéº»è¾£é²œé¦™',
        cooking_method: 'è±†è…ç„¯æ°´å®šå‹ï¼Œé”…ä¸­ç‚’é¦™ç‰›è‚‰æœ«ä¸è±†ç“£é…±ï¼ŒåŠ å…¥è±†è…å°ç«ç…®ï¼Œæ’’èŠ±æ¤’ç²‰æéº»é¦™ã€‚',
        price: 28.00,
        category: 'çƒ­èœ',
        is_recommended: true,
        image_url: 'app.media.dish2',
        status: 'available'
      },
      {
        name: 'ç³–é†‹é‡Œè„Š',
        description: 'é…¸ç”œå¯å£ï¼Œå¤–é…¥é‡Œå«©ï¼Œè€å°‘çš†å®œ',
        cooking_method: 'é‡Œè„Šæ¡è£¹æµ†ç‚¸è‡³é‡‘é»„ï¼Œé”…ä¸­è°ƒç³–é†‹æ±ï¼Œå¿«é€Ÿç¿»ç‚’ä½¿é…±æ±åŒ…è£¹å‡åŒ€ã€‚',
        price: 42.00,
        category: 'çƒ­èœ',
        is_recommended: true,
        image_url: 'app.media.dish3',
        status: 'available'
      },
      {
        name: 'çº¢çƒ§è‚‰',
        description: 'è‚¥è€Œä¸è…»ï¼Œå…¥å£å³åŒ–ï¼Œç»å…¸å®¶å¸¸èœ',
        cooking_method: 'äº”èŠ±è‚‰ç„¯æ°´åä¸å†°ç³–ç¿»ç‚’ä¸Šè‰²ï¼ŒåŠ å…¥é…±æ²¹ä¸é¦™æ–™æ…¢ç‚–æ”¶æ±ã€‚',
        price: 48.00,
        category: 'çƒ­èœ',
        is_recommended: true,
        image_url: 'app.media.dish4',
        status: 'available'
      },
      {
        name: 'æ¸…è’¸é²ˆé±¼',
        description: 'é²œå«©æ¸…é¦™ï¼Œè¥å…»ä¸°å¯Œï¼Œå¥åº·ç¾å‘³',
        cooking_method: 'é²ˆé±¼å¤„ç†å¹²å‡€åé“ºå§œä¸è’¸ç†Ÿï¼Œæ·‹çƒ­æ²¹å’Œè’¸é±¼è±‰æ²¹æå‘³ã€‚',
        price: 68.00,
        category: 'çƒ­èœ',
        is_recommended: false,
        image_url: 'app.media.dish5',
        status: 'available'
      },
      {
        name: 'é…¸è¾£åœŸè±†ä¸',
        description: 'é…¸é¦™çˆ½è„†ï¼Œå°ç‚’å¿…å¤‡ï¼Œå®¶å¸¸ç»å…¸',
        cooking_method: 'åœŸè±†ä¸å†²æ·‹å»æ·€ç²‰ï¼Œé”…ä¸­çƒ­æ²¹æ”¾å¹²è¾£æ¤’ã€èŠ±æ¤’çˆ†é¦™ï¼ŒåŠ å…¥åœŸè±†ä¸ç¿»ç‚’ï¼Œè°ƒå…¥é†‹å’Œç›ã€‚',
        price: 18.00,
        category: 'å‡‰èœ',
        is_recommended: false,
        image_url: 'app.media.default_dish',
        status: 'available'
      },
      {
        name: 'ç‰›è‚‰æ‹‰é¢',
        description: 'æ±¤é²œå‘³æµ“ï¼Œé¢æ¡åŠ²é“ï¼Œæš–èƒƒä¸»é£Ÿ',
        cooking_method: 'ç‰›è‚‰ä¸é¦™æ–™ç‚–ç…®æˆæ±¤åº•ï¼Œæ‹‰åˆ¶é¢æ¡ç…®ç†Ÿåæµ‡ä¸Šç‰›è‚‰æ±¤å³å¯ã€‚',
        price: 32.00,
        category: 'ä¸»é£Ÿ',
        is_recommended: true,
        image_url: 'app.media.dish3',
        status: 'available'
      },
      {
        name: 'èŠ’æœå¸ƒä¸',
        description: 'é¦™ç”œä¸æ»‘ï¼Œæ¸…çˆ½è§£è…»ï¼Œåˆåç”œç‚¹',
        cooking_method: 'èŠ’æœæ³¥ä¸ç‰›å¥¶ã€å‰åˆ©ä¸æ··åˆï¼Œå€’å…¥æ¨¡å…·å†·è—å‡å›ºï¼Œé£Ÿç”¨å‰ç‚¹ç¼€èŠ’æœç²’ã€‚',
        price: 22.00,
        category: 'ç”œå“',
        is_recommended: true,
        image_url: 'app.media.default_dish',
        status: 'available'
      }
    ];

    let successCount = 0;
    for (const dishData of sampleDishes) {
      try {
        const response: ApiResponse = await ApiUtils.post('/dishes/add', dishData);
        if (response.statusCode === 200) {
          successCount++;
        }
      } catch (error) {
        console.error('æ·»åŠ ç¤ºä¾‹èœå“å¤±è´¥:', error);
      }
    }

    if (successCount > 0) {
      ToastUtils.showToast(`æˆåŠŸæ·»åŠ  ${successCount} ä¸ªç¤ºä¾‹èœå“`);
      await this.loadDishes();
    } else {
      ToastUtils.showToast('æ·»åŠ ç¤ºä¾‹èœå“å¤±è´¥');
    }
  }

  private generateFallbackRating(category: string): number {
    const baseMap: Record<string, number> = {
      'çƒ­èœ': 4.7,
      'å‡‰èœ': 4.6,
      'ä¸»é£Ÿ': 4.7,
      'æ±¤ç±»': 4.8,
      'é¥®æ–™': 4.8,
      'ç”œå“': 4.9
    };
    const base = baseMap[category] || 4.7;
    const rating = base + Math.random() * 0.2;
    return parseFloat(rating.toFixed(1));
  }

  private generateFallbackReviewCount(): number {
    return 120 + Math.floor(Math.random() * 160);
  }

  private getDefaultCookTime(category: string): string {
    const mapping: Record<string, string> = {
      'çƒ­èœ': 'çº¦15åˆ†é’Ÿ',
      'å‡‰èœ': 'çº¦8åˆ†é’Ÿ',
      'ä¸»é£Ÿ': 'çº¦20åˆ†é’Ÿ',
      'æ±¤ç±»': 'çº¦25åˆ†é’Ÿ',
      'é¥®æ–™': 'ç°åšç°è°ƒ',
      'ç”œå“': 'çº¦10åˆ†é’Ÿ'
    };
    return mapping[category] || 'çº¦15åˆ†é’Ÿ';
  }

  private getDefaultIngredients(category: string): string {
    const mapping: Record<string, string> = {
      'çƒ­èœ': 'ç”„é€‰è‚‰ç±» Â· æ—¶è”¬æ­é…',
      'å‡‰èœ': 'æ–°é²œè”¬æœ Â· æ¸…çˆ½ä½æ–™',
      'ä¸»é£Ÿ': 'ä¼˜é€‰é¢ç‚¹ Â· ç°ç‚¹ç°åš',
      'æ±¤ç±»': 'ç†¬ç…®é«˜æ±¤ Â· å¤šæ–™æ…¢ç‚–',
      'é¥®æ–™': 'é²œæœ Â· å†°é¥® Â· æ‰‹è°ƒ',
      'ç”œå“': 'ç‰›å¥¶ Â· é¸¡è›‹ Â· æ—¶ä»¤æ°´æœ'
    };
    return mapping[category] || 'å½“æ—¥é‡‡è´­ Â· æ–°é²œçƒ¹åˆ¶';
  }

  private getDefaultFlavorTags(category: string): string[] {
    const mapping: Record<string, string[]> = {
      'çƒ­èœ': ['çƒ­è¾£é²œé¦™', 'ç°ç‚’å‡ºé”…'],
      'å‡‰èœ': ['æ¸…çˆ½å¼€èƒƒ', 'ä½è„‚å¥åº·'],
      'ä¸»é£Ÿ': ['é¥±è…¹é¦–é€‰', 'èƒ½é‡å……æ²›'],
      'æ±¤ç±»': ['æš–èƒƒæ»‹è¡¥', 'è¥å…»åŠ å€'],
      'é¥®æ–™': ['å†°çˆ½è§£è…»', 'è½»è´Ÿæ‹…'],
      'ç”œå“': ['ä¸æ»‘é¦™ç”œ', 'ä¸‹åˆèŒ¶']
    };
    return mapping[category] ? mapping[category].slice() : ['äººæ°”å£ç¢‘', 'æ‹›ç‰Œæ¨è'];
  }

  // æœ¬åœ°ç¤ºä¾‹èœå“ï¼ˆåŸºäº dish1.png ~ dish5.pngï¼‰
  createLocalSampleDishes(): Dish[] {
    // ä½¿ç”¨interfaceæ›¿ä»£å¯¹è±¡å­—é¢é‡ç±»å‹å£°æ˜ï¼Œæ»¡è¶³ ArkTS çº¦æŸ
    interface LocalDishSample {
      id: number;
      name: string;
      description: string;
      cookingMethod: string;
      price: number;
      image: string;
      category: string;
      isRecommended: boolean;
      sales: number;
      rating: number;
      reviewCount: number;
      ingredients: string;
      cookTime: string;
      flavorTags: string[];
    }
    const samples: LocalDishSample[] = [
      { id: -1, name: 'å®«ä¿é¸¡ä¸', description: 'é¸¡ä¸é…¥å«© èŠ±ç”Ÿè„†é¦™ é…¸ç”œå¾®è¾£', cookingMethod: 'é¸¡ä¸æ·€ç²‰æŠ“åŒ€è…Œåˆ¶ï¼ŒèŠ±ç”Ÿç‚¸é¦™åä¸è¾£æ¤’ã€è‘±æ®µæ­é…çˆ†ç‚’ï¼Œæ·‹ç³–é†‹é…±æ”¶æ±ã€‚', price: 38, image: 'app.media.dish1', category: 'çƒ­èœ', isRecommended: true, sales: 328, rating: 4.9, reviewCount: 268, ingredients: 'é¸¡èƒ¸è‚‰Â·èŠ±ç”Ÿç±³Â·å¹²è¾£æ¤’Â·èŠ±æ¤’', cookTime: 'çº¦15åˆ†é’Ÿ', flavorTags: ['é…¸ç”œå¾®è¾£', 'ä¸‹é¥­å¿…ç‚¹'] },
      { id: -2, name: 'éº»å©†è±†è…', description: 'è±†è…å«©æ»‘ éº»è¾£é²œé¦™ ä¸‹é¥­é¦–é€‰', cookingMethod: 'è±†è…åˆ‡å—ç„¯æ°´ï¼Œé”…ä¸­ç‚’é¦™è±†ç“£é…±ä¸ç‰›è‚‰æœ«ï¼ŒåŠ å…¥è±†è…å°ç«ç…®ï¼Œæ’’èŠ±æ¤’ç²‰æå‘³ã€‚', price: 28, image: 'app.media.dish2', category: 'çƒ­èœ', isRecommended: true, sales: 412, rating: 4.8, reviewCount: 322, ingredients: 'åŒ—è±†è…Â·ç‰›è‚‰æœ«Â·éƒ«å¿è±†ç“£Â·èŠ±æ¤’ç²‰', cookTime: 'çº¦12åˆ†é’Ÿ', flavorTags: ['éº»è¾£é²œé¦™', 'ç±³é¥­æ­æ¡£'] },
      { id: -3, name: 'ç³–é†‹é‡Œè„Š', description: 'å¤–é…¥é‡Œå«© é…¸ç”œé€‚å£ è€å°‘çš†å®œ', cookingMethod: 'é‡Œè„Šæ¡è…Œåˆ¶åè£¹ç³Šç‚¸è‡³é‡‘é»„ï¼Œé”…ä¸­è°ƒç³–é†‹æ±å¿«é€Ÿç¿»ç‚’è£¹åŒ€ã€‚', price: 42, image: 'app.media.dish3', category: 'çƒ­èœ', isRecommended: true, sales: 295, rating: 4.9, reviewCount: 301, ingredients: 'é‡Œè„Šè‚‰Â·ç•ªèŒ„é…±Â·ç™½é†‹Â·ç™½èŠéº»', cookTime: 'çº¦18åˆ†é’Ÿ', flavorTags: ['é…¸ç”œå¼€èƒƒ', 'å„¿ç«¥å–œçˆ±'] },
      { id: -4, name: 'çº¢çƒ§è‚‰', description: 'è‚¥è€Œä¸è…» å…¥å£å³åŒ– ç»å…¸å®¶å¸¸', cookingMethod: 'äº”èŠ±è‚‰ç„¯æ°´ååŠ å†°ç³–æ…¢ç‚–ï¼ŒåŠ å…¥è€æŠ½ã€ç”ŸæŠ½å’Œé¦™æ–™å°ç«æ”¶æ±ã€‚', price: 48, image: 'app.media.dish4', category: 'çƒ­èœ', isRecommended: true, sales: 366, rating: 4.7, reviewCount: 210, ingredients: 'äº”èŠ±è‚‰Â·è€æŠ½Â·ç”ŸæŠ½Â·å†°ç³–', cookTime: 'çº¦40åˆ†é’Ÿ', flavorTags: ['é†‡åšæµ“é¦™', 'ç±³é¥­æ€æ‰‹'] },
      { id: -5, name: 'æ¸…è’¸é²ˆé±¼', description: 'æ¸…é²œä¸è…¥ åŸæ±åŸå‘³ å¥åº·ä½è„‚', cookingMethod: 'é²ˆé±¼å¤„ç†å¹²å‡€æŠ¹ç›ï¼Œé“ºå§œä¸è’¸ç†Ÿåæ·‹çƒ­æ²¹å’Œè’¸é±¼è±‰æ²¹ã€‚', price: 68, image: 'app.media.dish5', category: 'çƒ­èœ', isRecommended: false, sales: 156, rating: 4.8, reviewCount: 146, ingredients: 'é²œé²ˆé±¼Â·å§œä¸Â·è’¸é±¼è±‰æ²¹', cookTime: 'çº¦15åˆ†é’Ÿ', flavorTags: ['æ¸…æ·¡å°‘æ²¹', 'é«˜è›‹ç™½'] },
      { id: -6, name: 'é…¸è¾£åœŸè±†ä¸', description: 'é…¸é¦™çˆ½è„† å°ç‚’å¿…å¤‡ å®¶å¸¸ç»å…¸', cookingMethod: 'åœŸè±†ä¸å†²æ·‹å»æ·€ç²‰ï¼Œé”…ä¸­çƒ­æ²¹æ”¾å¹²è¾£æ¤’ã€èŠ±æ¤’çˆ†é¦™ï¼ŒåŠ å…¥åœŸè±†ä¸ç¿»ç‚’ï¼Œè°ƒå…¥é†‹å’Œç›ã€‚', price: 18, image: 'app.media.default_dish', category: 'å‡‰èœ', isRecommended: false, sales: 238, rating: 4.6, reviewCount: 188, ingredients: 'åœŸè±†ä¸Â·é’çº¢æ¤’Â·å¹²è¾£æ¤’Â·ç±³é†‹', cookTime: 'çº¦8åˆ†é’Ÿ', flavorTags: ['è„†çˆ½è§£è…»', 'é…¸è¾£å¼€èƒƒ'] },
      { id: -7, name: 'ç‰›è‚‰æ‹‰é¢', description: 'ç‰›è‚‰é²œé¦™ æ±¤æ±æµ“éƒ é¢æ¡åŠ²é“', cookingMethod: 'ç‰›è‚‰ä¸é¦™æ–™ç‚–ç…®æˆæ±¤åº•ï¼Œæ‹‰åˆ¶é¢æ¡å…¥é”…ç…®ç†Ÿï¼Œæµ‡ä¸Šç‰›è‚‰æ±¤å³å¯ã€‚', price: 32, image: 'app.media.dish3', category: 'ä¸»é£Ÿ', isRecommended: true, sales: 189, rating: 4.7, reviewCount: 233, ingredients: 'ç‰›è…±è‚‰Â·æ‰‹å·¥é¢Â·å…«è§’Â·é¦™èœ', cookTime: 'çº¦20åˆ†é’Ÿ', flavorTags: ['æ±¤æµ“å‘³åš', 'æš–èƒƒé¥±è…¹'] },
      { id: -8, name: 'èŠ’æœå¸ƒä¸', description: 'é¦™ç”œä¸æ»‘ æ¸…çˆ½è§£è…» åˆåç”œç‚¹', cookingMethod: 'èŠ’æœæ³¥ä¸ç‰›å¥¶ã€å‰åˆ©ä¸æ··åˆï¼Œå€’å…¥æ¨¡å…·å†·è—å‡å›ºï¼Œé£Ÿç”¨å‰ç‚¹ç¼€èŠ’æœç²’ã€‚', price: 22, image: 'app.media.default_dish', category: 'ç”œå“', isRecommended: true, sales: 142, rating: 4.8, reviewCount: 165, ingredients: 'èŠ’æœÂ·ç‰›å¥¶Â·æ·¡å¥¶æ²¹Â·å‰åˆ©ä¸', cookTime: 'çº¦10åˆ†é’Ÿ+å†·è—', flavorTags: ['æ¸…çˆ½é¡ºæ»‘', 'ä¸‹åˆèŒ¶'] }
    ];

    return samples.map(s => {
      const d = new Dish();
      d.id = s.id;
      d.name = s.name;
      d.description = s.description;
      d.cookingMethod = s.cookingMethod;
      d.price = s.price;
      d.imageUrl = s.image;
      d.category = s.category;
      d.isRecommended = s.isRecommended;
      d.sales = s.sales;
      d.status = 'available';
      d.quantity = 0;
      d.rating = s.rating;
      d.reviewCount = s.reviewCount;
      d.ingredients = s.ingredients;
      d.cookTime = s.cookTime;
      d.flavorTags = s.flavorTags;
      return d;
    });
  }

  // æƒé™ç®¡ç†
  private async ensureMediaPermissions(): Promise<boolean> {
    if (this.mediaPermissionsGranted) {
      return true;
    }
    if (!this.atManager || !this.context) {
      ToastUtils.showToast('æ— æ³•è·å–èƒ½åŠ›ä¸Šä¸‹æ–‡');
      return false;
    }
    try {
      const result = await this.atManager.requestPermissionsFromUser(
        this.context,
        this.mediaPermissions
      ) as PermissionRequestResult;
      const granted = result.authResults.every((status: number) => status === 0);
      this.mediaPermissionsGranted = granted;
      if (!granted) {
        ToastUtils.showToast('è¯·æˆäºˆç›¸å†Œä¸ç›¸æœºæƒé™åå†è¯•');
      }
      return granted;
    } catch (error) {
      console.error('ç”³è¯·åª’ä½“æƒé™å¤±è´¥:' + JSON.stringify(error));
      ToastUtils.showToast('æƒé™ç”³è¯·å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      return false;
    }
  }

  // ä¿å­˜èœå“å›¾ç‰‡åˆ°åº”ç”¨ç§æœ‰ç›®å½•
  private async persistDishImage(uri: string): Promise<string> {
    if (!this.context) {
      try {
        this.context = getContext(this) as common.UIAbilityContext;
      } catch (error) {
        console.error('è·å–ä¸Šä¸‹æ–‡å¤±è´¥:' + JSON.stringify(error));
        return uri;
      }
    }
    if (!this.context) {
      return uri;
    }
    try {
      const sourcePath: string = this.resolveFilePath(uri);
      if (!sourcePath) {
        console.error('æ— æ³•è§£æå›¾ç‰‡è·¯å¾„:' + uri);
        return uri;
      }
      
      // æ£€æŸ¥æºæ–‡ä»¶æ˜¯å¦å­˜åœ¨
      try {
        fs.accessSync(sourcePath);
      } catch (error) {
        console.error('æºå›¾ç‰‡æ–‡ä»¶ä¸å­˜åœ¨:' + sourcePath);
        return uri;
      }
      
      // ç¡®ä¿åº”ç”¨ç§æœ‰ç›®å½•å­˜åœ¨
      const filesDir: string = this.context.filesDir;
      try {
        fs.accessSync(filesDir);
      } catch (error) {
        try {
          fs.mkdirSync(filesDir, true);
        } catch (mkdirError) {
          console.error('åˆ›å»ºfilesDirå¤±è´¥:' + JSON.stringify(mkdirError));
        }
      }
      
      // åˆ›å»ºdisheså­ç›®å½•ç”¨äºå­˜å‚¨èœå“å›¾ç‰‡
      const dishesDir: string = `${filesDir}/dishes`;
      try {
        fs.accessSync(dishesDir);
      } catch (error) {
        try {
          fs.mkdirSync(dishesDir, true);
        } catch (mkdirError) {
          console.error('åˆ›å»ºdishesDirå¤±è´¥:' + JSON.stringify(mkdirError));
        }
      }
      
      // ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
      const extension: string = this.extractExtension(sourcePath, '.jpg');
      const fileName: string = `dish_${Date.now()}_${Math.floor(Math.random() * 10000)}${extension}`;
      const targetPath: string = `${dishesDir}/${fileName}`;
      
      // å¤åˆ¶æ–‡ä»¶åˆ°åº”ç”¨ç§æœ‰ç›®å½•
      fs.copyFileSync(sourcePath, targetPath);
      
      // è¿”å›ç›¸å¯¹è·¯å¾„(ç›¸å¯¹äºfilesDir),è¿™æ ·æ•°æ®åº“åªå­˜å‚¨ç›¸å¯¹è·¯å¾„
      const relativePath: string = `dishes/${fileName}`;
      console.log('å›¾ç‰‡å·²ä¿å­˜åˆ°:' + targetPath + ', ç›¸å¯¹è·¯å¾„:' + relativePath);
      return relativePath;
    } catch (error) {
      console.error('ä¿å­˜èœå“å›¾ç‰‡å¤±è´¥:' + JSON.stringify(error));
      ToastUtils.showToast('å›¾ç‰‡ä¿å­˜å¤±è´¥ï¼Œå°†ä½¿ç”¨åŸå§‹è·¯å¾„');
      return uri;
    }
  }

  private resolveFilePath(uri: string): string {
    if (!uri) {
      return '';
    }
    if (uri.startsWith('file://')) {
      return uri.replace('file://', '');
    }
    return uri;
  }

  private extractExtension(path: string, fallback: string = '.jpg'): string {
    if (!path) {
      return fallback;
    }
    const dotIndex: number = path.lastIndexOf('.');
    if (dotIndex === -1 || dotIndex === path.length - 1) {
      return fallback;
    }
    return path.substring(dotIndex);
  }

  private normalizePayloadImagePath(path: string): string {
    if (!path) {
      return '';
    }
    // å¦‚æœæ˜¯èµ„æºå¼•ç”¨(app.media.xxx),ç›´æ¥è¿”å›
    if (path.startsWith('app.media.')) {
      return path;
    }
    // å¦‚æœå·²ç»æ˜¯ç›¸å¯¹è·¯å¾„(dishes/xxx),ç›´æ¥è¿”å›
    if (path.startsWith('dishes/')) {
      return path;
    }
    // å¦‚æœæ˜¯ç»å¯¹è·¯å¾„,è½¬æ¢ä¸ºç›¸å¯¹è·¯å¾„
    return this.toRelativeDishPath(path);
  }

  private getPreviewImageSource(): string {
    if (!this.newDish.imageUrl) {
      return '';
    }
    if (this.newDish.imageUrl.startsWith('app.media.')) {
      return this.newDish.imageUrl;
    }
    return this.toAbsoluteDishPath(this.newDish.imageUrl);
  }

  private toRelativeDishPath(path: string): string {
    if (!path) {
      return '';
    }
    if (!this.context) {
      try {
        this.context = getContext(this) as common.UIAbilityContext;
      } catch (error) {
        console.error('è·å–ä¸Šä¸‹æ–‡å¤±è´¥:' + JSON.stringify(error));
        return path;
      }
    }
    if (!this.context) {
      return path;
    }
    const filesDir: string = this.context.filesDir;
    // å¦‚æœè·¯å¾„ä»¥filesDirå¼€å¤´,æå–ç›¸å¯¹è·¯å¾„
    if (path.startsWith(filesDir)) {
      const trimmed: string = path.substring(filesDir.length);
      return trimmed.startsWith('/') ? trimmed.substring(1) : trimmed;
    }
    // å¦‚æœè·¯å¾„å·²ç»æ˜¯ç›¸å¯¹è·¯å¾„æ ¼å¼,ç›´æ¥è¿”å›
    if (!path.startsWith('/') && !path.startsWith('file://')) {
      return path;
    }
    // å…¶ä»–æƒ…å†µè¿”å›åŸè·¯å¾„
    return path;
  }

  private toAbsoluteDishPath(path: string): string {
    if (!path) {
      return '';
    }
    const lower: string = path.toLowerCase();
    if (path.startsWith('app.media.')) {
      return path;
    }
    if (lower.startsWith('file://')) {
      return path.replace('file://', '');
    }
    if (path.startsWith('/')) {
      return path;
    }
    if (!this.context) {
      return path;
    }
    return `${this.context.filesDir}/${path}`;
  }
}


