// ProfilePage.ets
import { UserInfo, SalesStats, ApiResponse, TopDish, AppMode } from '../common/Types';
import { ApiUtils, ToastUtils, AppModeManager, RouterUtils } from '../common/Utils';
import router from '@ohos.router';
import picker from '@ohos.file.picker';
import abilityAccessCtrl from '@ohos.abilityAccessCtrl';
import common from '@ohos.app.ability.common';
import fs from '@ohos.file.fs';
import prompt from '@ohos.promptAction';

type MediaPermissionName =
  | 'ohos.permission.READ_MEDIA'
  | 'ohos.permission.WRITE_MEDIA'
  | 'ohos.permission.READ_IMAGEVIDEO'
  | 'ohos.permission.WRITE_IMAGEVIDEO'
  | 'ohos.permission.CAMERA';

interface PermissionRequestResult {
  permissions: MediaPermissionName[];
  authResults: number[];
}

interface UpdateProfileRequest {
  username?: string;
  address?: string;
  avatar?: string;
}

interface UpdatePasswordRequest {
  old_password: string;
  new_password: string;
}

interface UpdateEmailRequest {
  email: string;
}

interface SettingsItem {
  icon: string;
  title: string;
  value: string;
  showAvatar?: boolean;
  action: () => void;
}

// åˆ›å»ºè®¾ç½®é¡¹çš„è¾…åŠ©å‡½æ•°
function createSettingsItem(icon: string, title: string, value: string, action: () => void, showAvatar?: boolean): SettingsItem {
  const item: SettingsItem = {
    icon: icon,
    title: title,
    value: value,
    showAvatar: showAvatar || false,
    action: action
  };
  return item;
}

interface StoredUserInfo {
  id?: number;
  username?: string;
  name?: string;
  email?: string;
  avatar?: string;
  shopName?: string;
  type?: string;
  address?: string;
}

@Entry
@Component
export struct ProfilePage {
  @State isLoggedIn: boolean = false;
  @State userInfo: UserInfo = new UserInfo();
  @State salesStats: SalesStats = new SalesStats();
  @State isLoading: boolean = false;
  @State showAvatarPicker: boolean = false;
  @State showEditProfile: boolean = false;
  @State showEditPassword: boolean = false;
  @State showEditEmail: boolean = false;
  @StorageLink('appMode') appMode: AppMode = AppMode.MERCHANT;
  @StorageLink('currentTableId') currentTableId: string = '';
  
  // ç¼–è¾‘è¡¨å•çŠ¶æ€
  @State editUsername: string = '';
  @State editAddress: string = '';
  @State oldPassword: string = '';
  @State newPassword: string = '';
  @State confirmPassword: string = '';
  @State editEmail: string = '';

  private context?: common.UIAbilityContext;
  private atManager?: abilityAccessCtrl.AtManager;
  private mediaPermissionsGranted: boolean = false;
  private readonly mediaPermissions: MediaPermissionName[] = [
    'ohos.permission.READ_MEDIA',
    'ohos.permission.WRITE_MEDIA',
    'ohos.permission.READ_IMAGEVIDEO',
    'ohos.permission.WRITE_IMAGEVIDEO',
    'ohos.permission.CAMERA'
  ];

  aboutToAppear() {
    try {
      this.context = getContext(this) as common.UIAbilityContext;
      this.atManager = abilityAccessCtrl.createAtManager();
    } catch (error) {
      console.error('åˆå§‹åŒ–é¡µé¢ä¸Šä¸‹æ–‡å¤±è´¥:' + JSON.stringify(error));
    }
    this.checkLoginStatus();
    if (this.isLoggedIn) {
      this.loadUserProfile();
      this.loadSalesStats();
    }
  }

  private get isCustomerMode(): boolean {
    return this.appMode === AppMode.CUSTOMER;
  }

  build() {
    Stack() {
      Column() {
        if (this.isLoggedIn) {
          this.LoggedInView()
        } else {
          this.NotLoggedInView()
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F5F5F5')

      // ç¼–è¾‘ä¸ªäººèµ„æ–™å¯¹è¯æ¡†
      if (this.showEditProfile) {
        this.EditProfileDialog()
      }

      // ä¿®æ”¹å¯†ç å¯¹è¯æ¡†
      if (this.showEditPassword) {
        this.EditPasswordDialog()
      }

      // ä¿®æ”¹é‚®ç®±å¯¹è¯æ¡†
      if (this.showEditEmail) {
        this.EditEmailDialog()
      }
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  LoggedInView() {
    Scroll() {
      Column() {
        // é¡¶éƒ¨æ¸å˜èƒŒæ™¯å¤´éƒ¨
        this.ProfileHeader()

        if (this.isCustomerMode) {
          this.CustomerModeCard()
        }

        if (!this.isCustomerMode) {
          // é”€å”®ä¿¡æ¯å±•ç¤º
          this.SalesInfoCard()
          this.MerchantToolsCard()
        } else {
          this.CustomerTableCard()
        }

        // è®¾ç½®éƒ¨åˆ†
        this.SettingsSection()
      }
      .padding({ bottom: 20 })
    }
    .layoutWeight(1)
    .backgroundColor('#F5F7FA')
  }

  @Builder
  ProfileHeader() {
    Stack({ alignContent: Alignment.Bottom }) {
      // æ¸å˜èƒŒæ™¯
      Column()
        .width('100%')
        .height(200)
        .linearGradient({
          angle: 135,
          colors: [
            ['#667eea', 0],
            ['#764ba2', 1]
          ]
        })

      // ç”¨æˆ·ä¿¡æ¯å¡ç‰‡
      Column() {
        // å¤´åƒå’ŒåŸºæœ¬ä¿¡æ¯
        Row({ space: 16 }) {
          Stack() {
            Image(this.getImagePath(this.userInfo.avatar) || $r('app.media.ic_user_avatar'))
              .width(80)
              .height(80)
              .borderRadius(40)
              .objectFit(ImageFit.Cover)
              .border({ width: 3, color: '#FFFFFF' })
              .shadow({
                radius: 12,
                color: 'rgba(0,0,0,0.15)',
                offsetX: 0,
                offsetY: 4
              })

            // ç¼–è¾‘å¤´åƒå›¾æ ‡
            Column() {
              Text('ğŸ“·')
                .fontSize(14)
            }
            .width(28)
            .height(28)
            .borderRadius(14)
            .backgroundColor('#007DFF')
            .justifyContent(FlexAlign.Center)
            .position({ x: 56, y: 56 })
          }
          .onClick(() => {
            this.changeAvatar();
          })

          Column({ space: 6 }) {
            Text(this.userInfo.username || 'æœªè®¾ç½®æ˜µç§°')
              .fontSize(22)
              .fontWeight(FontWeight.Bold)
              .fontColor('#1A1A1A')

            Text(this.userInfo.email || 'æœªè®¾ç½®é‚®ç®±')
              .fontSize(14)
              .fontColor('#666666')

            if (this.userInfo.address) {
              Row({ space: 4 }) {
                Text('ğŸ“')
                  .fontSize(12)
                Text(this.userInfo.address)
                  .fontSize(12)
                  .fontColor('#999999')
                  .maxLines(1)
                  .textOverflow({ overflow: TextOverflow.Ellipsis })
              }
            }
          }
          .alignItems(HorizontalAlign.Start)
          .layoutWeight(1)
        }
        .width('100%')
        .padding({ left: 20, right: 20, top: 20, bottom: 16 })

        // é€€å‡ºç™»å½•æŒ‰é’®
        Button('é€€å‡ºç™»å½•', { type: ButtonType.Normal, stateEffect: true })
          .width('90%')
          .height(44)
          .fontSize(15)
          .fontWeight(FontWeight.Medium)
          .backgroundColor('rgba(255,59,48,0.1)')
          .fontColor('#FF3B30')
          .borderRadius(22)
          .margin({ bottom: 16 })
          .onClick(() => {
            this.logout();
          })
      }
      .width('92%')
      .backgroundColor('#FFFFFF')
      .borderRadius(20)
      .shadow({
        radius: 20,
        color: 'rgba(0,0,0,0.08)',
        offsetX: 0,
        offsetY: 8
      })
      .margin({ bottom: -40 })
    }
    .width('100%')
    .height(260)
    .margin({ bottom: 50 })
  }

  @Builder
  NotLoggedInView() {
    Column() {
      // æ¸å˜èƒŒæ™¯
      Stack({ alignContent: Alignment.Center }) {
        Column()
          .width('100%')
          .height('100%')
          .linearGradient({
            angle: 180,
            colors: [
              ['#667eea', 0],
              ['#764ba2', 0.5],
              ['#F5F7FA', 0.5],
              ['#F5F7FA', 1]
            ]
          })

        Column({ space: 24 }) {
          // å¤´åƒåŒºåŸŸ
          Column() {
            Image($r('app.media.ic_user_avatar'))
              .width(100)
              .height(100)
              .borderRadius(50)
              .border({ width: 4, color: '#FFFFFF' })
              .shadow({
                radius: 20,
                color: 'rgba(0,0,0,0.2)',
                offsetX: 0,
                offsetY: 8
              })
          }
          .width(120)
          .height(120)
          .borderRadius(60)
          .backgroundColor('rgba(255,255,255,0.2)')
          .justifyContent(FlexAlign.Center)

          // æ–‡å­—åŒºåŸŸ
          Column({ space: 8 }) {
            Text('æ¬¢è¿ä½¿ç”¨')
              .fontSize(28)
              .fontWeight(FontWeight.Bold)
              .fontColor('#1A1A1A')

            Text('ç™»å½•åäº«å—æ›´å¤šæœåŠ¡')
              .fontSize(15)
              .fontColor('#666666')
          }

          // ç™»å½•æŒ‰é’®
          Button('ç«‹å³ç™»å½•', { type: ButtonType.Normal, stateEffect: true })
            .width(200)
            .height(50)
            .fontSize(17)
            .fontWeight(FontWeight.Medium)
            .borderRadius(25)
            .linearGradient({
              angle: 90,
              colors: [['#667eea', 0], ['#764ba2', 1]]
            })
            .fontColor('#FFFFFF')
            .shadow({
              radius: 16,
              color: 'rgba(102,126,234,0.4)',
              offsetX: 0,
              offsetY: 6
            })
            .onClick(() => {
              this.navigateToLogin();
            })
        }
        .padding({ top: 80 })
      }
    }
    .width('100%')
    .height('100%')
  }

  // LoginInfoCardå·²ç§»è‡³ProfileHeaderä¸­

  @Builder
  SalesInfoCard() {
    Column({ space: 16 }) {
      // æ ‡é¢˜
      Row() {
        Column()
          .width(4)
          .height(20)
          .borderRadius(2)
          .backgroundColor('#007DFF')
          .margin({ right: 10 })
        Text('é”€å”®æ•°æ®')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1A1A1A')
      }
      .width('100%')

      // é”€å”®ç»Ÿè®¡å¡ç‰‡
      Row({ space: 12 }) {
        // é”€å”®é¢å¡ç‰‡
        Column({ space: 8 }) {
          Row() {
            Column()
              .width(36)
              .height(36)
              .borderRadius(18)
              .linearGradient({
                angle: 135,
                colors: [['#FF9500', 0], ['#FF6B00', 1]]
              })
              .justifyContent(FlexAlign.Center)
          }
          Text('Â¥' + this.salesStats.total_revenue.toFixed(2))
            .fontSize(22)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FF6B00')
          Text('æ€»é”€å”®é¢')
            .fontSize(13)
            .fontColor('#888888')
        }
        .layoutWeight(1)
        .padding(16)
        .backgroundColor('#FFFAF5')
        .borderRadius(16)
        .alignItems(HorizontalAlign.Center)

        // é”€å”®æ•°é‡å¡ç‰‡
        Column({ space: 8 }) {
          Row() {
            Column()
              .width(36)
              .height(36)
              .borderRadius(18)
              .linearGradient({
                angle: 135,
                colors: [['#007DFF', 0], ['#5856D6', 1]]
              })
              .justifyContent(FlexAlign.Center)
          }
          Text(this.salesStats.total_quantity.toString())
            .fontSize(22)
            .fontWeight(FontWeight.Bold)
            .fontColor('#007DFF')
          Text('æ€»é”€å”®æ•°é‡')
            .fontSize(13)
            .fontColor('#888888')
        }
        .layoutWeight(1)
        .padding(16)
        .backgroundColor('#F5F8FF')
        .borderRadius(16)
        .alignItems(HorizontalAlign.Center)
      }
      .width('100%')

      // çƒ­é”€èœå“
      if (this.salesStats.top_dish) {
        Column({ space: 12 }) {
          Row() {
            Text('ğŸ”¥')
              .fontSize(16)
            Text('çƒ­é”€èœå“')
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .fontColor('#666666')
              .margin({ left: 6 })
          }
          .width('100%')

          Row({ space: 14 }) {
            Image(this.getImagePath(this.salesStats.top_dish.image_url))
              .width(70)
              .height(70)
              .borderRadius(14)
              .objectFit(ImageFit.Cover)
              .shadow({
                radius: 8,
                color: 'rgba(0,0,0,0.1)',
                offsetX: 0,
                offsetY: 2
              })

            Column({ space: 6 }) {
              Text(this.salesStats.top_dish.name)
                .fontSize(17)
                .fontWeight(FontWeight.Bold)
                .fontColor('#1A1A1A')

              Row({ space: 6 }) {
                Text('å·²å”®')
                  .fontSize(13)
                  .fontColor('#888888')
                Text(`${this.salesStats.top_dish.total_sold}`)
                  .fontSize(15)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#FF6B00')
                Text('ä»½')
                  .fontSize(13)
                  .fontColor('#888888')
              }
            }
            .alignItems(HorizontalAlign.Start)
            .layoutWeight(1)

            Column() {
              Text('TOP1')
                .fontSize(12)
                .fontWeight(FontWeight.Bold)
                .fontColor('#FFFFFF')
            }
            .padding({ left: 10, right: 10, top: 4, bottom: 4 })
            .borderRadius(12)
            .linearGradient({
              angle: 90,
              colors: [['#FF6B6B', 0], ['#FF8E53', 1]]
            })
          }
          .width('100%')
          .padding(14)
          .backgroundColor('#FAFAFA')
          .borderRadius(14)
        }
      } else {
        Column({ space: 8 }) {
          Text('ğŸ“Š')
            .fontSize(32)
          Text('æš‚æ— é”€å”®æ•°æ®')
            .fontSize(14)
            .fontColor('#999999')
        }
        .width('100%')
        .padding(24)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      }
    }
    .width('100%')
    .padding(20)
    .backgroundColor('#FFFFFF')
    .margin({ top: 12, left: 16, right: 16 })
    .borderRadius(20)
    .shadow({
      radius: 16,
      color: 'rgba(0,0,0,0.05)',
      offsetX: 0,
      offsetY: 4
    })
  }

  @Builder
  MerchantToolsCard() {
    Column({ space: 16 }) {
      // æ ‡é¢˜
      Row() {
        Column()
          .width(4)
          .height(20)
          .borderRadius(2)
          .backgroundColor('#34C759')
          .margin({ right: 10 })
        Text('ç»è¥å·¥å…·')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1A1A1A')
      }
      .width('100%')

      // å·¥å…·åˆ—è¡¨
      Column() {
        this.ToolListItem('æ¡Œå·äºŒç»´ç ', 'ç”Ÿæˆæ¡Œè´´ï¼Œé¡¾å®¢æ‰«ç å³è¿›å…¥ç‚¹é¤', () => {
          this.navigateToTableQRCode();
        })
      }
    }
    .width('100%')
    .padding(20)
    .backgroundColor('#FFFFFF')
    .margin({ top: 12, left: 16, right: 16 })
    .borderRadius(20)
    .shadow({
      radius: 16,
      color: 'rgba(0,0,0,0.05)',
      offsetX: 0,
      offsetY: 4
    })
  }

  @Builder
  ToolListItem(title: string, subtitle: string, action: () => void) {
    Row({ space: 14 }) {
      // å›¾æ ‡èƒŒæ™¯
      Column() {
        Image($r('app.media.qr_code'))
          .width(24)
          .height(24)
          .fillColor('#FFFFFF')
      }
      .width(48)
      .height(48)
      .borderRadius(14)
      .justifyContent(FlexAlign.Center)
      .linearGradient({
        angle: 135,
        colors: [['#34C759', 0], ['#30D158', 1]]
      })

      Column({ space: 4 }) {
        Text(title)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#1A1A1A')
        Text(subtitle)
          .fontSize(13)
          .fontColor('#888888')
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      Image($r('app.media.arrow_right'))
        .width(18)
        .height(18)
        .fillColor('#C7C7CC')
    }
    .width('100%')
    .padding(14)
    .backgroundColor('#F8F9FA')
    .borderRadius(14)
    .onClick(() => action())
  }

  @Builder
  CustomerModeCard() {
    Column({ space: 12 }) {
      Row({ space: 10 }) {
        Column() {
          Text('ğŸ‘¤')
            .fontSize(20)
        }
        .width(40)
        .height(40)
        .borderRadius(20)
        .backgroundColor('rgba(0,125,255,0.1)')
        .justifyContent(FlexAlign.Center)

        Column({ space: 4 }) {
          Text('å½“å‰ä¸ºé¡¾å®¢æ¨¡å¼')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1A1A1A')
          Text('éƒ¨åˆ†å•†å®¶ç»è¥èƒ½åŠ›å·²éšè—')
            .fontSize(13)
            .fontColor('#666666')
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)
      }

      Button('åˆ‡æ¢å›å•†å®¶ç«¯', { type: ButtonType.Normal, stateEffect: true })
        .width('100%')
        .height(42)
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
        .borderRadius(21)
        .backgroundColor('#007DFF')
        .fontColor('#FFFFFF')
        .onClick(() => {
          this.switchToMerchantMode();
        })
    }
    .width('100%')
    .padding(20)
    .linearGradient({
      angle: 135,
      colors: [['#E8F4FF', 0], ['#F0F6FF', 1]]
    })
    .margin({ top: 12, left: 16, right: 16 })
    .borderRadius(20)
    .shadow({
      radius: 12,
      color: 'rgba(0,125,255,0.1)',
      offsetX: 0,
      offsetY: 4
    })
  }

  @Builder
  CustomerTableCard() {
    Column({ space: 14 }) {
      Row({ space: 12 }) {
        Column() {
          Text('ğŸ½ï¸')
            .fontSize(24)
        }
        .width(50)
        .height(50)
        .borderRadius(25)
        .backgroundColor('#FFF5E6')
        .justifyContent(FlexAlign.Center)

        Column({ space: 4 }) {
          Text('é¡¾å®¢æ¡Œå°ä¿¡æ¯')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1A1A1A')
          Text(this.currentTableId ? `æ­£åœ¨ä¸º ${this.currentTableId} æ¡Œç‚¹é¤` : 'æœªç»‘å®šæ¡Œå·')
            .fontSize(14)
            .fontColor(this.currentTableId ? '#34C759' : '#888888')
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)
      }

      if (!this.currentTableId) {
        Button('æ‰«ç è¿›å…¥é¤æ¡Œ', { type: ButtonType.Normal, stateEffect: true })
          .width('100%')
          .height(42)
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .borderRadius(21)
          .backgroundColor('#FF9500')
          .fontColor('#FFFFFF')
          .onClick(() => {
            ToastUtils.showToast('è¯·æ‰«ææ¡Œå·äºŒç»´ç è¿›å…¥é¡¾å®¢ç«¯');
          })
      }
    }
    .width('100%')
    .padding(20)
    .backgroundColor('#FFFFFF')
    .margin({ top: 12, left: 16, right: 16 })
    .borderRadius(20)
    .shadow({
      radius: 16,
      color: 'rgba(0,0,0,0.05)',
      offsetX: 0,
      offsetY: 4
    })
  }

  @Builder
  SettingsSection() {
    Column({ space: 16 }) {
      // ä¸ªäººèµ„æ–™éƒ¨åˆ†
      this.SettingsGroup('ä¸ªäººèµ„æ–™', '#5856D6', this.getProfileSettingsItems())

      // ç¤¾äº¤åŠŸèƒ½éƒ¨åˆ†
      this.SettingsGroup('ç¤¾äº¤åŠŸèƒ½', '#FF9500', this.getSocialSettingsItems())

      // è´¦å·å®‰å…¨éƒ¨åˆ†
      this.SettingsGroup('è´¦å·å®‰å…¨', '#FF3B30', this.getSecuritySettingsItems())
    }
    .width('100%')
    .padding({ left: 16, right: 16, bottom: 20 })
  }

  @Builder
  SettingsGroup(title: string, color: string, items: SettingsItem[]) {
    Column({ space: 12 }) {
      // åˆ†ç»„æ ‡é¢˜
      Row() {
        Column()
          .width(4)
          .height(18)
          .borderRadius(2)
          .backgroundColor(color)
          .margin({ right: 10 })
        Text(title)
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1A1A1A')
      }
      .width('100%')
      .padding({ left: 4 })

      // è®¾ç½®é¡¹åˆ—è¡¨
      Column() {
        ForEach(items, (item: SettingsItem, index: number) => {
          Column() {
            Row({ space: 12 }) {
              Text(item.icon)
                .fontSize(18)

              Text(item.title)
                .fontSize(15)
                .fontColor('#1A1A1A')
                .layoutWeight(1)

              if (item.showAvatar) {
                Image(this.getImagePath(this.userInfo.avatar) || $r('app.media.ic_user_avatar'))
                  .width(36)
                  .height(36)
                  .borderRadius(18)
                  .objectFit(ImageFit.Cover)
              } else {
                Text(item.value)
                  .fontSize(14)
                  .fontColor('#888888')
                  .maxLines(1)
                  .textOverflow({ overflow: TextOverflow.Ellipsis })
                  .constraintSize({ maxWidth: 150 })
              }

              Image($r('app.media.arrow_right'))
                .width(16)
                .height(16)
                .fillColor('#C7C7CC')
            }
            .width('100%')
            .padding({ top: 14, bottom: 14, left: 4, right: 4 })
            .onClick(() => item.action())

            if (index < items.length - 1) {
              Divider()
                .strokeWidth(0.5)
                .color('#F0F0F0')
                .margin({ left: 34 })
            }
          }
        }, (item: SettingsItem, index: number) => `${title}-${index}`)
      }
      .backgroundColor('#FFFFFF')
      .borderRadius(16)
      .padding({ left: 12, right: 12 })
      .shadow({
        radius: 12,
        color: 'rgba(0,0,0,0.04)',
        offsetX: 0,
        offsetY: 2
      })
    }
    .width('100%')
    .margin({ top: 8 })
  }

  @Builder
  EditProfileDialog() {
    Stack({ alignContent: Alignment.Center }) {
      // èƒŒæ™¯é®ç½©
      Column() {
        Blank()
      }
      .width('100%')
      .height('100%')
      .backgroundColor('rgba(0,0,0,0.5)')
      .onClick(() => {
        this.showEditProfile = false;
      })

      // å¯¹è¯æ¡†å†…å®¹
      Column({ space: 20 }) {
        // æ ‡é¢˜
        Row() {
          Text('âœï¸')
            .fontSize(22)
          Text('ç¼–è¾‘ä¸ªäººèµ„æ–™')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1A1A1A')
            .margin({ left: 8 })
        }

        // æ˜µç§°è¾“å…¥
        Column({ space: 8 }) {
          Text('æ˜µç§°')
            .fontSize(14)
            .fontColor('#666666')
            .alignSelf(ItemAlign.Start)
          TextInput({ placeholder: 'è¯·è¾“å…¥æ˜µç§°', text: this.editUsername })
            .width('100%')
            .height(48)
            .borderRadius(12)
            .backgroundColor('#F5F7FA')
            .onChange((value: string) => {
              this.editUsername = value;
            })
        }

        // åœ°å€è¾“å…¥
        Column({ space: 8 }) {
          Text('åœ°å€')
            .fontSize(14)
            .fontColor('#666666')
            .alignSelf(ItemAlign.Start)
          TextInput({ placeholder: 'è¯·è¾“å…¥åœ°å€', text: this.editAddress })
            .width('100%')
            .height(48)
            .borderRadius(12)
            .backgroundColor('#F5F7FA')
            .onChange((value: string) => {
              this.editAddress = value;
            })
        }

        // æŒ‰é’®
        Row({ space: 12 }) {
          Button('å–æ¶ˆ', { type: ButtonType.Normal, stateEffect: true })
            .layoutWeight(1)
            .height(48)
            .backgroundColor('#F5F5F5')
            .fontColor('#666666')
            .fontSize(16)
            .borderRadius(24)
            .onClick(() => {
              this.showEditProfile = false;
            })

          Button('ä¿å­˜', { type: ButtonType.Normal, stateEffect: true })
            .layoutWeight(1)
            .height(48)
            .backgroundColor('#007DFF')
            .fontColor('#FFFFFF')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .borderRadius(24)
            .onClick(() => {
              this.saveProfile();
            })
        }
        .width('100%')
      }
      .width('88%')
      .padding(24)
      .backgroundColor('#FFFFFF')
      .borderRadius(24)
      .shadow({
        radius: 30,
        color: 'rgba(0,0,0,0.15)',
        offsetX: 0,
        offsetY: 10
      })
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  EditPasswordDialog() {
    Stack({ alignContent: Alignment.Center }) {
      // èƒŒæ™¯é®ç½©
      Column() {
        Blank()
      }
      .width('100%')
      .height('100%')
      .backgroundColor('rgba(0,0,0,0.5)')
      .onClick(() => {
        this.showEditPassword = false;
      })

      // å¯¹è¯æ¡†å†…å®¹
      Column({ space: 16 }) {
        // æ ‡é¢˜
        Row() {
          Text('ğŸ”’')
            .fontSize(22)
          Text('ä¿®æ”¹å¯†ç ')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1A1A1A')
            .margin({ left: 8 })
        }

        // åŸå¯†ç 
        Column({ space: 8 }) {
          Text('åŸå¯†ç ')
            .fontSize(14)
            .fontColor('#666666')
            .alignSelf(ItemAlign.Start)
          TextInput({ placeholder: 'è¯·è¾“å…¥åŸå¯†ç ', text: this.oldPassword })
            .type(InputType.Password)
            .width('100%')
            .height(48)
            .borderRadius(12)
            .backgroundColor('#F5F7FA')
            .onChange((value: string) => {
              this.oldPassword = value;
            })
        }

        // æ–°å¯†ç 
        Column({ space: 8 }) {
          Text('æ–°å¯†ç ')
            .fontSize(14)
            .fontColor('#666666')
            .alignSelf(ItemAlign.Start)
          TextInput({ placeholder: 'è¯·è¾“å…¥æ–°å¯†ç ', text: this.newPassword })
            .type(InputType.Password)
            .width('100%')
            .height(48)
            .borderRadius(12)
            .backgroundColor('#F5F7FA')
            .onChange((value: string) => {
              this.newPassword = value;
            })
        }

        // ç¡®è®¤å¯†ç 
        Column({ space: 8 }) {
          Text('ç¡®è®¤å¯†ç ')
            .fontSize(14)
            .fontColor('#666666')
            .alignSelf(ItemAlign.Start)
          TextInput({ placeholder: 'è¯·ç¡®è®¤æ–°å¯†ç ', text: this.confirmPassword })
            .type(InputType.Password)
            .width('100%')
            .height(48)
            .borderRadius(12)
            .backgroundColor('#F5F7FA')
            .onChange((value: string) => {
              this.confirmPassword = value;
            })
        }

        // æŒ‰é’®
        Row({ space: 12 }) {
          Button('å–æ¶ˆ', { type: ButtonType.Normal, stateEffect: true })
            .layoutWeight(1)
            .height(48)
            .backgroundColor('#F5F5F5')
            .fontColor('#666666')
            .fontSize(16)
            .borderRadius(24)
            .onClick(() => {
              this.showEditPassword = false;
            })

          Button('ä¿å­˜', { type: ButtonType.Normal, stateEffect: true })
            .layoutWeight(1)
            .height(48)
            .backgroundColor('#007DFF')
            .fontColor('#FFFFFF')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .borderRadius(24)
            .onClick(() => {
              this.savePassword();
            })
        }
        .width('100%')
        .margin({ top: 8 })
      }
      .width('88%')
      .padding(24)
      .backgroundColor('#FFFFFF')
      .borderRadius(24)
      .shadow({
        radius: 30,
        color: 'rgba(0,0,0,0.15)',
        offsetX: 0,
        offsetY: 10
      })
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  EditEmailDialog() {
    Stack({ alignContent: Alignment.Center }) {
      // èƒŒæ™¯é®ç½©
      Column() {
        Blank()
      }
      .width('100%')
      .height('100%')
      .backgroundColor('rgba(0,0,0,0.5)')
      .onClick(() => {
        this.showEditEmail = false;
      })

      // å¯¹è¯æ¡†å†…å®¹
      Column({ space: 20 }) {
        // æ ‡é¢˜
        Row() {
          Text('ğŸ“§')
            .fontSize(22)
          Text('ä¿®æ”¹é‚®ç®±')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1A1A1A')
            .margin({ left: 8 })
        }

        // é‚®ç®±è¾“å…¥
        Column({ space: 8 }) {
          Text('æ–°é‚®ç®±')
            .fontSize(14)
            .fontColor('#666666')
            .alignSelf(ItemAlign.Start)
          TextInput({ placeholder: 'è¯·è¾“å…¥æ–°é‚®ç®±', text: this.editEmail })
            .width('100%')
            .height(48)
            .borderRadius(12)
            .backgroundColor('#F5F7FA')
            .onChange((value: string) => {
              this.editEmail = value;
            })
        }

        // æŒ‰é’®
        Row({ space: 12 }) {
          Button('å–æ¶ˆ', { type: ButtonType.Normal, stateEffect: true })
            .layoutWeight(1)
            .height(48)
            .backgroundColor('#F5F5F5')
            .fontColor('#666666')
            .fontSize(16)
            .borderRadius(24)
            .onClick(() => {
              this.showEditEmail = false;
            })

          Button('ä¿å­˜', { type: ButtonType.Normal, stateEffect: true })
            .layoutWeight(1)
            .height(48)
            .backgroundColor('#007DFF')
            .fontColor('#FFFFFF')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .borderRadius(24)
            .onClick(() => {
              this.saveEmail();
            })
        }
        .width('100%')
      }
      .width('88%')
      .padding(24)
      .backgroundColor('#FFFFFF')
      .borderRadius(24)
      .shadow({
        radius: 30,
        color: 'rgba(0,0,0,0.15)',
        offsetX: 0,
        offsetY: 10
      })
    }
    .width('100%')
    .height('100%')
  }

  // æ£€æŸ¥ç™»å½•çŠ¶æ€
  checkLoginStatus() {
    try {
      const token = AppStorage.get<string>('userToken') || '';
      const infoStr = AppStorage.get<string>('userInfo') || '';
      this.isLoggedIn = !!token;
      if (infoStr && this.isLoggedIn) {
        const parsed: StoredUserInfo = JSON.parse(infoStr) as StoredUserInfo;
        if (parsed.username !== undefined || parsed.name !== undefined) {
          this.userInfo.username = parsed.username !== undefined ? parsed.username as string
            : (parsed.name as string);
        }
        if (parsed.email !== undefined) {
          this.userInfo.email = parsed.email as string;
        }
        if (parsed.id !== undefined) {
          this.userInfo.id = parsed.id as number;
        }
        if (parsed.avatar !== undefined) {
          this.userInfo.avatar = parsed.avatar as string;
        }
        if (parsed.shopName !== undefined) {
          this.userInfo.shopName = parsed.shopName as string;
        }
        if (parsed.type !== undefined) {
          this.userInfo.type = parsed.type as string;
        }
        if (parsed.address !== undefined) {
          this.userInfo.address = parsed.address as string;
        }
      }
    } catch (e) {
      this.isLoggedIn = false;
    }
  }

  // åŠ è½½ç”¨æˆ·èµ„æ–™
  private navigateToTableQRCode() {
    if (this.isCustomerMode) {
      ToastUtils.showToast('è¯·åœ¨å•†å®¶ç«¯ä½¿ç”¨æ¡Œå·å·¥å…·');
      return;
    }
    RouterUtils.pushUrl('pages/TableQRCodePage');
  }

  private switchToMerchantMode() {
    AppModeManager.setMode(AppMode.MERCHANT, { silent: true });
    ToastUtils.showToast('å·²åˆ‡å›å•†å®¶ç«¯ï¼Œè¯·ç™»å½•ç»§ç»­');
    RouterUtils.replaceUrl('pages/LoginPage');
  }

  async loadUserProfile() {
    try {
      this.isLoading = true;
      const response: ApiResponse = await ApiUtils.get('/Users/Profile');
      if (response.statusCode === 200 && response.data) {
        const data = response.data as Record<string, Object>;
        if (data.username !== undefined) {
          this.userInfo.username = data.username as string;
        }
        if (data.email !== undefined) {
          this.userInfo.email = data.email as string;
        }
        if (data.avatar !== undefined) {
          this.userInfo.avatar = data.avatar as string;
        }
        if (data.address !== undefined) {
          this.userInfo.address = data.address as string;
        }
        // æ›´æ–°æœ¬åœ°å­˜å‚¨
        AppStorage.setOrCreate('userInfo', JSON.stringify({
          username: this.userInfo.username,
          email: this.userInfo.email,
          avatar: this.userInfo.avatar,
          address: this.userInfo.address,
          id: this.userInfo.id
        }));
      }
    } catch (error) {
      console.error('åŠ è½½ç”¨æˆ·èµ„æ–™å¤±è´¥:' + JSON.stringify(error));
    } finally {
      this.isLoading = false;
    }
  }

  // åŠ è½½é”€å”®ç»Ÿè®¡
  async loadSalesStats() {
    try {
      const response: ApiResponse = await ApiUtils.get('/sales/stats');
      if (response.statusCode === 200 && response.data) {
        const data = response.data as Record<string, Object>;
        if (data.total_revenue !== undefined) {
          this.salesStats.total_revenue = Number(data.total_revenue);
        }
        if (data.total_quantity !== undefined) {
          this.salesStats.total_quantity = Number(data.total_quantity);
        }
        if (data.top_dish !== undefined) {
          this.salesStats.top_dish = data.top_dish as TopDish;
        }
      }
    } catch (error) {
      console.error('åŠ è½½é”€å”®ç»Ÿè®¡å¤±è´¥:' + JSON.stringify(error));
    }
  }

  // ä¿®æ”¹å¤´åƒ
  async changeAvatar() {
    const granted = await this.ensureMediaPermissions();
    if (!granted) {
      return;
    }
    try {
      const viewPicker = new picker.PhotoViewPicker();
      const options = new picker.PhotoSelectOptions();
      options.MIMEType = picker.PhotoViewMIMETypes.IMAGE_TYPE;
      options.maxSelectNumber = 1;
      const result = await viewPicker.select(options);
      if (result && result.photoUris && result.photoUris.length > 0) {
        const uri = result.photoUris[0];
        const savedPath = await this.persistAvatarImage(uri);
        if (savedPath) {
          await this.updateAvatar(savedPath);
        }
      }
    } catch (error) {
      console.error('é€‰æ‹©å¤´åƒå¤±è´¥:' + JSON.stringify(error));
      ToastUtils.showToast('é€‰æ‹©å¤´åƒå¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }

  // ä¿å­˜å¤´åƒåˆ°åº”ç”¨ç§æœ‰ç›®å½•
  private async persistAvatarImage(uri: string): Promise<string> {
    if (!this.context) {
      try {
        this.context = getContext(this) as common.UIAbilityContext;
      } catch (error) {
        console.error('è·å–ä¸Šä¸‹æ–‡å¤±è´¥:' + JSON.stringify(error));
        return '';
      }
    }
    if (!this.context) {
      return '';
    }
    try {
      const sourcePath: string = this.resolveFilePath(uri);
      if (!sourcePath) {
        console.error('æ— æ³•è§£æå›¾ç‰‡è·¯å¾„:' + uri);
        return '';
      }
      
      // æ£€æŸ¥æºæ–‡ä»¶æ˜¯å¦å­˜åœ¨
      try {
        fs.accessSync(sourcePath);
      } catch (error) {
        console.error('æºå›¾ç‰‡æ–‡ä»¶ä¸å­˜åœ¨:' + sourcePath);
        return '';
      }
      
      // ç¡®ä¿åº”ç”¨ç§æœ‰ç›®å½•å­˜åœ¨
      const filesDir: string = this.context.filesDir;
      try {
        fs.accessSync(filesDir);
      } catch (error) {
        try {
          fs.mkdirSync(filesDir, true);
        } catch (mkdirError) {
          console.error('åˆ›å»ºfilesDirå¤±è´¥:' + JSON.stringify(mkdirError));
        }
      }
      
      // åˆ›å»ºavatarså­ç›®å½•ç”¨äºå­˜å‚¨å¤´åƒ
      const avatarsDir: string = `${filesDir}/avatars`;
      try {
        fs.accessSync(avatarsDir);
      } catch (error) {
        try {
          fs.mkdirSync(avatarsDir, true);
        } catch (mkdirError) {
          console.error('åˆ›å»ºavatarsDirå¤±è´¥:' + JSON.stringify(mkdirError));
        }
      }
      
      // ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
      const extension: string = this.extractExtension(sourcePath, '.jpg');
      const fileName: string = `avatar_${Date.now()}_${Math.floor(Math.random() * 10000)}${extension}`;
      const targetPath: string = `${avatarsDir}/${fileName}`;
      
      // å¤åˆ¶æ–‡ä»¶åˆ°åº”ç”¨ç§æœ‰ç›®å½•
      fs.copyFileSync(sourcePath, targetPath);
      
      // è¿”å›ç›¸å¯¹è·¯å¾„(ç›¸å¯¹äºfilesDir),è¿™æ ·æ•°æ®åº“åªå­˜å‚¨ç›¸å¯¹è·¯å¾„
      const relativePath: string = `avatars/${fileName}`;
      console.log('å¤´åƒå·²ä¿å­˜åˆ°:' + targetPath + ', ç›¸å¯¹è·¯å¾„:' + relativePath);
      return relativePath;
    } catch (error) {
      console.error('ä¿å­˜å¤´åƒå¤±è´¥:' + JSON.stringify(error));
      ToastUtils.showToast('ä¿å­˜å¤´åƒå¤±è´¥');
      return '';
    }
  }

  // æ›´æ–°å¤´åƒåˆ°æœåŠ¡å™¨
  private async updateAvatar(avatarPath: string) {
    try {
      this.isLoading = true;
      const requestBody: UpdateProfileRequest = {
        avatar: avatarPath
      };
      const response: ApiResponse = await ApiUtils.put('/Users/Profile', requestBody);
      if (response.statusCode === 200 && response.data) {
        const data = response.data as Record<string, Object>;
        if (data.avatar !== undefined) {
          this.userInfo.avatar = data.avatar as string;
        }
        // æ›´æ–°æœ¬åœ°å­˜å‚¨
        const infoStr = AppStorage.get<string>('userInfo') || '{}';
        try {
          const userInfo: StoredUserInfo = JSON.parse(infoStr) as StoredUserInfo;
          userInfo.avatar = this.userInfo.avatar;
          AppStorage.setOrCreate('userInfo', JSON.stringify(userInfo));
        } catch (e) {
          console.error('æ›´æ–°æœ¬åœ°å­˜å‚¨å¤±è´¥:' + JSON.stringify(e));
        }
        ToastUtils.showToast('å¤´åƒæ›´æ–°æˆåŠŸ');
      } else {
        ToastUtils.showToast(response.message || 'å¤´åƒæ›´æ–°å¤±è´¥');
      }
    } catch (error) {
      console.error('æ›´æ–°å¤´åƒå¤±è´¥:' + JSON.stringify(error));
      ToastUtils.showToast('å¤´åƒæ›´æ–°å¤±è´¥');
    } finally {
      this.isLoading = false;
    }
  }

  // ä¿å­˜ä¸ªäººèµ„æ–™
  async saveProfile() {
    if (!this.editUsername.trim() && !this.editAddress.trim()) {
      ToastUtils.showToast('è¯·è‡³å°‘å¡«å†™ä¸€é¡¹');
      return;
    }
    try {
      this.isLoading = true;
      const requestBody: UpdateProfileRequest = {};
      if (this.editUsername.trim()) {
        requestBody.username = this.editUsername.trim();
      }
      if (this.editAddress.trim()) {
        requestBody.address = this.editAddress.trim();
      }
      const response: ApiResponse = await ApiUtils.put('/Users/Profile', requestBody);
      if (response.statusCode === 200 && response.data) {
        const data = response.data as Record<string, Object>;
        if (data.username !== undefined) {
          this.userInfo.username = data.username as string;
        }
        if (data.address !== undefined) {
          this.userInfo.address = data.address as string;
        }
        // æ›´æ–°æœ¬åœ°å­˜å‚¨
        const infoStr = AppStorage.get<string>('userInfo') || '{}';
        try {
          const userInfo: StoredUserInfo = JSON.parse(infoStr) as StoredUserInfo;
          userInfo.username = this.userInfo.username;
          userInfo.address = this.userInfo.address;
          AppStorage.setOrCreate('userInfo', JSON.stringify(userInfo));
        } catch (e) {
          console.error('æ›´æ–°æœ¬åœ°å­˜å‚¨å¤±è´¥:' + JSON.stringify(e));
        }
        ToastUtils.showToast('æ›´æ–°æˆåŠŸ');
        this.showEditProfile = false;
      } else {
        ToastUtils.showToast(response.message || 'æ›´æ–°å¤±è´¥');
      }
    } catch (error) {
      console.error('æ›´æ–°ä¸ªäººèµ„æ–™å¤±è´¥:' + JSON.stringify(error));
      ToastUtils.showToast('æ›´æ–°å¤±è´¥');
    } finally {
      this.isLoading = false;
    }
  }

  // ä¿å­˜å¯†ç 
  async savePassword() {
    if (!this.oldPassword.trim()) {
      ToastUtils.showToast('è¯·è¾“å…¥åŸå¯†ç ');
      return;
    }
    if (!this.newPassword.trim()) {
      ToastUtils.showToast('è¯·è¾“å…¥æ–°å¯†ç ');
      return;
    }
    if (this.newPassword.length < 6) {
      ToastUtils.showToast('å¯†ç é•¿åº¦è‡³å°‘6ä½');
      return;
    }
    if (this.newPassword !== this.confirmPassword) {
      ToastUtils.showToast('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
      return;
    }
    try {
      this.isLoading = true;
      const requestBody: UpdatePasswordRequest = {
        old_password: this.oldPassword,
        new_password: this.newPassword
      };
      const response: ApiResponse = await ApiUtils.put('/Users/Password', requestBody);
      if (response.statusCode === 200) {
        ToastUtils.showToast('å¯†ç ä¿®æ”¹æˆåŠŸ');
        this.showEditPassword = false;
        this.oldPassword = '';
        this.newPassword = '';
        this.confirmPassword = '';
      } else {
        ToastUtils.showToast(response.message || 'å¯†ç ä¿®æ”¹å¤±è´¥');
      }
    } catch (error) {
      console.error('ä¿®æ”¹å¯†ç å¤±è´¥:' + JSON.stringify(error));
      ToastUtils.showToast('å¯†ç ä¿®æ”¹å¤±è´¥');
    } finally {
      this.isLoading = false;
    }
  }

  // ä¿å­˜é‚®ç®±
  async saveEmail() {
    if (!this.editEmail.trim()) {
      ToastUtils.showToast('è¯·è¾“å…¥é‚®ç®±');
      return;
    }
    // ç®€å•çš„é‚®ç®±æ ¼å¼éªŒè¯
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(this.editEmail.trim())) {
      ToastUtils.showToast('é‚®ç®±æ ¼å¼ä¸æ­£ç¡®');
      return;
    }
    try {
      this.isLoading = true;
      const requestBody: UpdateEmailRequest = {
        email: this.editEmail.trim()
      };
      const response: ApiResponse = await ApiUtils.put('/Users/Email', requestBody);
      if (response.statusCode === 200 && response.data) {
        const data = response.data as Record<string, Object>;
        if (data.email !== undefined) {
          this.userInfo.email = data.email as string;
        }
        // æ›´æ–°æœ¬åœ°å­˜å‚¨
        const infoStr = AppStorage.get<string>('userInfo') || '{}';
        try {
          const userInfo: StoredUserInfo = JSON.parse(infoStr) as StoredUserInfo;
          userInfo.email = this.userInfo.email;
          AppStorage.setOrCreate('userInfo', JSON.stringify(userInfo));
        } catch (e) {
          console.error('æ›´æ–°æœ¬åœ°å­˜å‚¨å¤±è´¥:' + JSON.stringify(e));
        }
        ToastUtils.showToast('é‚®ç®±æ›´æ–°æˆåŠŸ');
        this.showEditEmail = false;
      } else {
        ToastUtils.showToast(response.message || 'é‚®ç®±æ›´æ–°å¤±è´¥');
      }
    } catch (error) {
      console.error('æ›´æ–°é‚®ç®±å¤±è´¥:' + JSON.stringify(error));
      ToastUtils.showToast('é‚®ç®±æ›´æ–°å¤±è´¥');
    } finally {
      this.isLoading = false;
    }
  }

  // ç”³è¯·åª’ä½“æƒé™
  private async ensureMediaPermissions(): Promise<boolean> {
    if (this.mediaPermissionsGranted) {
      return true;
    }
    if (!this.atManager || !this.context) {
      ToastUtils.showToast('æ— æ³•è·å–èƒ½åŠ›ä¸Šä¸‹æ–‡');
      return false;
    }
    try {
      const result = await this.atManager.requestPermissionsFromUser(
        this.context,
        this.mediaPermissions
      ) as PermissionRequestResult;
      const granted = result.authResults.every((status: number) => status === 0);
      this.mediaPermissionsGranted = granted;
      if (!granted) {
        ToastUtils.showToast('è¯·æˆäºˆç›¸å†Œä¸ç›¸æœºæƒé™åå†è¯•');
      }
      return granted;
    } catch (error) {
      console.error('ç”³è¯·åª’ä½“æƒé™å¤±è´¥:' + JSON.stringify(error));
      ToastUtils.showToast('æƒé™ç”³è¯·å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      return false;
    }
  }

  // è§£ææ–‡ä»¶è·¯å¾„
  private resolveFilePath(uri: string): string {
    if (!uri) {
      return '';
    }
    if (uri.startsWith('file://')) {
      return uri.replace('file://', '');
    }
    if (uri.startsWith('/')) {
      return uri;
    }
    if (!this.context) {
      return uri;
    }
    return `${this.context.filesDir}/${uri}`;
  }

  // æå–æ–‡ä»¶æ‰©å±•å
  private extractExtension(path: string, defaultExt: string): string {
    const lastDot = path.lastIndexOf('.');
    if (lastDot > 0 && lastDot < path.length - 1) {
      return path.substring(lastDot);
    }
    return defaultExt;
  }

  // è·å–å›¾ç‰‡è·¯å¾„ï¼ˆæ”¯æŒç›¸å¯¹è·¯å¾„å’Œç»å¯¹è·¯å¾„ï¼‰
  private getImagePath(path: string): string {
    if (!path) {
      return '';
    }
    if (path.startsWith('http://') || path.startsWith('https://')) {
      return path;
    }
    if (path.startsWith('/')) {
      return `file://${path}`;
    }
    if (!this.context) {
      try {
        this.context = getContext(this) as common.UIAbilityContext;
      } catch (error) {
        return path;
      }
    }
    if (!this.context) {
      return path;
    }
    const fullPath = `${this.context.filesDir}/${path}`;
    try {
      fs.accessSync(fullPath);
      return `file://${fullPath}`;
    } catch (error) {
      return path;
    }
  }

  // è·³è½¬åˆ°ç™»å½•é¡µé¢
  navigateToLogin() {
    router.pushUrl({
      url: 'pages/LoginPage'
    });
  }

  // é€€å‡ºç™»å½•
  logout(): void {
    AppStorage.setOrCreate('isLoggedIn', false);
    AppStorage.setOrCreate('userToken', '');
    AppStorage.setOrCreate('userInfo', '{}');
    AppStorage.setOrCreate('loginTimestamp', 0); // æ¸…é™¤ç™»å½•æ—¶é—´æˆ³
    this.isLoggedIn = false;
    this.userInfo = new UserInfo();
    this.salesStats = new SalesStats();
    ToastUtils.showToast('å·²é€€å‡ºç™»å½•');
  }

  // è·å–ä¸ªäººèµ„æ–™è®¾ç½®é¡¹
  private getProfileSettingsItems(): SettingsItem[] {
    const items: SettingsItem[] = [];

    const avatarItem: SettingsItem = {
      icon: 'ğŸ“·',
      title: 'å¤´åƒ',
      value: '',
      showAvatar: true,
      action: (): void => { this.changeAvatar(); }
    };
    items.push(avatarItem);

    const nicknameItem: SettingsItem = {
      icon: 'âœï¸',
      title: 'æ˜µç§°',
      value: this.userInfo.username || 'æœªè®¾ç½®',
      showAvatar: false,
      action: (): void => {
        this.editUsername = this.userInfo.username || '';
        this.editAddress = this.userInfo.address || '';
        this.showEditProfile = true;
      }
    };
    items.push(nicknameItem);

    const addressItem: SettingsItem = {
      icon: 'ğŸ“',
      title: 'åœ°å€',
      value: this.userInfo.address || 'æœªè®¾ç½®',
      showAvatar: false,
      action: (): void => {
        this.editUsername = this.userInfo.username || '';
        this.editAddress = this.userInfo.address || '';
        this.showEditProfile = true;
      }
    };
    items.push(addressItem);

    return items;
  }

  // è·å–ç¤¾äº¤åŠŸèƒ½è®¾ç½®é¡¹
  private getSocialSettingsItems(): SettingsItem[] {
    const items: SettingsItem[] = [];

    const followItem: SettingsItem = {
      icon: 'â¤ï¸',
      title: 'æˆ‘çš„å…³æ³¨',
      value: 'æŸ¥çœ‹å…³æ³¨çš„ç”¨æˆ·',
      showAvatar: false,
      action: (): void => {
        router.pushUrl({ url: 'pages/MyFollowsPage' });
      }
    };
    items.push(followItem);

    return items;
  }

  // è·å–è´¦å·å®‰å…¨è®¾ç½®é¡¹
  private getSecuritySettingsItems(): SettingsItem[] {
    const items: SettingsItem[] = [];

    const passwordItem: SettingsItem = {
      icon: 'ğŸ”’',
      title: 'å¯†ç ',
      value: 'ä¿®æ”¹å¯†ç ',
      showAvatar: false,
      action: (): void => {
        this.oldPassword = '';
        this.newPassword = '';
        this.confirmPassword = '';
        this.showEditPassword = true;
      }
    };
    items.push(passwordItem);

    const emailItem: SettingsItem = {
      icon: 'ğŸ“§',
      title: 'é‚®ç®±',
      value: this.userInfo.email || 'æœªè®¾ç½®',
      showAvatar: false,
      action: (): void => {
        this.editEmail = this.userInfo.email || '';
        this.showEditEmail = true;
      }
    };
    items.push(emailItem);

    return items;
  }
}
