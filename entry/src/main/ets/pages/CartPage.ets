// CartPage.ets - åŒæ­¥è´­ç‰©è½¦ç‰ˆæœ¬
import {
  CartItem,
  Dish,
  ApiResponse,
  CartResponse,
  CartItemData,
  AddToCartRequest,
  ClearCartRequest,
  CreateOrderRequest,
  OrderItemData
} from '../common/Types';
import { ApiUtils, ToastUtils, CartSyncManager, LocalCartManager, LocalCartItem } from '../common/Utils';
import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import { iap } from '@kit.IAPKit';
import { common } from '@kit.AbilityKit';
import { BusinessError } from '@kit.BasicServicesKit';

// æ”¯ä»˜æ–¹å¼æšä¸¾
enum PaymentMethod {
  HUAWEI_PAY = 'huawei',
  WECHAT_PAY = 'wechat'
}

// æ”¯ä»˜ç»“æœæ¥å£
interface PaymentResult {
  success: boolean;
  orderId?: string;
  message: string;
}

// åä¸ºæ”¯ä»˜äº§å“ä¿¡æ¯
interface HuaweiProduct {
  productId: string;
  productName: string;
  price: number;
}

// å¾®ä¿¡é¢„æ”¯ä»˜æ•°æ®
interface WechatPrepayData {
  prepayId: string;
  appId: string;
  partnerId: string;
  packageValue: string;
  nonceStr: string;
  timeStamp: string;
  sign: string;
}

// å¾®ä¿¡è®¢å•è¯·æ±‚æ•°æ®
interface WechatOrderRequest {
  orderId: string;
  amount: number;
  description: string;
  items: WechatOrderItem[];
}

interface WechatOrderItem {
  dish_id: number;
  quantity: number;
}

// åä¸ºæ”¯ä»˜è®¢å•é¡¹
interface HuaweiPayloadItem {
  dishId: number;
  name: string;
  quantity: number;
  price: number;
}

// åä¸ºæ”¯ä»˜payload
interface HuaweiPayload {
  orderId: string;
  amount: number;
  items: HuaweiPayloadItem[];
}

// è®¢å•åŒæ­¥è¯·æ±‚
interface OrderSyncRequest {
  items: OrderItemData[];
  orderId: string;
  paymentMethod: string;
  transactionData: string;
  totalAmount: number;
  status: string;
}

// æœåŠ¡å™¨åŸºç¡€åœ°å€ï¼ˆç”¨äºå›¾ç‰‡ï¼‰
const IMAGE_SERVER_URL: string = 'http://10.12.8.110:5000';

@Entry
@Component
export struct CartPage {
  @State cartItems: CartItem[] = [];
  @State totalAmount: number = 0;
  @State isLoading: boolean = true;
  @State showPaymentDialog: boolean = false;
  @State selectedPayment: PaymentMethod = PaymentMethod.HUAWEI_PAY;
  @State isProcessingPayment: boolean = false;
  // ä½¿ç”¨åŒæ­¥çš„è´­ç‰©è½¦æ•°é‡
  @StorageLink('cartItemCount') cartItemCount: number = 0;
  private context: common.UIAbilityContext = getContext(this) as common.UIAbilityContext;

  aboutToAppear() {
    this.loadCartItems();
  }

  private getLocalCartItems(): CartItem[] {
    const items: LocalCartItem[] = LocalCartManager.getItems();
    return items.map((local: LocalCartItem) => {
      const dish = new Dish();
      dish.id = local.id;
      dish.name = local.name;
      dish.price = local.price;
      dish.description = local.description;
      dish.imageUrl = local.imageUrl;
      return {
        dish: dish,
        quantity: local.quantity
      } as CartItem;
    });
  }

  private mergeCartItems(remoteItems: CartItem[], localItems: CartItem[]): CartItem[] {
    const merged: CartItem[] = [];
    for (const item of remoteItems) {
      merged.push(item);
    }
    for (const local of localItems) {
      const index = merged.findIndex(existing => existing.dish.id === local.dish.id);
      if (index !== -1) {
        merged[index].quantity += local.quantity;
      } else {
        merged.push(local);
      }
    }
    return merged;
  }

  private refreshCartSummary() {
    this.calculateTotal();
    const totalQuantity = this.cartItems.reduce((total, item) => total + item.quantity, 0);
    this.cartItemCount = totalQuantity;
    CartSyncManager.updateCartQuantity(totalQuantity);
    CartSyncManager.updateCartTotalAmount(this.totalAmount);
  }

  private updateLocalCartQuantity(item: CartItem, newQuantity: number) {
    const storedItems = LocalCartManager.getItems();
    const targetIndex = storedItems.findIndex(local => local.id === item.dish.id);

    if (newQuantity <= 0) {
      if (targetIndex !== -1) {
        storedItems.splice(targetIndex, 1);
      }
      this.cartItems = this.cartItems.filter(cartItem => cartItem.dish.id !== item.dish.id);
    } else {
      if (targetIndex === -1) {
        const newItem = new LocalCartItem();
        newItem.id = item.dish.id;
        newItem.name = item.dish.name;
        newItem.price = item.dish.price;
        newItem.description = item.dish.description;
        newItem.imageUrl = item.dish.imageUrl;
        newItem.quantity = newQuantity;
        storedItems.push(newItem);
      } else {
        storedItems[targetIndex].quantity = newQuantity;
      }

      const cartIndex = this.cartItems.findIndex(cartItem => cartItem.dish.id === item.dish.id);
      if (cartIndex === -1) {
        this.cartItems.push({
          dish: item.dish,
          quantity: newQuantity
        });
      } else {
        this.cartItems[cartIndex].quantity = newQuantity;
      }
    }

    LocalCartManager.saveItems(storedItems);
    this.refreshCartSummary();
    ToastUtils.showToast(newQuantity <= 0 ? 'å·²åˆ é™¤å•†å“' : 'æ•°é‡å·²æ›´æ–°');
  }

  build() {
    Stack() {
      Column() {
        // é¡¶éƒ¨å¯¼èˆªæ 
        this.TopNavigation()

        if (this.isLoading) {
          this.LoadingView()
        } else if (this.cartItems.length === 0) {
          this.EmptyCartView()
        } else {
          this.EnhancedCartListView()
          this.EnhancedCheckoutBar()
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F8FAFF')

      // æ”¯ä»˜æ–¹å¼é€‰æ‹©å¯¹è¯æ¡†
      if (this.showPaymentDialog) {
        this.PaymentMethodDialog()
      }

      // æ”¯ä»˜å¤„ç†ä¸­é®ç½©
      if (this.isProcessingPayment) {
        this.PaymentProcessingOverlay()
      }
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  TopNavigation() {
    Row() {
      Image($r('app.media.back_icon'))
        .width(24)
        .height(24)
        .margin({ left: 16 })
        .onClick(() => {
          router.back();
        })

      Text('è´­ç‰©è½¦')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1A1A1A')
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      if (this.cartItems.length > 0) {
        Text('æ¸…ç©º')
          .fontSize(14)
          .fontColor('#FF3B30')
          .margin({ right: 16 })
          .onClick(() => {
            this.showClearConfirm();
          })
      } else {
        Text('')
          .width(40)
          .margin({ right: 16 })
      }
    }
    .width('100%')
    .height(56)
    .backgroundColor('#FFFFFF')
    .shadow({
      radius: 4,
      color: '#1A000000',
      offsetX: 0,
      offsetY: 2
    })
    .alignItems(VerticalAlign.Center)
  }

  @Builder
  LoadingView() {
    Column() {
      LoadingProgress()
        .width(50)
        .height(50)
        .color('#007DFF')

      Text('åŠ è½½è´­ç‰©è½¦...')
        .fontSize(14)
        .fontColor('#666666')
        .margin({ top: 16 })
    }
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  @Builder
  EmptyCartView() {
    Column() {
      Image($r('app.media.empty'))
        .width(180)
        .height(180)
        .margin({ bottom: 24 })

      Text('è´­ç‰©è½¦ç©ºç©ºå¦‚ä¹Ÿ')
        .fontSize(18)
        .fontColor('#999999')
        .margin({ bottom: 8 })

      Text('å¿«å»æ·»åŠ å–œæ¬¢çš„èœå“å§')
        .fontSize(14)
        .fontColor('#CCCCCC')
        .margin({ bottom: 32 })

      Button('å»é€›é€›', { type: ButtonType.Normal, stateEffect: true })
        .width(140)
        .height(44)
        .backgroundColor('#007DFF')
        .fontColor('#FFFFFF')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .borderRadius(22)
        .onClick(() => {
          router.back();
        })
    }
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  @Builder
  EnhancedCartListView() {
    Column() {
      // è´­ç‰©è½¦æ ‡é¢˜
      Row() {
        Text('è´­ç‰©è½¦å•†å“')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1A1A1A')
          .layoutWeight(1)

        Text('å…±' + this.cartItems.length + 'ä»¶å•†å“')
          .fontSize(12)
          .fontColor('#666666')
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 12, bottom: 12 })

      // è´­ç‰©è½¦åˆ—è¡¨
      List({ space: 12 }) {
        ForEach(this.cartItems, (item: CartItem) => {
          ListItem() {
            this.EnhancedCartItemCard(item)
          }
        }, (item: CartItem) => item.dish.id.toString())
      }
      .width('100%')
      .padding({ left: 16, right: 16, bottom: 16 })
    }
    .layoutWeight(1)
  }

  @Builder
  EnhancedCartItemCard(item: CartItem) {
    Column() {
      Row() {
        // èœå“å›¾ç‰‡
        Stack() {
          if (item.dish.imageUrl && item.dish.imageUrl.startsWith('app.media.')) {
            Image($r(item.dish.imageUrl))
              .width(80)
              .height(80)
              .borderRadius(12)
              .objectFit(ImageFit.Cover)
          } else if (item.dish.imageUrl) {
            // å¤„ç†æœåŠ¡å™¨å›¾ç‰‡è·¯å¾„
            Image(item.dish.imageUrl.startsWith('/images/') ? `${IMAGE_SERVER_URL}${item.dish.imageUrl}` : item.dish.imageUrl)
              .width(80)
              .height(80)
              .borderRadius(12)
              .objectFit(ImageFit.Cover)
          } else {
            Image($r('app.media.image_gallery'))
              .width(80)
              .height(80)
              .borderRadius(12)
              .objectFit(ImageFit.Cover)
          }
        }
          .shadow({
            radius: 4,
            color: '#1A000000',
            offsetX: 0,
            offsetY: 2
          })

        // èœå“ä¿¡æ¯
        Column() {
          Row() {
            Column() {
              Text(item.dish.name)
                .fontSize(16)
                .fontWeight(FontWeight.Bold)
                .fontColor('#1A1A1A')
                .maxLines(1)
                .textOverflow({ overflow: TextOverflow.Ellipsis })

              Text(item.dish.description)
                .fontSize(12)
                .fontColor('#999999')
                .maxLines(1)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
                .margin({ top: 4 })

              Row() {
                Text('Â¥')
                  .fontSize(14)
                  .fontColor('#FF6B00')
                Text(item.dish.price.toFixed(2))
                  .fontSize(18)
                  .fontColor('#FF6B00')
                  .fontWeight(FontWeight.Bold)
              }
              .margin({ top: 8 })
            }
            .layoutWeight(1)
          }

          // æ•°é‡æ§åˆ¶å’Œåˆ é™¤
          Row() {
            // æ•°é‡æ§åˆ¶
            Row() {
              Image($r('app.media.remove_circle'))
                .width(28)
                .height(28)
                .onClick(() => {
                  this.updateQuantity(item, item.quantity - 1);
                })

              Text(item.quantity.toString())
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .fontColor('#1A1A1A')
                .margin({ left: 16, right: 16 })
                .width(30)
                .textAlign(TextAlign.Center)

              Image($r('app.media.add_circle'))
                .width(28)
                .height(28)
                .onClick(() => {
                  this.updateQuantity(item, item.quantity + 1);
                })
            }
            .alignItems(VerticalAlign.Center)
            .layoutWeight(1)

            // å°è®¡å’Œåˆ é™¤
            Column() {
              Text('å°è®¡: Â¥' + (item.dish.price * item.quantity).toFixed(2))
                .fontSize(13)
                .fontColor('#FF6B00')
                .fontWeight(FontWeight.Medium)

              Text('åˆ é™¤')
                .fontSize(12)
                .fontColor('#FF3B30')
                .margin({ top: 4 })
                .onClick(() => {
                  this.updateQuantity(item, 0);
                })
            }
            .alignItems(HorizontalAlign.End)
          }
          .margin({ top: 8 })
        }
        .margin({ left: 16 })
        .layoutWeight(1)
      }
    }
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderRadius(16)
    .shadow({
      radius: 6,
      color: '#0A000000',
      offsetX: 0,
      offsetY: 2
    })
  }

  @Builder
  EnhancedCheckoutBar() {
    Column() {
      // ä¼˜æƒ ä¿¡æ¯
      Row() {
        Text('ä¼˜æƒ åˆ¸')
          .fontSize(14)
          .fontColor('#666666')
          .layoutWeight(1)

        Text('æš‚æ— å¯ç”¨')
          .fontSize(14)
          .fontColor('#999999')
          .margin({ right: 8 })

        Image($r('app.media.arrow_right'))
          .width(16)
          .height(16)
      }
      .width('100%')
      .padding({ bottom: 12 })

      // æ€»è®¡ä¿¡æ¯
      Row() {
        Column() {
          Text('æ€»è®¡')
            .fontSize(14)
            .fontColor('#666666')
          Text('Â¥' + this.totalAmount.toFixed(2))
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FF6B00')
            .margin({ top: 4 })
        }
        .layoutWeight(1)

        Button('ç«‹å³ç»“ç®—', { type: ButtonType.Normal, stateEffect: true })
          .width(160)
          .height(50)
          .backgroundColor('#007DFF')
          .fontColor('#FFFFFF')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .borderRadius(25)
          .onClick(() => {
            this.showPaymentDialog = true;
          })
      }
      .width('100%')
    }
    .padding(20)
    .backgroundColor('#FFFFFF')
    .borderRadius(20)
    .margin({ left: 16, right: 16, bottom: 16 })
    .shadow({
      radius: 12,
      color: '#1A000000',
      offsetX: 0,
      offsetY: 4
    })
  }

  // æ”¯ä»˜æ–¹å¼é€‰æ‹©å¯¹è¯æ¡†
  @Builder
  PaymentMethodDialog() {
    Stack({ alignContent: Alignment.Bottom }) {
      // é®ç½©å±‚
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0,0,0,0.5)')
        .onClick(() => {
          if (!this.isProcessingPayment) {
            this.showPaymentDialog = false;
          }
        })

      // å¯¹è¯æ¡†å†…å®¹
      Column() {
        // é¡¶éƒ¨æ‹–åŠ¨æ¡
        Column()
          .width(40)
          .height(4)
          .borderRadius(2)
          .backgroundColor('#E0E0E0')
          .margin({ top: 12, bottom: 16 })

        // æ ‡é¢˜
        Row() {
          Text('é€‰æ‹©æ”¯ä»˜æ–¹å¼')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1A1A1A')
        }
        .width('100%')
        .justifyContent(FlexAlign.Center)
        .margin({ bottom: 24 })

        // è®¢å•é‡‘é¢
        Column({ space: 8 }) {
          Text('è®¢å•é‡‘é¢')
            .fontSize(14)
            .fontColor('#888888')
          Text('Â¥' + this.totalAmount.toFixed(2))
            .fontSize(32)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FF6B00')
        }
        .width('100%')
        .alignItems(HorizontalAlign.Center)
        .margin({ bottom: 24 })

        // æ”¯ä»˜æ–¹å¼åˆ—è¡¨
        Column({ space: 12 }) {
          // åä¸ºæ”¯ä»˜
          this.PaymentOptionItem(
            'åä¸ºæ”¯ä»˜',
            'HUAWEI Pay å®‰å…¨å¿«æ·',
            'ğŸ”´',
            PaymentMethod.HUAWEI_PAY,
            '#FF0000'
          )

          // å¾®ä¿¡æ”¯ä»˜
          this.PaymentOptionItem(
            'å¾®ä¿¡æ”¯ä»˜',
            'æ¨èä½¿ç”¨å¾®ä¿¡æ”¯ä»˜',
            'ğŸ’š',
            PaymentMethod.WECHAT_PAY,
            '#07C160'
          )
        }
        .width('100%')
        .padding({ left: 20, right: 20 })

        // ç¡®è®¤æ”¯ä»˜æŒ‰é’®
        Button('ç¡®è®¤æ”¯ä»˜ Â¥' + this.totalAmount.toFixed(2), { type: ButtonType.Normal, stateEffect: true })
          .width('90%')
          .height(52)
          .fontSize(17)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FFFFFF')
          .borderRadius(26)
          .linearGradient({
            angle: 90,
            colors: this.selectedPayment === PaymentMethod.HUAWEI_PAY
              ? [['#FF416C', 0], ['#FF4B2B', 1]]
              : [['#07C160', 0], ['#06AD56', 1]]
          })
          .margin({ top: 32, bottom: 24 })
          .onClick(() => {
            this.processPayment();
          })

        // å®‰å…¨æç¤º
        Row({ space: 6 }) {
          Text('ğŸ”’')
            .fontSize(12)
          Text('æ”¯ä»˜å®‰å…¨ç”±åä¸º/å¾®ä¿¡æä¾›ä¿éšœ')
            .fontSize(12)
            .fontColor('#999999')
        }
        .margin({ bottom: 20 })
      }
      .width('100%')
      .backgroundColor('#FFFFFF')
      .borderRadius({ topLeft: 24, topRight: 24 })
      .shadow({
        radius: 30,
        color: 'rgba(0,0,0,0.15)',
        offsetX: 0,
        offsetY: -10
      })
    }
    .width('100%')
    .height('100%')
  }

  // æ”¯ä»˜é€‰é¡¹ç»„ä»¶
  @Builder
  PaymentOptionItem(name: string, desc: string, emoji: string, method: PaymentMethod, color: string) {
    Row({ space: 14 }) {
      // å›¾æ ‡
      Column() {
        Text(emoji)
          .fontSize(24)
      }
      .width(48)
      .height(48)
      .borderRadius(12)
      .backgroundColor(method === PaymentMethod.HUAWEI_PAY ? '#FFF0F0' : '#E8F5E9')
      .justifyContent(FlexAlign.Center)

      // åç§°å’Œæè¿°
      Column({ space: 4 }) {
        Text(name)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#1A1A1A')
        Text(desc)
          .fontSize(12)
          .fontColor('#888888')
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      // é€‰ä¸­çŠ¶æ€
      if (this.selectedPayment === method) {
        Column() {
          Text('âœ“')
            .fontSize(16)
            .fontColor('#FFFFFF')
            .fontWeight(FontWeight.Bold)
        }
        .width(24)
        .height(24)
        .borderRadius(12)
        .backgroundColor(color)
        .justifyContent(FlexAlign.Center)
      } else {
        Column()
          .width(24)
          .height(24)
          .borderRadius(12)
          .border({ width: 2, color: '#E0E0E0' })
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor(this.selectedPayment === method ? '#F8F9FA' : '#FFFFFF')
    .borderRadius(14)
    .border({
      width: this.selectedPayment === method ? 2 : 1,
      color: this.selectedPayment === method ? color : '#F0F0F0'
    })
    .onClick(() => {
      this.selectedPayment = method;
    })
  }

  // æ”¯ä»˜å¤„ç†ä¸­é®ç½©
  @Builder
  PaymentProcessingOverlay() {
    Column() {
      Column({ space: 16 }) {
        LoadingProgress()
          .width(48)
          .height(48)
          .color('#007DFF')

        Text('æ­£åœ¨å¤„ç†æ”¯ä»˜...')
          .fontSize(16)
          .fontColor('#333333')

        Text('è¯·å‹¿å…³é—­é¡µé¢')
          .fontSize(13)
          .fontColor('#888888')
      }
      .padding(32)
      .backgroundColor('#FFFFFF')
      .borderRadius(20)
      .shadow({
        radius: 20,
        color: 'rgba(0,0,0,0.15)',
        offsetX: 0,
        offsetY: 8
      })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('rgba(0,0,0,0.5)')
    .justifyContent(FlexAlign.Center)
  }

  // æ˜¾ç¤ºæ¸…ç©ºç¡®è®¤
  showClearConfirm() {
    this.clearCart();
  }

  // åŠ è½½è´­ç‰©è½¦å•†å“ - æ›´æ–°åŒæ­¥çŠ¶æ€
  async loadCartItems() {
    this.isLoading = true;
    let remoteItems: CartItem[] = [];

    try {
      const response: ApiResponse = await ApiUtils.get('/cart/items');
      if (response.statusCode === 200 && response.data) {
        const cartData: CartResponse = response.data as CartResponse;
        remoteItems = cartData.items.map((item: CartItemData) => {
          const dish = new Dish();
          dish.id = item.dish_id;
          dish.name = item.name;
          dish.price = item.price;
          dish.description = item.description;
          dish.imageUrl = item.image_url;
          return {
            dish: dish,
            quantity: item.quantity
          } as CartItem;
        });
      }
    } catch (error) {
      console.error('åŠ è½½è´­ç‰©è½¦å¤±è´¥:' + error);
    } finally {
      const localItems = this.getLocalCartItems();
      this.cartItems = this.mergeCartItems(remoteItems, localItems);
      this.refreshCartSummary();
      this.isLoading = false;
    }
  }

  // æ›´æ–°æ•°é‡ - æ›´æ–°åŒæ­¥çŠ¶æ€
  async updateQuantity(item: CartItem, newQuantity: number) {
    if (newQuantity < 0) {
      return;
    }

    if (item.dish.id <= 0) {
      this.updateLocalCartQuantity(item, newQuantity);
      return;
    }

    try {
      await ApiUtils.post('/cart/update', {
        dish_id: item.dish.id,
        quantity: newQuantity
      } as AddToCartRequest);

      // æ›´æ–°æœ¬åœ°çŠ¶æ€
      if (newQuantity === 0) {
        this.cartItems = this.cartItems.filter(i => i.dish.id !== item.dish.id);
      } else {
        const index = this.cartItems.findIndex(i => i.dish.id === item.dish.id);
        if (index !== -1) {
          this.cartItems[index].quantity = newQuantity;
        }
      }

      this.refreshCartSummary();

      ToastUtils.showToast(newQuantity === 0 ? 'å·²åˆ é™¤å•†å“' : 'æ•°é‡å·²æ›´æ–°');
    } catch (error) {
      console.error('æ›´æ–°æ•°é‡å¤±è´¥:' + error);
      ToastUtils.showToast('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }

  // æ¸…ç©ºè´­ç‰©è½¦ - æ›´æ–°åŒæ­¥çŠ¶æ€
  async clearCart() {
    let remoteCleared = false;
    try {
      await ApiUtils.post('/cart/clear', {} as ClearCartRequest);
      remoteCleared = true;
    } catch (error) {
      console.error('æ¸…ç©ºè´­ç‰©è½¦å¤±è´¥:' + error);
    } finally {
      LocalCartManager.clear();
      this.cartItems = [];
      this.refreshCartSummary();
      if (remoteCleared) {
        ToastUtils.showToast('è´­ç‰©è½¦å·²æ¸…ç©º');
      } else {
        ToastUtils.showToast('å·²æ¸…ç©ºæœ¬åœ°è´­ç‰©è½¦');
      }
    }
  }

  // è®¡ç®—æ€»é‡‘é¢
  calculateTotal() {
    this.totalAmount = this.cartItems.reduce((total, item) => {
      return total + (item.dish.price * item.quantity);
    }, 0);
  }

  // å¤„ç†æ”¯ä»˜
  private processPayment(): void {
    if (this.cartItems.length === 0) {
      ToastUtils.showToast('è´­ç‰©è½¦ä¸ºç©º');
      return;
    }

    this.isProcessingPayment = true;
    this.showPaymentDialog = false;

    if (this.selectedPayment === PaymentMethod.HUAWEI_PAY) {
      this.processHuaweiPay();
    } else {
      this.processWechatPay();
    }
  }

  // åä¸ºæ”¯ä»˜å¤„ç†
  private processHuaweiPay(): void {
    // ç”Ÿæˆè®¢å•å·
    const orderId = `ORDER_${Date.now()}_${Math.floor(Math.random() * 10000)}`;

    // æ„å»ºåä¸ºæ”¯ä»˜payload
    const payloadItems: HuaweiPayloadItem[] = [];
    for (const item of this.cartItems) {
      const payloadItem: HuaweiPayloadItem = {
        dishId: item.dish.id,
        name: item.dish.name,
        quantity: item.quantity,
        price: item.dish.price
      };
      payloadItems.push(payloadItem);
    }
    const payload: HuaweiPayload = {
      orderId: orderId,
      amount: this.totalAmount,
      items: payloadItems
    };

    // æ£€æŸ¥IAPæ˜¯å¦å¯ç”¨ï¼ˆæ¨¡æ‹Ÿå™¨ä¸Šå¯èƒ½ä¸å¯ç”¨ï¼‰
    try {
      // åœ¨æ¨¡æ‹Ÿå™¨ä¸Šç›´æ¥ä½¿ç”¨æ¨¡æ‹Ÿæ”¯ä»˜
      let iapAvailable = false;
      try {
        // å°è¯•è®¿é—®ProductTypeï¼Œå¦‚æœå¤±è´¥åˆ™IAPä¸å¯ç”¨
        const testType = iap.ProductType;
        iapAvailable = testType !== undefined && testType !== null;
      } catch (e) {
        iapAvailable = false;
      }

      if (!iapAvailable) {
        console.warn('åä¸ºIAPä¸å¯ç”¨ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ”¯ä»˜');
        this.simulatePaymentSuccess(orderId, PaymentMethod.HUAWEI_PAY);
        return;
      }

      // åˆ›å»ºåä¸ºæ”¯ä»˜è¯·æ±‚
      const createPurchaseParam: iap.PurchaseParameter = {
        productId: `meal_order_${orderId}`,
        productType: iap.ProductType.CONSUMABLE,
        developerPayload: JSON.stringify(payload)
      };

      // è°ƒç”¨åä¸ºIAPæ”¯ä»˜
      iap.createPurchase(this.context, createPurchaseParam)
        .then((result: iap.CreatePurchaseResult) => {
          console.info('åä¸ºæ”¯ä»˜æˆåŠŸ: ' + JSON.stringify(result));
          this.handlePaymentSuccess(orderId, PaymentMethod.HUAWEI_PAY, result.purchaseData);
        })
        .catch((error: BusinessError) => {
          console.error('åä¸ºæ”¯ä»˜å¤±è´¥: ' + JSON.stringify(error));
          this.handlePaymentError(error, PaymentMethod.HUAWEI_PAY);
        });
    } catch (error) {
      console.error('åä¸ºæ”¯ä»˜åˆå§‹åŒ–å¤±è´¥: ' + JSON.stringify(error));
      // åœ¨æ¨¡æ‹Ÿå™¨æˆ–IAPä¸å¯ç”¨æ—¶ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ”¯ä»˜
      this.simulatePaymentSuccess(orderId, PaymentMethod.HUAWEI_PAY);
    }
  }

  // æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸï¼ˆç”¨äºæ¨¡æ‹Ÿå™¨æµ‹è¯•ï¼‰
  private simulatePaymentSuccess(orderId: string, method: PaymentMethod): void {
    console.info('æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸï¼Œè®¢å•å·: ' + orderId);
    // æ¨¡æ‹Ÿæ”¯ä»˜å»¶è¿Ÿ
    setTimeout(() => {
      this.handlePaymentSuccess(orderId, method, 'simulated_purchase_data');
    }, 1000);
  }

  // å¾®ä¿¡æ”¯ä»˜å¤„ç†
  private processWechatPay(): void {
    // ç”Ÿæˆè®¢å•å·
    const orderId = `ORDER_${Date.now()}_${Math.floor(Math.random() * 10000)}`;

    // è°ƒç”¨åç«¯åˆ›å»ºå¾®ä¿¡é¢„æ”¯ä»˜è®¢å•
    this.createWechatOrder(orderId)
      .then((prepayData: WechatPrepayData | null) => {
        if (prepayData) {
          // è°ƒç”¨å¾®ä¿¡æ”¯ä»˜SDK (éœ€è¦é›†æˆå¾®ä¿¡SDK)
          this.invokeWechatPay(prepayData, orderId);
        } else {
          this.handlePaymentError({ code: -1, message: 'åˆ›å»ºé¢„æ”¯ä»˜è®¢å•å¤±è´¥' } as BusinessError, PaymentMethod.WECHAT_PAY);
        }
      })
      .catch((error: Error) => {
        console.error('å¾®ä¿¡æ”¯ä»˜å¤±è´¥: ' + error.message);
        this.handlePaymentError({ code: -1, message: error.message } as BusinessError, PaymentMethod.WECHAT_PAY);
      });
  }

  // åˆ›å»ºå¾®ä¿¡é¢„æ”¯ä»˜è®¢å•
  private async createWechatOrder(orderId: string): Promise<WechatPrepayData | null> {
    try {
      // æ„å»ºè®¢å•é¡¹
      const orderItems: WechatOrderItem[] = [];
      for (const item of this.cartItems) {
        const orderItem: WechatOrderItem = {
          dish_id: item.dish.id,
          quantity: item.quantity
        };
        orderItems.push(orderItem);
      }

      // æ„å»ºè¯·æ±‚æ•°æ®
      const requestData: WechatOrderRequest = {
        orderId: orderId,
        amount: Math.round(this.totalAmount * 100),
        description: `é¤é¥®è®¢å•-${this.cartItems.length}ä»¶å•†å“`,
        items: orderItems
      };

      const response: ApiResponse = await ApiUtils.post('/payment/wechat/create', requestData);

      if (response.statusCode === 200 && response.data) {
        return response.data as WechatPrepayData;
      }
      return null;
    } catch (error) {
      console.error('åˆ›å»ºå¾®ä¿¡è®¢å•å¤±è´¥: ' + JSON.stringify(error));
      return null;
    }
  }

  // è°ƒç”¨å¾®ä¿¡æ”¯ä»˜
  private invokeWechatPay(prepayData: WechatPrepayData, orderId: string): void {
    // æ³¨æ„ï¼šå®é™…å¾®ä¿¡æ”¯ä»˜éœ€è¦é›†æˆå¾®ä¿¡OpenSDK
    // è¿™é‡Œæ¨¡æ‹Ÿæ”¯ä»˜æµç¨‹ï¼Œå®é™…éœ€è¦è°ƒç”¨å¾®ä¿¡SDK
    console.info('è°ƒç”¨å¾®ä¿¡æ”¯ä»˜: ' + JSON.stringify(prepayData));

    // æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸï¼ˆå®é™…åº”ç”¨ä¸­éœ€è¦æ›¿æ¢ä¸ºçœŸå®çš„å¾®ä¿¡SDKè°ƒç”¨ï¼‰
    // å¾®ä¿¡SDKè°ƒç”¨ç¤ºä¾‹ï¼š
    // WXApi.sendReq(payReq) ç„¶ååœ¨å›è°ƒä¸­å¤„ç†ç»“æœ

    // æš‚æ—¶æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸ
    setTimeout(() => {
      // æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸ
      this.handlePaymentSuccess(orderId, PaymentMethod.WECHAT_PAY, prepayData.prepayId);
    }, 2000);
  }

  // æ”¯ä»˜æˆåŠŸå¤„ç†
  private handlePaymentSuccess(orderId: string, method: PaymentMethod, transactionData: string): void {
    this.isProcessingPayment = false;

    // åŒæ­¥è®¢å•åˆ°æœåŠ¡å™¨
    this.syncOrderToServer(orderId, method, transactionData)
      .then(() => {
        // æ¸…ç©ºè´­ç‰©è½¦
        this.clearCart();

        // æ˜¾ç¤ºæˆåŠŸæç¤º
        promptAction.showDialog({
          title: 'æ”¯ä»˜æˆåŠŸ',
          message: `è®¢å•å·: ${orderId}\næ”¯ä»˜é‡‘é¢: Â¥${this.totalAmount.toFixed(2)}\næ”¯ä»˜æ–¹å¼: ${method === PaymentMethod.HUAWEI_PAY ? 'åä¸ºæ”¯ä»˜' : 'å¾®ä¿¡æ”¯ä»˜'}`,
          buttons: [{ text: 'ç¡®å®š', color: '#007DFF' }]
        }).then(() => {
          router.back();
        });
      })
      .catch((error: Error) => {
        console.error('åŒæ­¥è®¢å•å¤±è´¥: ' + error.message);
        ToastUtils.showToast('è®¢å•å·²æ”¯ä»˜ï¼ŒåŒæ­¥ä¸­...');
        router.back();
      });
  }

  // æ”¯ä»˜å¤±è´¥å¤„ç†
  private handlePaymentError(error: BusinessError, method: PaymentMethod): void {
    this.isProcessingPayment = false;

    let errorMessage = 'æ”¯ä»˜å¤±è´¥';

    // åä¸ºæ”¯ä»˜é”™è¯¯ç å¤„ç†
    if (method === PaymentMethod.HUAWEI_PAY) {
      switch (error.code) {
        case 60001:
          errorMessage = 'ç”¨æˆ·å–æ¶ˆæ”¯ä»˜';
          break;
        case 60002:
          errorMessage = 'ç½‘ç»œå¼‚å¸¸ï¼Œè¯·é‡è¯•';
          break;
        case 60003:
          errorMessage = 'å•†å“ä¸å­˜åœ¨';
          break;
        case 60004:
          errorMessage = 'å•†å“å·²æ‹¥æœ‰';
          break;
        case 60005:
          errorMessage = 'å•†å“ä¸å¯è´­ä¹°';
          break;
        case 60050:
          errorMessage = 'åä¸ºè´¦å·æœªç™»å½•';
          break;
        default:
          errorMessage = `æ”¯ä»˜å¤±è´¥(${error.code}): ${error.message}`;
      }
    } else {
      // å¾®ä¿¡æ”¯ä»˜é”™è¯¯å¤„ç†
      if (error.code === -2) {
        errorMessage = 'ç”¨æˆ·å–æ¶ˆæ”¯ä»˜';
      } else {
        errorMessage = error.message || 'å¾®ä¿¡æ”¯ä»˜å¤±è´¥';
      }
    }

    ToastUtils.showToast(errorMessage);
  }

  // åŒæ­¥è®¢å•åˆ°æœåŠ¡å™¨
  private async syncOrderToServer(orderId: string, method: PaymentMethod, transactionData: string): Promise<void> {
    // å…ˆåŒæ­¥æœ¬åœ°è´­ç‰©è½¦
    await this.syncLocalCartToServer();

    // æ„å»ºè®¢å•é¡¹
    const orderItems: OrderItemData[] = [];
    for (const item of this.cartItems) {
      const orderItem: OrderItemData = {
        dish_id: item.dish.id,
        quantity: item.quantity
      };
      orderItems.push(orderItem);
    }

    // æ„å»ºåŒæ­¥è¯·æ±‚
    const syncRequest: OrderSyncRequest = {
      items: orderItems,
      orderId: orderId,
      paymentMethod: method,
      transactionData: transactionData,
      totalAmount: this.totalAmount,
      status: 'paid'
    };

    const response: ApiResponse = await ApiUtils.post('/orders/create', syncRequest);

    if (response.statusCode !== 200) {
      throw new Error(response.message || 'è®¢å•åŒæ­¥å¤±è´¥');
    }
  }

  // æ—§çš„ç»“ç®—æ–¹æ³•ï¼ˆä¿ç•™å…¼å®¹ï¼‰
  async checkout() {
    this.showPaymentDialog = true;
  }

  // åŒæ­¥æœ¬åœ°è´­ç‰©è½¦åˆ°æœåŠ¡å™¨
  private async syncLocalCartToServer(): Promise<void> {
    const localItems: LocalCartItem[] = LocalCartManager.getItems();
    if (localItems.length === 0) {
      return;
    }

    try {
      for (const item of localItems) {
        if (item.id > 0) {
          await ApiUtils.post('/cart/add', {
            dish_id: item.id,
            quantity: item.quantity
          } as AddToCartRequest);
        }
      }
      // åŒæ­¥æˆåŠŸåæ¸…ç©ºæœ¬åœ°è´­ç‰©è½¦
      LocalCartManager.clear();
    } catch (error) {
      console.error('åŒæ­¥æœ¬åœ°è´­ç‰©è½¦å¤±è´¥:' + error);
      // åŒæ­¥å¤±è´¥ä¸é˜»æ­¢ç»“ç®—ï¼Œç»§ç»­å°è¯•
    }
  }
}